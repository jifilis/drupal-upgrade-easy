diff -Naur drupal-6.21/CHANGELOG.txt drupal-6.37/CHANGELOG.txt
--- drupal-6.21/CHANGELOG.txt	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/CHANGELOG.txt	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,78 @@
 
+Drupal 6.37, 2015-08-19
+-----------------------
+- Fixed security issues (multiple vulnerabilities). See SA-CORE-2015-003.
+
+Drupal 6.36, 2015-06-17
+-----------------------
+- Fixed security issues (OpenID impersonation). See SA-CORE-2015-002.
+
+Drupal 6.35, 2015-03-18
+----------------------
+- Fixed security issues (multiple vulnerabilities). See SA-CORE-2015-001.
+
+Drupal 6.34, 2014-11-19
+----------------------
+- Fixed security issues (session hijacking). See SA-CORE-2014-006.
+
+Drupal 6.33, 2014-08-06
+----------------------
+- Fixed security issues (denial of service). See SA-CORE-2014-004.
+
+Drupal 6.32, 2014-07-16
+----------------------
+- Fixed security issues (multiple vulnerabilities). See SA-CORE-2014-003.
+
+Drupal 6.31, 2014-04-16
+----------------------
+- Fixed security issues (information disclosure). See SA-CORE-2014-002.
+
+Drupal 6.30, 2014-01-15
+----------------------
+- Fixed security issues (multiple vulnerabilities), see SA-CORE-2014-001.
+
+Drupal 6.29, 2013-11-20
+----------------------
+- Fixed security issues (multiple vulnerabilities), see SA-CORE-2013-003.
+
+Drupal 6.28, 2013-01-16
+----------------------
+- Fixed security issues (multiple vulnerabilities), see SA-CORE-2013-001.
+
+Drupal 6.27, 2012-12-19
+----------------------
+- Fixed security issues (multiple vulnerabilities), see SA-CORE-2012-004.
+
+Drupal 6.26, 2012-05-02
+----------------------
+- Fixed a small number of bugs.
+- Made code documentation improvements.
+
+Drupal 6.25, 2012-02-29
+----------------------
+- Fixed regressions introduced in Drupal 6.24 only.
+
+Drupal 6.24, 2012-02-01
+----------------------
+- Improved performance of search indexing and user operations by adding indexes.
+- Fixed issues with themes getting disabled due to missing locking in
+  system_theme_data().
+- Fix issue with blocks being disabled on updates in _block_rehash().
+- Further improvements to PHP 5.3, PHP 4 and PostgreSQL compatibility.
+- Improved code documentation at various places.
+- Fixed a variety of other bugs.
+
+Drupal 6.23, 2012-02-01
+----------------------
+- Fixed security issues (Cross site scripting), see SA-CORE-2012-001.
+
+Drupal 6.22, 2011-05-25
+----------------------
+- Made Drupal 6 work better with IIS and Internet Explorer.
+- Fixed .po file imports to work better with custom textgroups.
+- Improved code documentation at various places.
+- Fixed a variety of other bugs.
+
 Drupal 6.21, 2011-05-25
 ----------------------
 - Fixed security issues (Cross site scripting), see SA-CORE-2011-001.
diff -Naur drupal-6.21/COPYRIGHT.txt drupal-6.37/COPYRIGHT.txt
--- drupal-6.21/COPYRIGHT.txt	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/COPYRIGHT.txt	2015-08-19 23:15:49.000000000 +0200
@@ -1,6 +1,4 @@
-// $Id$
-
-All Drupal code is Copyright 2001 - 2010 by the original authors.
+All Drupal code is Copyright 2001 - 2012 by the original authors.
 
 This program is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
@@ -21,5 +19,11 @@
 according to the terms of the GNU General Public License or a compatible
 license, including:
 
-  jQuery - Copyright (c) 2008 - 2009 John Resig
+Javascript
+
+  Farbtastic - Copyright (c) 2007 Matt Farina
+
+  jQuery - Copyright (c) 2008 John Resig
+
+  jQuery Form - Copyright (c) 2007 Mike Alsup
 
diff -Naur drupal-6.21/INSTALL.mysql.txt drupal-6.37/INSTALL.mysql.txt
--- drupal-6.21/INSTALL.mysql.txt	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/INSTALL.mysql.txt	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 CREATE THE MySQL DATABASE
 --------------------------
@@ -21,8 +20,8 @@
 Again, you will be asked for the 'username' database password. At the MySQL
 prompt, enter following command:
 
-  GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER
-  ON databasename.*
+  GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER,
+  CREATE TEMPORARY TABLES ON databasename.*
   TO 'username'@'localhost' IDENTIFIED BY 'password';
 
 where
diff -Naur drupal-6.21/INSTALL.pgsql.txt drupal-6.37/INSTALL.pgsql.txt
--- drupal-6.21/INSTALL.pgsql.txt	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/INSTALL.pgsql.txt	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 CREATE THE PostgreSQL DATABASE
 ------------------------------
diff -Naur drupal-6.21/INSTALL.txt drupal-6.37/INSTALL.txt
--- drupal-6.21/INSTALL.txt	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/INSTALL.txt	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 CONTENTS OF THIS FILE
 ---------------------
diff -Naur drupal-6.21/LICENSE.txt drupal-6.37/LICENSE.txt
--- drupal-6.21/LICENSE.txt	2011-02-24 01:47:51.000000000 +0100
+++ drupal-6.37/LICENSE.txt	2014-09-23 21:24:50.000000000 +0200
@@ -1,274 +1,339 @@
-GNU GENERAL PUBLIC LICENSE
+                    GNU GENERAL PUBLIC LICENSE
+                       Version 2, June 1991
 
-              Version 2, June 1991
-
-Copyright (C) 1989, 1991 Free Software Foundation, Inc. 675 Mass Ave,
-Cambridge, MA 02139, USA. Everyone is permitted to copy and distribute
-verbatim copies of this license document, but changing it is not allowed.
-
-                  Preamble
-
-The licenses for most software are designed to take away your freedom to
-share and change it. By contrast, the GNU General Public License is
-intended to guarantee your freedom to share and change free software--to
-make sure the software is free for all its users. This General Public License
-applies to most of the Free Software Foundation's software and to any other
-program whose authors commit to using it. (Some other Free Software
-Foundation software is covered by the GNU Library General Public License
-instead.) You can apply it to your programs, too.
-
-When we speak of free software, we are referring to freedom, not price. Our
-General Public Licenses are designed to make sure that you have the
-freedom to distribute copies of free software (and charge for this service if
-you wish), that you receive source code or can get it if you want it, that you
-can change the software or use pieces of it in new free programs; and that
-you know you can do these things.
-
-To protect your rights, we need to make restrictions that forbid anyone to
-deny you these rights or to ask you to surrender the rights. These restrictions
-translate to certain responsibilities for you if you distribute copies of the
-software, or if you modify it.
-
-For example, if you distribute copies of such a program, whether gratis or for
-a fee, you must give the recipients all the rights that you have. You must make
-sure that they, too, receive or can get the source code. And you must show
-them these terms so they know their rights.
-
-We protect your rights with two steps: (1) copyright the software, and (2)
-offer you this license which gives you legal permission to copy, distribute
-and/or modify the software.
-
-Also, for each author's protection and ours, we want to make certain that
-everyone understands that there is no warranty for this free software. If the
-software is modified by someone else and passed on, we want its recipients
-to know that what they have is not the original, so that any problems
-introduced by others will not reflect on the original authors' reputations.
-
-Finally, any free program is threatened constantly by software patents. We
-wish to avoid the danger that redistributors of a free program will individually
-obtain patent licenses, in effect making the program proprietary. To prevent
-this, we have made it clear that any patent must be licensed for everyone's
-free use or not licensed at all.
-
-The precise terms and conditions for copying, distribution and modification
-follow.
-
-           GNU GENERAL PUBLIC LICENSE
- TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND
-               MODIFICATION
-
-0. This License applies to any program or other work which contains a notice
-placed by the copyright holder saying it may be distributed under the terms
-of this General Public License. The "Program", below, refers to any such
-program or work, and a "work based on the Program" means either the
-Program or any derivative work under copyright law: that is to say, a work
-containing the Program or a portion of it, either verbatim or with
-modifications and/or translated into another language. (Hereinafter, translation
-is included without limitation in the term "modification".) Each licensee is
-addressed as "you".
-
-Activities other than copying, distribution and modification are not covered
-by this License; they are outside its scope. The act of running the Program is
-not restricted, and the output from the Program is covered only if its contents
-constitute a work based on the Program (independent of having been made
-by running the Program). Whether that is true depends on what the Program
-does.
-
-1. You may copy and distribute verbatim copies of the Program's source
-code as you receive it, in any medium, provided that you conspicuously and
-appropriately publish on each copy an appropriate copyright notice and
-disclaimer of warranty; keep intact all the notices that refer to this License
-and to the absence of any warranty; and give any other recipients of the
-Program a copy of this License along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and you
-may at your option offer warranty protection in exchange for a fee.
-
-2. You may modify your copy or copies of the Program or any portion of it,
-thus forming a work based on the Program, and copy and distribute such
-modifications or work under the terms of Section 1 above, provided that you
-also meet all of these conditions:
-
-a) You must cause the modified files to carry prominent notices stating that
-you changed the files and the date of any change.
-
-b) You must cause any work that you distribute or publish, that in whole or in
-part contains or is derived from the Program or any part thereof, to be
-licensed as a whole at no charge to all third parties under the terms of this
-License.
-
-c) If the modified program normally reads commands interactively when run,
-you must cause it, when started running for such interactive use in the most
-ordinary way, to print or display an announcement including an appropriate
-copyright notice and a notice that there is no warranty (or else, saying that
-you provide a warranty) and that users may redistribute the program under
-these conditions, and telling the user how to view a copy of this License.
-(Exception: if the Program itself is interactive but does not normally print such
-an announcement, your work based on the Program is not required to print
-an announcement.)
-
-These requirements apply to the modified work as a whole. If identifiable
-sections of that work are not derived from the Program, and can be
-reasonably considered independent and separate works in themselves, then
-this License, and its terms, do not apply to those sections when you distribute
-them as separate works. But when you distribute the same sections as part
-of a whole which is a work based on the Program, the distribution of the
-whole must be on the terms of this License, whose permissions for other
-licensees extend to the entire whole, and thus to each and every part
-regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest your rights to
-work written entirely by you; rather, the intent is to exercise the right to
-control the distribution of derivative or collective works based on the
-Program.
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc.,
+ 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Lesser General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The "Program", below,
+refers to any such program or work, and a "work based on the Program"
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term "modification".)  Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
 
 In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of a
-storage or distribution medium does not bring the other work under the scope
-of this License.
-
-3. You may copy and distribute the Program (or a work based on it, under
-Section 2) in object code or executable form under the terms of Sections 1
-and 2 above provided that you also do one of the following:
-
-a) Accompany it with the complete corresponding machine-readable source
-code, which must be distributed under the terms of Sections 1 and 2 above
-on a medium customarily used for software interchange; or,
-
-b) Accompany it with a written offer, valid for at least three years, to give
-any third party, for a charge no more than your cost of physically performing
-source distribution, a complete machine-readable copy of the corresponding
-source code, to be distributed under the terms of Sections 1 and 2 above on
-a medium customarily used for software interchange; or,
-
-c) Accompany it with the information you received as to the offer to distribute
-corresponding source code. (This alternative is allowed only for
-noncommercial distribution and only if you received the program in object
-code or executable form with such an offer, in accord with Subsection b
-above.)
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
 
 The source code for a work means the preferred form of the work for
-making modifications to it. For an executable work, complete source code
-means all the source code for all modules it contains, plus any associated
-interface definition files, plus the scripts used to control compilation and
-installation of the executable. However, as a special exception, the source
-code distributed need not include anything that is normally distributed (in
-either source or binary form) with the major components (compiler, kernel,
-and so on) of the operating system on which the executable runs, unless that
-component itself accompanies the executable.
-
-If distribution of executable or object code is made by offering access to
-copy from a designated place, then offering equivalent access to copy the
-source code from the same place counts as distribution of the source code,
-even though third parties are not compelled to copy the source along with the
-object code.
-
-4. You may not copy, modify, sublicense, or distribute the Program except as
-expressly provided under this License. Any attempt otherwise to copy,
-modify, sublicense or distribute the Program is void, and will automatically
-terminate your rights under this License. However, parties who have received
-copies, or rights, from you under this License will not have their licenses
-terminated so long as such parties remain in full compliance.
-
-5. You are not required to accept this License, since you have not signed it.
-However, nothing else grants you permission to modify or distribute the
-Program or its derivative works. These actions are prohibited by law if you
-do not accept this License. Therefore, by modifying or distributing the
-Program (or any work based on the Program), you indicate your acceptance
-of this License to do so, and all its terms and conditions for copying,
-distributing or modifying the Program or works based on it.
-
-6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the original
-licensor to copy, distribute or modify the Program subject to these terms and
-conditions. You may not impose any further restrictions on the recipients'
-exercise of the rights granted herein. You are not responsible for enforcing
-compliance by third parties to this License.
-
-7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues), conditions
-are imposed on you (whether by court order, agreement or otherwise) that
-contradict the conditions of this License, they do not excuse you from the
-conditions of this License. If you cannot distribute so as to satisfy
-simultaneously your obligations under this License and any other pertinent
-obligations, then as a consequence you may not distribute the Program at all.
-For example, if a patent license would not permit royalty-free redistribution
-of the Program by all those who receive copies directly or indirectly through
-you, then the only way you could satisfy both it and this License would be to
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
 refrain entirely from distribution of the Program.
 
-If any portion of this section is held invalid or unenforceable under any
-particular circumstance, the balance of the section is intended to apply and
-the section as a whole is intended to apply in other circumstances.
-
-It is not the purpose of this section to induce you to infringe any patents or
-other property right claims or to contest validity of any such claims; this
-section has the sole purpose of protecting the integrity of the free software
-distribution system, which is implemented by public license practices. Many
-people have made generous contributions to the wide range of software
-distributed through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing to
-distribute software through any other system and a licensee cannot impose
-that choice.
-
-This section is intended to make thoroughly clear what is believed to be a
-consequence of the rest of this License.
-
-8. If the distribution and/or use of the Program is restricted in certain
-countries either by patents or by copyrighted interfaces, the original copyright
-holder who places the Program under this License may add an explicit
-geographical distribution limitation excluding those countries, so that
-distribution is permitted only in or among countries not thus excluded. In such
-case, this License incorporates the limitation as if written in the body of this
-License.
-
-9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time. Such new versions will be
-similar in spirit to the present version, but may differ in detail to address new
-problems or concerns.
-
-Each version is given a distinguishing version number. If the Program specifies
-a version number of this License which applies to it and "any later version",
-you have the option of following the terms and conditions either of that
-version or of any later version published by the Free Software Foundation. If
-the Program does not specify a version number of this License, you may
-choose any version ever published by the Free Software Foundation.
-
-10. If you wish to incorporate parts of the Program into other free programs
-whose distribution conditions are different, write to the author to ask for
-permission. For software which is copyrighted by the Free Software
-Foundation, write to the Free Software Foundation; we sometimes make
-exceptions for this. Our decision will be guided by the two goals of
-preserving the free status of all derivatives of our free software and of
-promoting the sharing and reuse of software generally.
-
-               NO WARRANTY
-
-11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE,
-THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT
-PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE
-STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR
-OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT
-WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED,
-INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
-OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
-PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND
-PERFORMANCE OF THE PROGRAM IS WITH YOU. SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL
-NECESSARY SERVICING, REPAIR OR CORRECTION.
-
-12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR
-AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR
-ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE
-LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL,
-SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES
-ARISING OUT OF THE USE OR INABILITY TO USE THE
-PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF DATA
-OR DATA BEING RENDERED INACCURATE OR LOSSES
-SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE
-PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS), EVEN
-IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF
-THE POSSIBILITY OF SUCH DAMAGES.
-
-          END OF TERMS AND CONDITIONS
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and "any
+later version", you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+                            NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.
+
+                     END OF TERMS AND CONDITIONS
+
+            How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+convey the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    <one line to give the program's name and a brief idea of what it does.>
+    Copyright (C) <year>  <name of author>
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License along
+    with this program; if not, write to the Free Software Foundation, Inc.,
+    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
+
+Also add information on how to contact you by electronic and paper mail.
+
+If the program is interactive, make it output a short notice like this
+when it starts in an interactive mode:
+
+    Gnomovision version 69, Copyright (C) year name of author
+    Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
+    This is free software, and you are welcome to redistribute it
+    under certain conditions; type `show c' for details.
+
+The hypothetical commands `show w' and `show c' should show the appropriate
+parts of the General Public License.  Of course, the commands you use may
+be called something other than `show w' and `show c'; they could even be
+mouse-clicks or menu items--whatever suits your program.
+
+You should also get your employer (if you work as a programmer) or your
+school, if any, to sign a "copyright disclaimer" for the program, if
+necessary.  Here is a sample; alter the names:
+
+  Yoyodyne, Inc., hereby disclaims all copyright interest in the program
+  `Gnomovision' (which makes passes at compilers) written by James Hacker.
+
+  <signature of Ty Coon>, 1 April 1989
+  Ty Coon, President of Vice
+
+This General Public License does not permit incorporating your program into
+proprietary programs.  If your program is a subroutine library, you may
+consider it more useful to permit linking proprietary applications with the
+library.  If this is what you want to do, use the GNU Lesser General
+Public License instead of this License.
diff -Naur drupal-6.21/MAINTAINERS.txt drupal-6.37/MAINTAINERS.txt
--- drupal-6.21/MAINTAINERS.txt	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/MAINTAINERS.txt	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 List of maintainers
 --------------------------------------------------------------------------------
@@ -58,7 +57,7 @@
 S: maintained
 
 SECURITY COORDINATOR
-M: Heine Deelstra <hdeelstra@gmail.com>
+M: Greg Knaddison <http://drupal.org/user/36762>
 S: maintained
 
 STATISTICS MODULE
diff -Naur drupal-6.21/UPGRADE.txt drupal-6.37/UPGRADE.txt
--- drupal-6.21/UPGRADE.txt	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/UPGRADE.txt	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 UPGRADING
 ---------
diff -Naur drupal-6.21/cron.php drupal-6.37/cron.php
--- drupal-6.21/cron.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/cron.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/includes/actions.inc drupal-6.37/includes/actions.inc
--- drupal-6.21/includes/actions.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/actions.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -26,25 +25,6 @@
  */
 
 /**
- * @defgroup actions Actions
- * @{
- * Functions that perform an action on a certain system object.
- *
- * All modules should declare their action functions to be in this group and
- * each action function should reference its configuration form, validate, and
- * submit functions using \@see. Conversely, form, validate, and submit
- * functions should reference the action function using \@see. For examples of
- * this see comment_unpublish_by_keyword_action(), which has the following in
- * its doxygen documentation:
- *
- * \@ingroup actions
- * \@see comment_unpublish_by_keyword_action_form().
- * \@see comment_unpublish_by_keyword_action_submit().
- *
- * @} End of "defgroup actions".
- */
-
-/**
  * Perform a given list of actions by executing their callback functions.
  *
  * Given the IDs of actions to perform, find out what the callbacks
@@ -356,7 +336,7 @@
     else {
       $link = l(t('Remove orphaned actions'), 'admin/settings/actions/orphan');
       $count = count($actions_in_db);
-      watchdog('actions', format_plural($count, 'One orphaned action (%orphans) exists in the actions table. !link', '@count orphaned actions (%orphans) exist in the actions table. !link'), array('@count' => $count, '%orphans' => $orphans, '!link' => $link), WATCHDOG_WARNING);
+      watchdog('actions', format_plural($count, 'One orphaned action (%orphans) exists in the actions table. !link', '@count orphaned actions (%orphans) exist in the actions table. !link'), array('@count' => $count, '%orphans' => $orphans, '!link' => $link), WATCHDOG_INFO);
     }
   }
 }
diff -Naur drupal-6.21/includes/batch.inc drupal-6.37/includes/batch.inc
--- drupal-6.21/includes/batch.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/batch.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file Batch processing API for processes to run in multiple HTTP requests.
@@ -190,7 +189,7 @@
       call_user_func_array($function, array_merge($args, array(&$batch_context)));
     }
 
-    if ($finished == 1) {
+    if ($finished >= 1) {
       // Make sure this step isn't counted double when computing $current.
       $finished = 0;
       // Remove the operation and clear the sandbox.
@@ -245,7 +244,7 @@
       '@percentage' => $percentage,
       );
     $message = strtr($progress_message, $values) .'<br/>';
-    $message .= $task_message ? $task_message : '&nbsp';
+    $message .= $task_message ? $task_message : '&nbsp;';
 
     return array($percentage, $message);
   }
diff -Naur drupal-6.21/includes/bootstrap.inc drupal-6.37/includes/bootstrap.inc
--- drupal-6.21/includes/bootstrap.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/bootstrap.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -365,7 +364,14 @@
  *  TRUE if only containing valid characters, or FALSE otherwise.
  */
 function drupal_valid_http_host($host) {
-  return preg_match('/^\[?(?:[a-z0-9-:\]_]+\.?)+$/', $host);
+  // Limit the length of the host name to 1000 bytes to prevent DoS attacks with
+  // long host names.
+  return strlen($host) <= 1000
+    // Limit the number of subdomains and port separators to prevent DoS attacks
+    // in conf_path().
+    && substr_count($host, '.') <= 100
+    && substr_count($host, ':') <= 100
+    && preg_match('/^\[?(?:[a-zA-Z0-9-:\]_]+\.?)+$/', $host);
 }
 
 /**
@@ -379,6 +385,10 @@
   global $db_url, $db_prefix, $db_collation, $cookie_domain, $conf, $installed_profile, $update_free_access;
   $conf = array();
 
+  if (!isset($_SERVER['SERVER_PROTOCOL']) || ($_SERVER['SERVER_PROTOCOL'] != 'HTTP/1.0' && $_SERVER['SERVER_PROTOCOL'] != 'HTTP/1.1')) {
+    $_SERVER['SERVER_PROTOCOL'] = 'HTTP/1.0';
+  }
+
   if (isset($_SERVER['HTTP_HOST'])) {
     // As HTTP_HOST is user input, ensure it only contains characters allowed
     // in hostnames. See RFC 952 (and RFC 2181).
@@ -386,7 +396,7 @@
     $_SERVER['HTTP_HOST'] = strtolower($_SERVER['HTTP_HOST']);
     if (!drupal_valid_http_host($_SERVER['HTTP_HOST'])) {
       // HTTP_HOST is invalid, e.g. if containing slashes it may be an attack.
-      header('HTTP/1.1 400 Bad Request');
+      header($_SERVER['SERVER_PROTOCOL'] .' 400 Bad Request');
       exit;
     }
   }
@@ -400,7 +410,7 @@
     include_once './'. conf_path() .'/settings.php';
   }
 
-  // Ignore the placeholder url from default.settings.php.
+  // Ignore the placeholder URL from default.settings.php.
   if (isset($db_url) && $db_url == 'mysql://username:password@localhost/databasename') {
     $db_url = '';
   }
@@ -439,7 +449,7 @@
   }
   else {
     // Otherwise use $base_url as session name, without the protocol
-    // to use the same session identifiers across http and https.
+    // to use the same session identifiers across HTTP and HTTPS.
     list( , $session_name) = explode('://', $base_url, 2);
     // We escape the hostname because it can be modified by a visitor.
     if (!empty($_SERVER['HTTP_HOST'])) {
@@ -750,7 +760,7 @@
   if ($if_modified_since && $if_none_match
       && $if_none_match == $etag // etag must match
       && $if_modified_since == $last_modified) {  // if-modified-since must match
-    header('HTTP/1.1 304 Not Modified');
+    header($_SERVER['SERVER_PROTOCOL'] .' 304 Not Modified');
     // All 304 responses must send an etag if the 200 response for the same object contained an etag
     header("Etag: $etag");
     return;
@@ -1150,7 +1160,7 @@
     case DRUPAL_BOOTSTRAP_ACCESS:
       // Deny access to hosts which were banned - t() is not yet available.
       if (drupal_is_denied('host', ip_address())) {
-        header('HTTP/1.1 403 Forbidden');
+        header($_SERVER['SERVER_PROTOCOL'] .' 403 Forbidden');
         print 'Sorry, '. check_plain(ip_address()) .' has been banned.';
         exit();
       }
@@ -1165,6 +1175,35 @@
     case DRUPAL_BOOTSTRAP_LATE_PAGE_CACHE:
       // Initialize configuration variables, using values from settings.php if available.
       $conf = variable_init(isset($conf) ? $conf : array());
+
+      // Sanitize the destination parameter (which is often used for redirects)
+      // to prevent open redirect attacks leading to other domains. Sanitize
+      // both $_GET['destination'] and $_REQUEST['destination'] to protect code
+      // that relies on either, but do not sanitize $_POST to avoid interfering
+      // with unrelated form submissions. $_REQUEST['edit']['destination'] is
+      // also sanitized since drupal_goto() will sometimes rely on it, and
+      // other code might therefore use it too. The sanitization happens here
+      // because menu_path_is_external() requires the variable system to be
+      // available.
+      if (isset($_GET['destination']) || isset($_REQUEST['destination']) || isset($_REQUEST['edit']['destination'])) {
+        require_once './includes/menu.inc';
+        drupal_load('module', 'filter');
+        // If the destination is an external URL, remove it.
+        if (isset($_GET['destination']) && menu_path_is_external($_GET['destination'])) {
+          unset($_GET['destination']);
+          unset($_REQUEST['destination']);
+        }
+        // If there's still something in $_REQUEST['destination'] that didn't
+        // come from $_GET, check it too.
+        if (isset($_REQUEST['destination']) && (!isset($_GET['destination']) || $_REQUEST['destination'] != $_GET['destination']) && menu_path_is_external($_REQUEST['destination'])) {
+          unset($_REQUEST['destination']);
+        }
+        // Check $_REQUEST['edit']['destination'] separately.
+        if (isset($_REQUEST['edit']['destination']) && menu_path_is_external($_REQUEST['edit']['destination'])) {
+          unset($_REQUEST['edit']['destination']);
+        }
+      }
+
       $cache_mode = variable_get('cache', CACHE_DISABLED);
       // Get the page from the cache.
       $cache = $cache_mode == CACHE_DISABLED ? '' : page_get_cache();
@@ -1331,3 +1370,157 @@
 
   return $ip_address;
 }
+
+/**
+ * Returns a URL-safe, base64 encoded string of highly randomized bytes (over the full 8-bit range).
+ *
+ * @param $byte_count
+ *   The number of random bytes to fetch and base64 encode.
+ *
+ * @return string
+ *   The base64 encoded result will have a length of up to 4 * $byte_count.
+ */
+function drupal_random_key($byte_count = 32) {
+  return drupal_base64_encode(drupal_random_bytes($byte_count));
+}
+
+/**
+ * Returns a URL-safe, base64 encoded version of the supplied string.
+ *
+ * @param $string
+ *   The string to convert to base64.
+ *
+ * @return string
+ */
+function drupal_base64_encode($string) {
+  $data = base64_encode($string);
+  // Modify the output so it's safe to use in URLs.
+  return strtr($data, array('+' => '-', '/' => '_', '=' => ''));
+}
+
+/**
+ * Returns a string of highly randomized bytes (over the full 8-bit range).
+ *
+ * This function is better than simply calling mt_rand() or any other built-in
+ * PHP function because it can return a long string of bytes (compared to < 4
+ * bytes normally from mt_rand()) and uses the best available pseudo-random
+ * source.
+ *
+ * @param $count
+ *   The number of characters (bytes) to return in the string.
+ */
+function drupal_random_bytes($count) {
+  // $random_state does not use drupal_static as it stores random bytes.
+  static $random_state, $bytes, $has_openssl, $has_hash;
+
+  $missing_bytes = $count - strlen($bytes);
+
+  if ($missing_bytes > 0) {
+    // PHP versions prior 5.3.4 experienced openssl_random_pseudo_bytes()
+    // locking on Windows and rendered it unusable.
+    if (!isset($has_openssl)) {
+      $has_openssl = version_compare(PHP_VERSION, '5.3.4', '>=') && function_exists('openssl_random_pseudo_bytes');
+    }
+
+    // openssl_random_pseudo_bytes() will find entropy in a system-dependent
+    // way.
+    if ($has_openssl) {
+      $bytes .= openssl_random_pseudo_bytes($missing_bytes);
+    }
+
+    // Else, read directly from /dev/urandom, which is available on many *nix
+    // systems and is considered cryptographically secure.
+    elseif ($fh = @fopen('/dev/urandom', 'rb')) {
+      // PHP only performs buffered reads, so in reality it will always read
+      // at least 4096 bytes. Thus, it costs nothing extra to read and store
+      // that much so as to speed any additional invocations.
+      $bytes .= fread($fh, max(4096, $missing_bytes));
+      fclose($fh);
+    }
+
+    // If we couldn't get enough entropy, this simple hash-based PRNG will
+    // generate a good set of pseudo-random bytes on any system.
+    // Note that it may be important that our $random_state is passed
+    // through hash() prior to being rolled into $output, that the two hash()
+    // invocations are different, and that the extra input into the first one -
+    // the microtime() - is prepended rather than appended. This is to avoid
+    // directly leaking $random_state via the $output stream, which could
+    // allow for trivial prediction of further "random" numbers.
+    if (strlen($bytes) < $count) {
+      // Initialize on the first call. The contents of $_SERVER includes a mix of
+      // user-specific and system information that varies a little with each page.
+      if (!isset($random_state)) {
+        $random_state = print_r($_SERVER, TRUE);
+        if (function_exists('getmypid')) {
+          // Further initialize with the somewhat random PHP process ID.
+          $random_state .= getmypid();
+        }
+        // hash() is only available in PHP 5.1.2+ or via PECL.
+        $has_hash = function_exists('hash') && in_array('sha256', hash_algos());
+        $bytes = '';
+      }
+
+      if ($has_hash) {
+        do {
+          $random_state = hash('sha256', microtime() . mt_rand() . $random_state);
+          $bytes .= hash('sha256', mt_rand() . $random_state, TRUE);
+        } while (strlen($bytes) < $count);
+      }
+      else {
+        do {
+          $random_state = md5(microtime() . mt_rand() . $random_state);
+          $bytes .= pack("H*", md5(mt_rand() . $random_state));
+        } while (strlen($bytes) < $count);
+      }
+    }
+  }
+  $output = substr($bytes, 0, $count);
+  $bytes = substr($bytes, $count);
+  return $output;
+}
+
+/**
+ * Calculates a hexadecimal encoded sha-1 hmac.
+ *
+ * @param string $data
+ *   String to be validated with the hmac.
+ * @param string $key
+ *   A secret string key.
+ *
+ * See RFC2104 (http://www.ietf.org/rfc/rfc2104.txt). Note, the result of this
+ * must be identical to using hash_hmac('sha1', $data, $key);  We don't use
+ * that function since PHP can be missing it if it was compiled with the
+ * --disable-hash switch.
+ *
+ * @return string
+ *   A hexadecimal encoded sha-1 hmac.
+ */
+function drupal_hash_hmac_sha1($data, $key) {
+  // Keys longer than the 64 byte block size must be hashed first.
+  if (strlen($key) > 64) {
+    $key = pack("H*", sha1($key));
+  }
+  return sha1((str_pad($key, 64, chr(0x00)) ^ (str_repeat(chr(0x5c), 64))) . pack("H*", sha1((str_pad($key, 64, chr(0x00)) ^ (str_repeat(chr(0x36), 64))) . $data)));
+}
+
+/**
+ * Calculates a base-64 encoded, URL-safe sha-1 hmac.
+ *
+ * @param string $data
+ *   String to be validated with the hmac.
+ * @param string $key
+ *   A secret string key.
+ *
+ * @return string
+ *   A base-64 encoded sha-1 hmac, with + replaced with -, / with _ and
+ *   any = padding characters removed.
+ */
+function drupal_hmac_base64($data, $key) {
+  // Casting $data and $key to strings here is necessary to avoid empty string
+  // results of the hash function if they are not scalar values. As this
+  // function is used in security-critical contexts like token validation it is
+  // important that it never returns an empty string.
+  $hmac = base64_encode(pack("H*", drupal_hash_hmac_sha1((string) $data, (string) $key)));
+  // Modify the hmac so it's safe to use in URLs.
+  return strtr($hmac, array('+' => '-', '/' => '_', '=' => ''));
+}
diff -Naur drupal-6.21/includes/cache-install.inc drupal-6.37/includes/cache-install.inc
--- drupal-6.21/includes/cache-install.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/cache-install.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * A stub cache implementation to be used during the installation
diff -Naur drupal-6.21/includes/cache.inc drupal-6.37/includes/cache.inc
--- drupal-6.21/includes/cache.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/cache.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Return data from the persistent cache. Data may be stored as either plain text or as serialized data.
@@ -10,6 +9,8 @@
  * @param $table
  *   The table $table to store the data in. Valid core values are 'cache_filter',
  *   'cache_menu', 'cache_page', or 'cache' for the default cache.
+ *
+ *   @see cache_set()
  */
 function cache_get($cid, $table = 'cache') {
   global $user;
@@ -98,6 +99,8 @@
  *     the given time, after which it behaves like CACHE_TEMPORARY.
  * @param $headers
  *   A string containing HTTP header information for cached pages.
+ *
+ *   @see cache_get()
  */
 function cache_set($cid, $data, $table = 'cache', $expire = CACHE_PERMANENT, $headers = NULL) {
   $serialized = 0;
diff -Naur drupal-6.21/includes/common.inc drupal-6.37/includes/common.inc
--- drupal-6.21/includes/common.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/common.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -32,6 +31,12 @@
 }
 
 /**
+ * Error code indicating that the request made by drupal_http_request() exceeded
+ * the specified timeout.
+ */
+define('HTTP_REQUEST_TIMEOUT', -1);
+
+/**
  * Set content for a specified region.
  *
  * @param $region
@@ -171,7 +176,7 @@
  * Add a feed URL for the current page.
  *
  * @param $url
- *   A url for the feed.
+ *   A URL for the feed.
  * @param $title
  *   The title of the feed.
  */
@@ -201,7 +206,7 @@
 }
 
 /**
- * @name HTTP handling
+ * @defgroup http_handling HTTP handling
  * @{
  * Functions to properly handle HTTP responses.
  */
@@ -291,13 +296,16 @@
  * statement in your menu callback.
  *
  * @param $path
- *   A Drupal path or a full URL.
+ *   (optional) A Drupal path or a full URL, which will be passed to url() to
+ *   compute the redirect for the URL.
  * @param $query
- *   A query string component, if any.
+ *   (optional) A URL-encoded query string to append to the link, or an array of
+ *   query key/value-pairs without any URL-encoding. Passed to url().
  * @param $fragment
- *   A destination fragment identifier (named anchor).
+ *   (optional) A destination fragment identifier (named anchor).
  * @param $http_response_code
- *   Valid values for an actual "goto" as per RFC 2616 section 10.3 are:
+ *   (optional) The HTTP status code to use for the redirection, defaults to
+ *   302. Valid values for an actual "goto" as per RFC 2616 section 10.3 are:
  *   - 301 Moved Permanently (the recommended value for most redirects)
  *   - 302 Found (default in Drupal and PHP, sometimes used for spamming search
  *         engines)
@@ -322,7 +330,7 @@
   if ($destination) {
     // Do not redirect to an absolute URL originating from user input.
     $colonpos = strpos($destination, ':');
-    $absolute = ($colonpos !== FALSE && !preg_match('![/?#]!', substr($destination, 0, $colonpos)));
+    $absolute = strpos($destination, '//') === 0 || ($colonpos !== FALSE && !preg_match('![/?#]!', substr($destination, 0, $colonpos)));
     if (!$absolute) {
       extract(parse_url(urldecode($destination)));
     }
@@ -355,7 +363,7 @@
  */
 function drupal_site_offline() {
   drupal_maintenance_theme();
-  drupal_set_header('HTTP/1.1 503 Service unavailable');
+  drupal_set_header($_SERVER['SERVER_PROTOCOL'] .' 503 Service unavailable');
   drupal_set_title(t('Site off-line'));
   print theme('maintenance_page', filter_xss_admin(variable_get('site_offline_message',
     t('@site is currently under maintenance. We should be back shortly. Thank you for your patience.', array('@site' => variable_get('site_name', 'Drupal'))))));
@@ -365,13 +373,16 @@
  * Generates a 404 error if the request can not be handled.
  */
 function drupal_not_found() {
-  drupal_set_header('HTTP/1.1 404 Not Found');
+  drupal_set_header($_SERVER['SERVER_PROTOCOL'] .' 404 Not Found');
 
   watchdog('page not found', check_plain($_GET['q']), NULL, WATCHDOG_WARNING);
 
   // Keep old path for reference, and to allow forms to redirect to it.
   if (!isset($_REQUEST['destination'])) {
-    $_REQUEST['destination'] = $_GET['q'];
+    // Make sure that the current path is not interpreted as external URL.
+    if (!menu_path_is_external($_GET['q'])) {
+      $_REQUEST['destination'] = $_GET['q'];
+    }
   }
 
   $path = drupal_get_normal_path(variable_get('site_404', ''));
@@ -395,13 +406,16 @@
  * Generates a 403 error if the request is not allowed.
  */
 function drupal_access_denied() {
-  drupal_set_header('HTTP/1.1 403 Forbidden');
+  drupal_set_header($_SERVER['SERVER_PROTOCOL'] .' 403 Forbidden');
 
   watchdog('access denied', check_plain($_GET['q']), NULL, WATCHDOG_WARNING);
 
   // Keep old path for reference, and to allow forms to redirect to it.
   if (!isset($_REQUEST['destination'])) {
-    $_REQUEST['destination'] = $_GET['q'];
+    // Make sure that the current path is not interpreted as external URL.
+    if (!menu_path_is_external($_GET['q'])) {
+      $_REQUEST['destination'] = $_GET['q'];
+    }
   }
 
   $path = drupal_get_normal_path(variable_get('site_403', ''));
@@ -436,11 +450,15 @@
  * @param $retry
  *   An integer representing how many times to retry the request in case of a
  *   redirect.
+ * @param $timeout
+ *   A float representing the maximum number of seconds the function call may
+ *   take. The default is 30 seconds. If a timeout occurs, the error code is set
+ *   to the HTTP_REQUEST_TIMEOUT constant.
  * @return
  *   An object containing the HTTP request headers, response code, protocol,
  *   status message, headers, data and redirect status.
  */
-function drupal_http_request($url, $headers = array(), $method = 'GET', $data = NULL, $retry = 3) {
+function drupal_http_request($url, $headers = array(), $method = 'GET', $data = NULL, $retry = 3, $timeout = 30.0) {
   global $db_prefix;
 
   $result = new stdClass();
@@ -460,18 +478,20 @@
     return $result;
   }
 
+  timer_start(__FUNCTION__);
+
   switch ($uri['scheme']) {
     case 'http':
     case 'feed':
       $port = isset($uri['port']) ? $uri['port'] : 80;
       $host = $uri['host'] . ($port != 80 ? ':'. $port : '');
-      $fp = @fsockopen($uri['host'], $port, $errno, $errstr, 15);
+      $fp = @fsockopen($uri['host'], $port, $errno, $errstr, $timeout);
       break;
     case 'https':
       // Note: Only works for PHP 4.3 compiled with OpenSSL.
       $port = isset($uri['port']) ? $uri['port'] : 443;
       $host = $uri['host'] . ($port != 443 ? ':'. $port : '');
-      $fp = @fsockopen('ssl://'. $uri['host'], $port, $errno, $errstr, 20);
+      $fp = @fsockopen('ssl://'. $uri['host'], $port, $errno, $errstr, $timeout);
       break;
     default:
       $result->error = 'invalid schema '. $uri['scheme'];
@@ -519,7 +539,7 @@
     $defaults['Content-Length'] = 'Content-Length: '. $content_length;
   }
 
-  // If the server url has a user then attempt to use basic authentication
+  // If the server URL has a user then attempt to use basic authentication
   if (isset($uri['user'])) {
     $defaults['Authorization'] = 'Authorization: Basic '. base64_encode($uri['user'] . (!empty($uri['pass']) ? ":". $uri['pass'] : ''));
   }
@@ -545,17 +565,33 @@
 
   $result->request = $request;
 
-  fwrite($fp, $request);
+  // Calculate how much time is left of the original timeout value.
+  $time_left = $timeout - timer_read(__FUNCTION__) / 1000;
+  if ($time_left > 0) {
+    stream_set_timeout($fp, floor($time_left), floor(1000000 * fmod($time_left, 1)));
+    fwrite($fp, $request);
+  }
 
   // Fetch response.
   $response = '';
-  while (!feof($fp) && $chunk = fread($fp, 1024)) {
+  while (!feof($fp)) {
+    // Calculate how much time is left of the original timeout value.
+    $time_left = $timeout - timer_read(__FUNCTION__) / 1000;
+    if ($time_left <= 0) {
+      $result->code = HTTP_REQUEST_TIMEOUT;
+      $result->error = 'request timed out';
+      return $result;
+    }
+    stream_set_timeout($fp, floor($time_left), floor(1000000 * fmod($time_left, 1)));
+    $chunk = fread($fp, 1024);
     $response .= $chunk;
   }
   fclose($fp);
 
-  // Parse response.
-  list($split, $result->data) = explode("\r\n\r\n", $response, 2);
+  // Parse response headers from the response body.
+  // Be tolerant of malformed HTTP responses that separate header and body with
+  // \n\n or \r\r instead of \r\n\r\n.  See http://drupal.org/node/183435
+  list($split, $result->data) = preg_split("/\r\n\r\n|\n\n|\r\r/", $response, 2);
   $split = preg_split("/\r\n|\n|\r/", $split);
 
   list($protocol, $code, $status_message) = explode(' ', trim(array_shift($split)), 3);
@@ -598,9 +634,13 @@
     case 302: // Moved temporarily
     case 307: // Moved temporarily
       $location = $result->headers['Location'];
-
-      if ($retry) {
-        $result = drupal_http_request($result->headers['Location'], $headers, $method, $data, --$retry);
+      $timeout -= timer_read(__FUNCTION__) / 1000;
+      if ($timeout <= 0) {
+        $result->code = HTTP_REQUEST_TIMEOUT;
+        $result->error = 'request timed out';
+      }
+      elseif ($retry) {
+        $result = drupal_http_request($result->headers['Location'], $headers, $method, $data, --$retry, $timeout);
         $result->redirect_code = $result->code;
       }
       $result->redirect_url = $location;
@@ -653,7 +693,9 @@
       }
     }
 
-    $entry = check_plain($types[$errno]) .': '. filter_xss($message) .' in '. check_plain($filename) .' on line '. check_plain($line) .'.';
+    // Try to use filter_xss(). If it's too early in the bootstrap process for
+    // filter_xss() to be loaded, use check_plain() instead.
+    $entry = check_plain($types[$errno]) .': '. (function_exists('filter_xss') ? filter_xss($message) : check_plain($message)) .' in '. check_plain($filename) .' on line '. check_plain($line) .'.';
 
     // Force display of error messages in update.php.
     if (variable_get('error_level', 1) == 1 || strstr($_SERVER['SCRIPT_NAME'], 'update.php')) {
@@ -955,7 +997,7 @@
 /**
  * Verifies the syntax of the given e-mail address.
  *
- * See RFC 2822 for details.
+ * See @link http://tools.ietf.org/html/rfc5322 RFC 5322 @endlink for details.
  *
  * @param $mail
  *   A string containing an e-mail address.
@@ -1389,8 +1431,9 @@
  * alternative than url().
  *
  * @param $path
- *   The internal path or external URL being linked to, such as "node/34" or
- *   "http://example.com/foo". A few notes:
+ *   (optional) The internal path or external URL being linked to, such as
+ *   "node/34" or "http://example.com/foo". The default value is equivalent to
+ *   passing in '<front>'. A few notes:
  *   - If you provide a full URL, it will be considered an external URL.
  *   - If you provide only the path (e.g. "node/34"), it will be
  *     considered an internal link. In this case, it should be a system URL,
@@ -1406,7 +1449,8 @@
  *     include them in $path, or use $options['query'] to let this function
  *     URL encode them.
  * @param $options
- *   An associative array of additional options, with the following elements:
+ *   (optional) An associative array of additional options, with the following
+ *   elements:
  *   - 'query': A URL-encoded query string to append to the link, or an array of
  *     query key/value-pairs without any URL-encoding.
  *   - 'fragment': A fragment identifier (named anchor) to append to the URL.
@@ -1435,12 +1479,20 @@
     'alias' => FALSE,
     'prefix' => ''
   );
+  // A duplicate of the code from menu_path_is_external() to avoid needing
+  // another function call, since performance inside url() is critical.
   if (!isset($options['external'])) {
-    // Return an external link if $path contains an allowed absolute URL.
-    // Only call the slow filter_xss_bad_protocol if $path contains a ':' before
-    // any / ? or #.
+    // Return an external link if $path contains an allowed absolute URL. Avoid
+    // calling filter_xss_bad_protocol() if there is any slash (/), hash (#) or
+    // question_mark (?) before the colon (:) occurrence - if any - as this
+    // would clearly mean it is not a URL. If the path starts with 2 slashes
+    // then it is always considered an external URL without an explicit protocol
+    // part.
     $colonpos = strpos($path, ':');
-    $options['external'] = ($colonpos !== FALSE && !preg_match('![/?#]!', substr($path, 0, $colonpos)) && filter_xss_bad_protocol($path, FALSE) == check_plain($path));
+    $options['external'] = (strpos($path, '//') === 0)
+      || ($colonpos !== FALSE
+        && !preg_match('![/?#]!', substr($path, 0, $colonpos))
+        && filter_xss_bad_protocol($path, FALSE) == check_plain($path));
   }
 
   // May need language dependent rewriting if language.inc is present.
@@ -1470,6 +1522,11 @@
     return $path . $options['fragment'];
   }
 
+  // Strip leading slashes from internal paths to prevent them becoming external
+  // URLs without protocol. /example.com should not be turned into
+  // //example.com.
+  $path = ltrim($path, '/');
+
   global $base_url;
   static $script;
 
@@ -1558,6 +1615,14 @@
  * internal links output by modules should be generated by this function if
  * possible.
  *
+ * However, for links enclosed in translatable text you should use t() and
+ * embed the HTML anchor tag directly in the translated string. For example:
+ * @code
+ * t('Visit the <a href="@url">settings</a> page', array('@url' => url('admin')));
+ * @endcode
+ * This keeps the context of the link title ('settings' in the example) for
+ * translators.
+ *
  * @param $text
  *   The link text for the anchor tag.
  * @param $path
@@ -1639,7 +1704,8 @@
  *   A linear array.
  * @param $function
  *   A name of a function to apply to all values before output.
- * @result
+ *
+ * @return
  *   An associative array.
  */
 function drupal_map_assoc($array, $function = NULL) {
@@ -1788,8 +1854,11 @@
  *
  *   Typical candidates for caching are for example styles for nodes across
  *   the site, or used in the theme.
+ *
  * @return
  *   An array of CSS files.
+ *
+ * @see drupal_get_css()
  */
 function drupal_add_css($path = NULL, $type = 'module', $media = 'all', $preprocess = TRUE) {
   static $css = array();
@@ -1835,8 +1904,11 @@
  * @param $css
  *   (optional) An array of CSS files. If no array is provided, the default
  *   stylesheets array is used instead.
+ *
  * @return
  *   A string of XHTML CSS tags.
+ *
+ * @see drupal_add_css()
  */
 function drupal_get_css($css = NULL) {
   $output = '';
@@ -2533,8 +2605,8 @@
  *   (optional) If set, the variable will be converted to JSON and output.
  */
 function drupal_json($var = NULL) {
-  // We are returning JavaScript, so tell the browser.
-  drupal_set_header('Content-Type: text/javascript; charset=utf-8');
+  // We are returning JSON, so tell the browser.
+  drupal_set_header('Content-Type: application/json');
 
   if (isset($var)) {
     echo drupal_to_js($var);
@@ -2581,7 +2653,7 @@
  */
 function drupal_get_private_key() {
   if (!($key = variable_get('drupal_private_key', 0))) {
-    $key = md5(uniqid(mt_rand(), true)) . md5(uniqid(mt_rand(), true));
+    $key = drupal_random_key();
     variable_set('drupal_private_key', $key);
   }
   return $key;
@@ -2613,7 +2685,7 @@
  */
 function drupal_valid_token($token, $value = '', $skip_anonymous = FALSE) {
   global $user;
-  return (($skip_anonymous && $user->uid == 0) || ($token == md5(session_id() . $value . variable_get('drupal_private_key', ''))));
+  return (($skip_anonymous && $user->uid == 0) || ($token === md5(session_id() . $value . variable_get('drupal_private_key', ''))));
 }
 
 /**
@@ -2671,6 +2743,10 @@
   fix_gpc_magic();
   // Load all enabled modules
   module_load_all();
+  // Ensure mt_rand is reseeded, to prevent random values from one page load
+  // being exploited to predict random values in subsequent page loads.
+  $seed = unpack("L", drupal_random_bytes(4));
+  mt_srand($seed[1]);
   // Let all modules take action before menu system handles the request
   // We do not want this while running update.php.
   if (!defined('MAINTENANCE_MODE') || MAINTENANCE_MODE != 'update') {
@@ -3784,7 +3860,7 @@
  * Changes the character added to all css/js files as dummy query-string,
  * so that all browsers are forced to reload fresh files. We keep
  * 20 characters history (FIFO) to avoid repeats, but only the first
- * (newest) character is actually used on urls, to keep them short.
+ * (newest) character is actually used on URLs, to keep them short.
  * This is also called from update.php.
  */
 function _drupal_flush_css_js() {
diff -Naur drupal-6.21/includes/database.inc drupal-6.37/includes/database.inc
--- drupal-6.21/includes/database.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/database.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -116,10 +115,11 @@
  * code.
  *
  * @param $name
- *   The name assigned to the newly active database connection. If omitted, the
+ *   The key in the $db_url global variable from settings.php. If omitted, the
  *   default connection will be made active.
  *
- * @return the name of the previously active database or FALSE if non was found.
+ * @return
+ *   The name of the previously active database, or FALSE if none was found.
  */
 function db_set_active($name = 'default') {
   global $db_url, $db_type, $active_db;
@@ -174,7 +174,7 @@
   global $db_type;
   drupal_init_language();
   drupal_maintenance_theme();
-  drupal_set_header('HTTP/1.1 503 Service Unavailable');
+  drupal_set_header($_SERVER['SERVER_PROTOCOL'] .' 503 Service Unavailable');
   drupal_set_title('Site off-line');
 
   $message = '<p>The site is currently not available due to technical problems. Please try again later. Thank you for your understanding.</p>';
diff -Naur drupal-6.21/includes/database.mysql-common.inc drupal-6.37/includes/database.mysql-common.inc
--- drupal-6.21/includes/database.mysql-common.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/database.mysql-common.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -27,8 +26,9 @@
  *   and TRUE values to decimal 1.
  *
  * @return
- *   A database query result resource, or FALSE if the query was not
- *   executed correctly.
+ *   Successful SELECT, SHOW, DESCRIBE, EXPLAIN, or other queries which return a
+ *   set of results will return a database query result resource. Other
+ *   successful queries will return TRUE and failing queries will return FALSE.
  */
 function db_query($query) {
   $args = func_get_args();
@@ -290,7 +290,7 @@
  *   table along with adding the field. The format is the same as a
  *   table specification but without the 'fields' element.  If you are
  *   adding a type 'serial' field, you MUST specify at least one key
- *   or index including it in this array. @see db_change_field for more
+ *   or index including it in this array. See db_change_field() for more
  *   explanation why.
  */
 function db_add_field(&$ret, $table, $field, $spec, $keys_new = array()) {
diff -Naur drupal-6.21/includes/database.mysql.inc drupal-6.37/includes/database.mysql.inc
--- drupal-6.21/includes/database.mysql.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/database.mysql.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -56,9 +55,9 @@
     _db_error_page('Unable to use the MySQL database because the MySQL extension for PHP is not installed. Check your <code>php.ini</code> to see how you can enable it.');
   }
 
-  // Decode url-encoded information in the db connection string
+  // Decode urlencoded information in the db connection string
   $url['user'] = urldecode($url['user']);
-  // Test if database url has a password.
+  // Test if database URL has a password.
   $url['pass'] = isset($url['pass']) ? urldecode($url['pass']) : '';
   $url['host'] = urldecode($url['host']);
   $url['path'] = urldecode($url['path']);
@@ -177,7 +176,7 @@
  *
  * @param $result
  *   A database query result resource, as returned from db_query().
- * 
+ *
  * @return
  *   The resulting field or FALSE.
  */
@@ -254,9 +253,9 @@
 /**
  * Runs a SELECT query and stores its results in a temporary table.
  *
- * Use this as a substitute for db_query() when the results need to stored
- * in a temporary table. Temporary tables exist for the duration of the page
- * request.
+ * Use this as a substitute for db_query() when the results need to be stored
+ * in a temporary table.
+ *
  * User-supplied arguments to the query should be passed in as separate parameters
  * so that they can be properly escaped to avoid SQL injection attacks.
  *
@@ -275,10 +274,10 @@
  *
  *   NOTE: using this syntax will cast NULL and FALSE values to decimal 0,
  *   and TRUE values to decimal 1.
- *
  * @param $table
  *   The name of the temporary table to select into. This name will not be
  *   prefixed as there is no risk of collision.
+ *
  * @return
  *   A database query result resource, or FALSE if the query was not executed
  *   correctly.
diff -Naur drupal-6.21/includes/database.mysqli.inc drupal-6.37/includes/database.mysqli.inc
--- drupal-6.21/includes/database.mysqli.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/database.mysqli.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -62,9 +61,9 @@
 
   $url = parse_url($url);
 
-  // Decode url-encoded information in the db connection string
+  // Decode urlencoded information in the db connection string
   $url['user'] = urldecode($url['user']);
-  // Test if database url has a password.
+  // Test if database URL has a password.
   $url['pass'] = isset($url['pass']) ? urldecode($url['pass']) : '';
   $url['host'] = urldecode($url['host']);
   $url['path'] = urldecode($url['path']);
@@ -254,9 +253,9 @@
 /**
  * Runs a SELECT query and stores its results in a temporary table.
  *
- * Use this as a substitute for db_query() when the results need to stored
- * in a temporary table. Temporary tables exist for the duration of the page
- * request.
+ * Use this as a substitute for db_query() when the results need to be stored
+ * in a temporary table.
+ * 
  * User-supplied arguments to the query should be passed in as separate parameters
  * so that they can be properly escaped to avoid SQL injection attacks.
  *
@@ -275,10 +274,10 @@
  *
  *   NOTE: using this syntax will cast NULL and FALSE values to decimal 0,
  *   and TRUE values to decimal 1.
- *
  * @param $table
  *   The name of the temporary table to select into. This name will not be
  *   prefixed as there is no risk of collision.
+ *
  * @return
  *   A database query result resource, or FALSE if the query was not executed
  *   correctly.
diff -Naur drupal-6.21/includes/database.pgsql.inc drupal-6.37/includes/database.pgsql.inc
--- drupal-6.21/includes/database.pgsql.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/database.pgsql.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -53,7 +52,7 @@
   $url = parse_url($url);
   $conn_string = '';
 
-  // Decode url-encoded information in the db connection string
+  // Decode urlencoded information in the db connection string
   if (isset($url['user'])) {
     $conn_string .= ' user='. urldecode($url['user']);
   }
@@ -288,9 +287,9 @@
 /**
  * Runs a SELECT query and stores its results in a temporary table.
  *
- * Use this as a substitute for db_query() when the results need to stored
- * in a temporary table. Temporary tables exist for the duration of the page
- * request.
+ * Use this as a substitute for db_query() when the results need to be stored
+ * in a temporary table.
+ *
  * User-supplied arguments to the query should be passed in as separate parameters
  * so that they can be properly escaped to avoid SQL injection attacks.
  *
@@ -309,10 +308,10 @@
  *
  *   NOTE: using this syntax will cast NULL and FALSE values to decimal 0,
  *   and TRUE values to decimal 1.
- *
  * @param $table
  *   The name of the temporary table to select into. This name will not be
  *   prefixed as there is no risk of collision.
+ *
  * @return
  *   A database query result resource, or FALSE if the query was not executed
  *   correctly.
@@ -662,7 +661,7 @@
  *   table along with adding the field. The format is the same as a
  *   table specification but without the 'fields' element.  If you are
  *   adding a type 'serial' field, you MUST specify at least one key
- *   or index including it in this array. @see db_change_field for more
+ *   or index including it in this array. See db_change_field() for more
  *   explanation why.
  */
 function db_add_field(&$ret, $table, $field, $spec, $new_keys = array()) {
diff -Naur drupal-6.21/includes/file.inc drupal-6.37/includes/file.inc
--- drupal-6.21/includes/file.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/file.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -39,7 +38,7 @@
  * @return A string containing a URL that can be used to download the file.
  */
 function file_create_url($path) {
-  // Strip file_directory_path from $path. We only include relative paths in urls.
+  // Strip file_directory_path from $path. We only include relative paths in URLs.
   if (strpos($path, file_directory_path() .'/') === 0) {
     $path = trim(substr($path, strlen(file_directory_path())), '\\/');
   }
@@ -83,17 +82,28 @@
 }
 
 /**
- * Check that the directory exists and is writable. Directories need to
- * have execute permissions to be considered a directory by FTP servers, etc.
+ * Checks whether a directory exists and is writable.
  *
- * @param $directory A string containing the name of a directory path.
- * @param $mode A Boolean value to indicate if the directory should be created
- *   if it does not exist or made writable if it is read-only.
- * @param $form_item An optional string containing the name of a form item that
- *   any errors will be attached to. This is useful for settings forms that
- *   require the user to specify a writable directory. If it can't be made to
- *   work, a form error will be set preventing them from saving the settings.
- * @return FALSE when directory not found, or TRUE when directory exists.
+ * Furthermore, the directory can optionally be created if it does not exist,
+ * and/or be set to writable if it is currently not. Directories need to have
+ * execute permission to be considered a directory by FTP servers.
+ *
+ * @param $directory
+ *   A string representing the directory path.
+ * @param $mode
+ *   An optional bitmask containing the actions, if any, to be carried out on
+ *   the directory. Any combination of the actions FILE_CREATE_DIRECTORY and
+ *   FILE_MODIFY_PERMISSIONS is allowed.
+ * @param $form_item
+ *   An optional string containing the name of a form item that any errors
+ *   will be attached to. Useful when the function validates a directory path
+ *   entered as a form value. An error will consequently prevent form submit
+ *   handlers from running, and instead display the form along with the
+ *   error messages.
+ *
+ * @return
+ *   FALSE if the directory does not exist or is not writable, even after
+ *   any optional actions have been carried out. Otherwise, TRUE is returned.
  */
 function file_check_directory(&$directory, $mode = 0, $form_item = NULL) {
   $directory = rtrim($directory, '/\\');
@@ -124,20 +134,81 @@
     }
   }
 
-  if ((file_directory_path() == $directory || file_directory_temp() == $directory) && !is_file("$directory/.htaccess")) {
-    $htaccess_lines = "SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006\nOptions None\nOptions +FollowSymLinks";
+  if (file_directory_path() == $directory || file_directory_temp() == $directory) {
+    file_create_htaccess($directory, $form_item);
+  }
+
+  return TRUE;
+}
+
+/**
+ * Creates a .htaccess file in the given directory.
+ *
+ * @param $directory
+ *   The directory.
+ * @param $form_item
+ *   An optional string containing the name of a form item that any errors
+ *   will be attached to. Useful when called from file_check_directory() to
+ *   validate a directory path entered as a form value. An error will
+ *   consequently prevent form submit handlers from running, and instead
+ *   display the form along with the error messages.
+ * @param $force_overwrite
+ *   Set to TRUE to attempt to overwrite the existing .htaccess file if one is
+ *   already present. Defaults to FALSE.
+ */
+function file_create_htaccess($directory, $form_item = NULL, $force_overwrite = FALSE) {
+  if (!is_file("$directory/.htaccess") || $force_overwrite) {
+    $htaccess_lines = file_htaccess_lines();
     if (($fp = fopen("$directory/.htaccess", 'w')) && fputs($fp, $htaccess_lines)) {
       fclose($fp);
       chmod($directory .'/.htaccess', 0664);
     }
     else {
       $variables = array('%directory' => $directory, '!htaccess' => '<br />'. nl2br(check_plain($htaccess_lines)));
-      form_set_error($form_item, t("Security warning: Couldn't write .htaccess file. Please create a .htaccess file in your %directory directory which contains the following lines: <code>!htaccess</code>", $variables));
+      if ($form_item) {
+        form_set_error($form_item, t("Security warning: Couldn't write .htaccess file. Please create a .htaccess file in your %directory directory which contains the following lines: <code>!htaccess</code>", $variables));
+      }
       watchdog('security', "Security warning: Couldn't write .htaccess file. Please create a .htaccess file in your %directory directory which contains the following lines: <code>!htaccess</code>", $variables, WATCHDOG_ERROR);
     }
   }
+}
 
-  return TRUE;
+/**
+ * Returns the standard .htaccess lines that Drupal writes to file directories.
+ *
+ * @return
+ *   A string representing the desired contents of the .htaccess file.
+ *
+ * @see file_create_htaccess()
+ */
+function file_htaccess_lines() {
+  $lines = <<<EOF
+# Turn off all options we don't need.
+Options None
+Options +FollowSymLinks
+
+# Set the catch-all handler to prevent scripts from being executed.
+SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006
+<Files *>
+  # Override the handler again if we're run later in the evaluation list.
+  SetHandler Drupal_Security_Do_Not_Remove_See_SA_2013_003
+</Files>
+
+# If we know how to do it safely, disable the PHP engine entirely.
+<IfModule mod_php5.c>
+  php_flag engine off
+</IfModule>
+# PHP 4, Apache 1.
+<IfModule mod_php4.c>
+  php_flag engine off
+</IfModule>
+# PHP 4, Apache 2.
+<IfModule sapi_apache2.c>
+  php_flag engine off
+</IfModule>
+EOF;
+
+  return $lines;
 }
 
 /**
@@ -393,6 +464,9 @@
 
   // Allow potentially insecure uploads for very savvy users and admin
   if (!variable_get('allow_insecure_uploads', 0)) {
+    // Remove any null bytes. See http://php.net/manual/en/security.filesystem.nullbytes.php
+    $filename = str_replace(chr(0), '', $filename);
+
     $whitelist = array_unique(explode(' ', trim($extensions)));
 
     // Split the filename up by periods. The first part becomes the basename
@@ -449,6 +523,7 @@
     }
     else {
       $name = $basename;
+      $ext = '';
     }
 
     $counter = 0;
@@ -658,9 +733,12 @@
  * @param $file
  *   A Drupal file object.
  * @param $extensions
- *   A string with a space separated
+ *   A string with a space separated list of allowed file extensions, not
+ *   including the period. For example, 'bmp jpg gif png'.
+ *
  * @return
- *   An array. If the file extension is not allowed, it will contain an error message.
+ *   An array. If the file extension is not allowed, it will contain an error
+ *   message.
  */
 function file_validate_extensions($file, $extensions) {
   global $user;
@@ -669,7 +747,7 @@
 
   // Bypass validation for uid  = 1.
   if ($user->uid != 1) {
-    $regex = '/\.('. ereg_replace(' +', '|', preg_quote($extensions)) .')$/i';
+    $regex = '/\.('. @ereg_replace(' +', '|', preg_quote($extensions)) .')$/i';
     if (!preg_match($regex, $file->filename)) {
       $errors[] = t('Only files with the following extensions are allowed: %files-allowed.', array('%files-allowed' => $extensions));
     }
@@ -817,8 +895,13 @@
 /**
  * Set the status of a file.
  *
- * @param file A Drupal file object
- * @param status A status value to set the file to.
+ * @param $file 
+ *   A Drupal file object.
+ * @param $status
+ *   A status value to set the file to. One of:
+ *   - FILE_STATUS_PERMANENT
+ *   - FILE_STATUS_TEMPORARY
+ *
  * @return FALSE on failure, TRUE on success and $file->status will contain the
  *     status.
  */
@@ -841,6 +924,14 @@
   if (ob_get_level()) {
     ob_end_clean();
   }
+  
+  // IE cannot download private files because it cannot store files downloaded
+  // over HTTPS in the browser cache. The problem can be solved by sending
+  // custom headers to IE. See http://support.microsoft.com/kb/323308/en-us
+  if (isset($_SERVER['HTTPS']) && ($_SERVER['HTTPS'] == 'on')) {
+    drupal_set_header('Cache-Control: private');
+    drupal_set_header('Pragma: private');
+  }
 
   foreach ($headers as $header) {
     // To prevent HTTP header injection, we delete new lines that are
@@ -883,20 +974,72 @@
   }
 
   if (file_exists(file_create_path($filepath))) {
-    $headers = module_invoke_all('file_download', $filepath);
-    if (in_array(-1, $headers)) {
-      return drupal_access_denied();
-    }
+    $headers = file_download_headers($filepath);
     if (count($headers)) {
       file_transfer($filepath, $headers);
     }
+    else {
+      return drupal_access_denied();
+    }
   }
   return drupal_not_found();
 }
 
+/**
+ * Retrieves headers for a private file download.
+ *
+ * Calls all module implementations of hook_file_download() to retrieve headers
+ * for files by the module that originally provided the file. The presence of
+ * returned headers indicates the current user has access to the file.
+ *
+ * @param $filepath
+ *   The path for the file whose headers should be retrieved.
+ *
+ * @return
+ *   If access is allowed, headers for the file, suitable for passing to
+ *   file_transfer(). If access is not allowed, an empty array will be returned.
+ *
+ * @see file_transfer()
+ * @see file_download_access()
+ * @see hook_file_downlaod()
+ */
+function file_download_headers($filepath) {
+  $headers = module_invoke_all('file_download', $filepath);
+  if (in_array(-1, $headers)) {
+    // Throw away the headers received so far.
+    $headers = array();
+  }
+  return $headers;
+}
+
+/**
+ * Checks that the current user has access to a particular file.
+ *
+ * The return value of this function hinges on the return value from
+ * file_download_headers(), which is the function responsible for collecting
+ * access information through hook_file_download().
+ *
+ * If immediately transferring the file to the browser and the headers will
+ * need to be retrieved, the return value of file_download_headers() should be
+ * used to determine access directly, so that access checks will not be run
+ * twice.
+ *
+ * @param $filepath
+ *   The path for the file whose headers should be retrieved.
+ *
+ * @return
+ *   Boolean TRUE if access is allowed. FALSE if access is not allowed.
+ *
+ * @see file_download_headers()
+ * @see hook_file_download()
+ */
+function file_download_access($filepath) {
+  return count(file_download_headers($filepath)) > 0;
+}
 
 /**
  * Finds all files that match a given mask in a given directory.
+ *
  * Directories and files beginning with a period are excluded; this
  * prevents hidden files and directories (such as SVN working directories)
  * from being scanned.
@@ -913,18 +1056,19 @@
  *   When TRUE, the directory scan will recurse the entire tree
  *   starting at the provided directory.
  * @param $key
- *   The key to be used for the returned array of files. Possible
- *   values are "filename", for the path starting with $dir,
- *   "basename", for the basename of the file, and "name" for the name
- *   of the file without an extension.
+ *   The key to be used for the returned associative array of files. Possible
+ *   values are "filename", for the path starting with $dir; "basename", for
+ *   the basename of the file; and "name" for the name of the file without the
+ *   extension.
  * @param $min_depth
  *   Minimum depth of directories to return files from.
  * @param $depth
- *   Current depth of recursion. This parameter is only used internally and should not be passed.
+ *   Current depth of recursion. This parameter is only used internally and
+ *   should not be passed in.
  *
  * @return
  *   An associative array (keyed on the provided key) of objects with
- *   "path", "basename", and "name" members corresponding to the
+ *   "filename", "basename", and "name" members corresponding to the
  *   matching files.
  */
 function file_scan_directory($dir, $mask, $nomask = array('.', '..', 'CVS'), $callback = 0, $recurse = TRUE, $key = 'filename', $min_depth = 0, $depth = 0) {
@@ -938,7 +1082,7 @@
           // Give priority to files in this folder by merging them in after any subdirectory files.
           $files = array_merge(file_scan_directory("$dir/$file", $mask, $nomask, $callback, $recurse, $key, $min_depth, $depth + 1), $files);
         }
-        elseif ($depth >= $min_depth && ereg($mask, $file)) {
+        elseif ($depth >= $min_depth && @ereg($mask, $file)) {
           // Always use this match over anything already set in $files with the same $$key.
           $filename = "$dir/$file";
           $basename = basename($file);
diff -Naur drupal-6.21/includes/form.inc drupal-6.37/includes/form.inc
--- drupal-6.21/includes/form.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/form.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @defgroup forms Form builder functions
@@ -42,8 +41,8 @@
  *
  * For information on the format of the structured arrays used to define forms,
  * and more detailed explanations of the Form API workflow, see the
- * @link http://api.drupal.org/api/file/developer/topics/forms_api_reference.html reference @endlink
- * and the @link http://api.drupal.org/api/file/developer/topics/forms_api.html quickstart guide. @endlink
+ * @link forms_api_reference.html reference @endlink and the
+ * @link http://drupal.org/node/204270 Form API guide. @endlink
  */
 
 /**
@@ -102,7 +101,7 @@
       array_unshift($args_temp, $form_id);
 
       $form = call_user_func_array('drupal_retrieve_form', $args_temp);
-      $form_build_id = 'form-'. md5(uniqid(mt_rand(), TRUE));
+      $form_build_id = 'form-'. drupal_random_key();
       $form['#build_id'] = $form_build_id;
       drupal_prepare_form($form_id, $form, $form_state);
       // Store a copy of the unprocessed form for caching and indicate that it
@@ -197,7 +196,7 @@
 
   if (!isset($form_build_id)) {
     // We need a new build_id for the new version of the form.
-    $form_build_id = 'form-'. md5(uniqid(mt_rand(), TRUE));
+    $form_build_id = 'form-'. drupal_random_key();
   }
   $form['#build_id'] = $form_build_id;
   drupal_prepare_form($form_id, $form, $form_state);
@@ -227,10 +226,25 @@
   if ($user->uid) {
     $form['#cache_token'] = drupal_get_token();
   }
+  elseif (variable_get('cache', CACHE_DISABLED) != CACHE_DISABLED && $_SERVER['REQUEST_METHOD'] == 'GET' && page_get_cache(TRUE)) {
+    $form['#immutable'] = TRUE;
+  }
+  $form_build_id_old = $form_build_id;
+  $form_build_id = form_build_id_map($form_build_id_old);
   cache_set('form_'. $form_build_id, $form, 'cache_form', time() + $expire);
   if (!empty($form_state['storage'])) {
     cache_set('storage_'. $form_build_id, $form_state['storage'], 'cache_form', time() + $expire);
   }
+
+  // If form_set_cache is called in the context of an ahah handler inform the
+  // client about the changed form build_id via the X-Drupal-Build-Id HTTP
+  // header.
+  if (!empty($_SERVER['HTTP_X_DRUPAL_ACCEPT_BUILD_ID']) &&
+    !empty($_POST['form_build_id']) &&
+    $_POST['form_build_id'] == $form_build_id_old &&
+    $form_build_id_old != $form_build_id) {
+    drupal_set_header('X-Drupal-Build-Id: ' . $form_build_id);
+  }
 }
 
 /**
@@ -244,12 +258,36 @@
       if ($cached = cache_get('storage_'. $form_build_id, 'cache_form')) {
         $form_state['storage'] = $cached->data;
       }
+
+      // Generate a new #build_id if the cached form was rendered on a cacheable
+      // page.
+      if (!empty($form['#immutable'])) {
+        $form['#build_id'] = 'form-' . drupal_random_key();
+        $form['form_build_id']['#value'] = $form['#build_id'];
+        $form['form_build_id']['#id'] = $form['#build_id'];
+        unset($form['#immutable']);
+
+        form_build_id_map($form_build_id, $form['#build_id']);
+      }
       return $form;
     }
   }
 }
 
 /**
+ * Maintain a map of immutable form_build_ids to cloned form.
+ */
+function form_build_id_map($form_build_id, $new_build_id = NULL) {
+  static $build_id_map = array();
+
+  if (isset($new_build_id) && isset($form_build_id)) {
+    $build_id_map[$form_build_id] = $new_build_id;
+  }
+
+  return isset($build_id_map[$form_build_id]) ? $build_id_map[$form_build_id] : $form_build_id;
+}
+
+/**
  * Retrieves, populates, and processes a form.
  *
  * This function allows you to supply values for form elements and submit a
@@ -303,9 +341,14 @@
 
   // Make sure $form_state is passed around by reference.
   $args[1] = &$form_state;
-  
+
   $form = call_user_func_array('drupal_retrieve_form', $args);
   $form['#post'] = $form_state['values'];
+
+  // Reset form validation.
+  $form_state['must_validate'] = TRUE;
+  form_set_error(NULL, '', TRUE);
+
   drupal_prepare_form($form_id, $form, $form_state);
   drupal_process_form($form_id, $form, $form_state);
 }
@@ -576,16 +619,22 @@
 function drupal_validate_form($form_id, $form, &$form_state) {
   static $validated_forms = array();
 
-  if (isset($validated_forms[$form_id])) {
+  if (isset($validated_forms[$form_id]) && empty($form_state['must_validate'])) {
     return;
   }
 
   // If the session token was set by drupal_prepare_form(), ensure that it
   // matches the current user's session.
   if (isset($form['#token'])) {
-    if (!drupal_valid_token($form_state['values']['form_token'], $form['#token'])) {
+    if (!drupal_valid_token($form_state['values']['form_token'], $form['#token']) || !empty($form_state['invalid_token'])) {
       // Setting this error will cause the form to fail validation.
       form_set_error('form_token', t('Validation error, please try again. If this error persists, please contact the site administrator.'));
+
+      // Stop here and don't run any further validation handlers, because they
+      // could invoke non-safe operations which opens the door for CSRF
+      // vulnerabilities.
+      $validated_forms[$form_id] = TRUE;
+      return;
     }
   }
 
@@ -769,8 +818,8 @@
 
   foreach ($handlers as $function) {
     if (function_exists($function))  {
-      // Check to see if a previous _submit handler has set a batch, but 
-      // make sure we do not react to a batch that is already being processed 
+      // Check to see if a previous _submit handler has set a batch, but
+      // make sure we do not react to a batch that is already being processed
       // (for instance if a batch operation performs a drupal_execute()).
       if ($type == 'submit' && ($batch =& batch_get()) && !isset($batch['current_set'])) {
         // Some previous _submit handler has set a batch. We store the call
@@ -877,12 +926,28 @@
     $form += $info;
   }
 
+  // Special handling if we're on the top level form element.
   if (isset($form['#type']) && $form['#type'] == 'form') {
     $cache = NULL;
     $complete_form = $form;
     if (!empty($form['#programmed'])) {
       $form_state['submitted'] = TRUE;
     }
+    else {
+      // If the session token was set by drupal_prepare_form(), ensure that it
+      // matches the current user's session before processing input.
+      if (isset($form['#token']) && isset($form['#post']) && (isset($form['#post']['form_id']) && $form['#post']['form_id'] == $form_id)) {
+        $form_state['invalid_token'] = FALSE;
+        if (empty($form['#post']['form_token']) || !drupal_valid_token($form['#post']['form_token'], $form['#token'])) {
+          // Setting this error will cause the form to fail validation.
+          form_set_error('form_token', t('Validation error, please try again. If this error persists, please contact the site administrator.'));
+          // This value is checked in _form_builder_handle_input_element().
+          $form_state['invalid_token'] = TRUE;
+          // Make sure file uploads do not get processed.
+          $_FILES = array();
+        }
+      }
+    }
   }
 
   if (isset($form['#input']) && $form['#input']) {
@@ -970,6 +1035,15 @@
  * attached to a specific element.
  */
 function _form_builder_handle_input_element($form_id, &$form, &$form_state, $complete_form) {
+  static $safe_core_value_callbacks = array(
+    'form_type_token_value',
+    'form_type_textfield_value',
+    'form_type_checkbox_value',
+    'form_type_checkboxes_value',
+    'form_type_password_confirm_value',
+    'form_type_select_value'
+  );
+
   if (!isset($form['#name'])) {
     $name = array_shift($form['#parents']);
     $form['#name'] = $name;
@@ -1002,7 +1076,14 @@
       if (!$form['#programmed'] || isset($edit)) {
         // Call #type_value to set the form value;
         if (function_exists($function)) {
-          $form['#value'] = $function($form, $edit);
+          // Skip all value callbacks except safe ones like text if the CSRF
+          // token was invalid.
+          if (empty($form_state['invalid_token']) || in_array($function, $safe_core_value_callbacks)) {
+            $form['#value'] = $function($form, $edit);
+          }
+          else {
+            $edit = NULL;
+          }
         }
         if (!isset($form['#value']) && isset($edit)) {
           $form['#value'] = $edit;
@@ -1435,7 +1516,7 @@
   $options = '';
   foreach ($choices as $key => $choice) {
     if (is_array($choice)) {
-      $options .= '<optgroup label="'. $key .'">';
+      $options .= '<optgroup label="'. check_plain($key) .'">';
       $options .= form_select_options($element, $choice);
       $options .= '</optgroup>';
     }
@@ -1721,9 +1802,9 @@
 /**
  * Validates the date type to stop dates like February 30, 2006.
  */
-function date_validate($form) {
-  if (!checkdate($form['#value']['month'], $form['#value']['day'], $form['#value']['year'])) {
-    form_error($form, t('The specified date is invalid.'));
+function date_validate($element) {
+  if (!checkdate($element['#value']['month'], $element['#value']['day'], $element['#value']['year'])) {
+    form_error($element, t('The specified date is invalid.'));
   }
 }
 
@@ -1788,6 +1869,8 @@
  *   drupal_add_js.
  */
 function form_expand_ahah($element) {
+  global $user;
+
   static $js_added = array();
   // Add a reasonable default event handler if none specified.
   if (isset($element['#ahah']['path']) && !isset($element['#ahah']['event'])) {
@@ -1834,11 +1917,16 @@
       'button'   => isset($element['#executes_submit_callback']) ? array($element['#name'] => $element['#value']) : FALSE,
     );
 
+    // If page caching is active, indicate that this form is immutable.
+    if (variable_get('cache', CACHE_DISABLED) != CACHE_DISABLED && !$user->uid && $_SERVER['REQUEST_METHOD'] == 'GET' && page_get_cache(TRUE)) {
+      $ahah_binding['immutable'] = TRUE;
+    }
+
     // Convert a simple #ahah[progress] type string into an array.
     if (is_string($ahah_binding['progress'])) {
       $ahah_binding['progress'] = array('type' => $ahah_binding['progress']);
     }
-    // Change progress path to a full url.
+    // Change progress path to a full URL.
     if (isset($ahah_binding['progress']['path'])) {
       $ahah_binding['progress']['url'] = url($ahah_binding['progress']['path']);
     }
@@ -2023,6 +2111,29 @@
 }
 
 /**
+ * Process function to prepare autocomplete data.
+ *
+ * @param $element
+ *   A textfield or other element with a #autocomplete_path.
+ *
+ * @return array
+ *   The processed form element.
+ */
+function form_process_autocomplete($element) {
+  $element['#autocomplete_input'] = array();
+  if ($element['#autocomplete_path'] && menu_valid_path(array('link_path' => $element['#autocomplete_path']))) {
+    $element['#autocomplete_input']['#id'] = $element['#id'] .'-autocomplete';
+    // Force autocomplete to use non-clean URLs since this protects against the
+    // browser interpreting the path plus search string as an actual file.
+    $current_clean_url = isset($GLOBALS['conf']['clean_url']) ? $GLOBALS['conf']['clean_url'] : NULL;
+    $GLOBALS['conf']['clean_url'] = 0;
+    $element['#autocomplete_input']['#url_value'] = check_url(url($element['#autocomplete_path'], array('absolute' => TRUE)));
+    $GLOBALS['conf']['clean_url'] = $current_clean_url;
+  }
+  return $element;
+}
+
+/**
  * Format a textfield.
  *
  * @param $element
@@ -2040,10 +2151,10 @@
   $extra = '';
   $output = '';
 
-  if ($element['#autocomplete_path'] && menu_valid_path(array('link_path' => $element['#autocomplete_path']))) {
+  if ($element['#autocomplete_path'] && !empty($element['#autocomplete_input'])) {
     drupal_add_js('misc/autocomplete.js');
     $class[] = 'form-autocomplete';
-    $extra =  '<input class="autocomplete" type="hidden" id="'. $element['#id'] .'-autocomplete" value="'. check_url(url($element['#autocomplete_path'], array('absolute' => TRUE))) .'" disabled="disabled" />';
+    $extra =  '<input class="autocomplete" type="hidden" id="'. $element['#autocomplete_input']['#id'] .'" value="'. $element['#autocomplete_input']['#url_value'] .'" disabled="disabled" />';
   }
   _form_set_class($element, $class);
 
@@ -2325,8 +2436,9 @@
  *   'file' => 'path_to_file_containing_myfunctions',
  * );
  * batch_set($batch);
- * // only needed if not inside a form _submit handler :
- * batch_process();
+ * // Only needed if not inside a form _submit handler.
+ * // Setting redirect in batch_process.
+ * batch_process('node/1');
  * @endcode
  *
  * Note: if the batch 'title', 'init_message', 'progress_message', or
@@ -2420,8 +2532,8 @@
  *   - 'init_message': Message displayed while the processing is initialized.
  *     Defaults to t('Initializing.').
  *   - 'progress_message': Message displayed while processing the batch.
- *     Available placeholders are @current, @remaining, @total, @percentage,
- *     @estimate and @elapsed. Defaults to t('Completed @current of @total.').
+ *     Available placeholders are @current, @remaining, @total, and
+ *     @percentage. Defaults to t('Completed @current of @total.').
  *   - 'error_message': Message displayed if an error occurred while processing
  *     the batch. Defaults to t('An error has occurred.').
  *   - 'finished': Name of a function to be executed after the batch has
@@ -2437,7 +2549,7 @@
  * clean code independence, ensuring that several batches submitted by
  * different parts of the code (core / contrib modules) can be processed
  * correctly while not interfering or having to cope with each other. Each
- * batch set gets to specify his own UI messages, operates on its own set
+ * batch set gets to specify its own UI messages, operates on its own set
  * of operations and results, and triggers its own 'finished' callback.
  * Batch sets are processed sequentially, with the progress bar starting
  * fresh for every new set.
diff -Naur drupal-6.21/includes/image.gd.inc drupal-6.37/includes/image.gd.inc
--- drupal-6.21/includes/image.gd.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/image.gd.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/includes/image.inc drupal-6.37/includes/image.inc
--- drupal-6.21/includes/image.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/image.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -114,7 +113,9 @@
  *    'file_size' - File size in bytes.
  */
 function image_get_info($file) {
-  if (!is_file($file) && !is_uploaded_file($filepath)) {
+  // Proceed no further if this file doesn't exist. Some web servers (IIS) may
+  // not pass is_file() for newly uploaded files, so we need two checks here.
+  if (!is_file($file) && !is_uploaded_file($file)) {
     return FALSE;
   }
 
diff -Naur drupal-6.21/includes/install.inc drupal-6.37/includes/install.inc
--- drupal-6.21/includes/install.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/install.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 define('SCHEMA_UNINSTALLED', -1);
 define('SCHEMA_INSTALLED', 0);
diff -Naur drupal-6.21/includes/install.mysql.inc drupal-6.37/includes/install.mysql.inc
--- drupal-6.21/includes/install.mysql.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/install.mysql.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 // MySQL specific install functions
 
@@ -27,7 +26,7 @@
 
   $url = parse_url($url);
 
-  // Decode url-encoded information in the db connection string.
+  // Decode urlencoded information in the db connection string.
   $url['user'] = urldecode($url['user']);
   $url['pass'] = isset($url['pass']) ? urldecode($url['pass']) : '';
   $url['host'] = urldecode($url['host']);
diff -Naur drupal-6.21/includes/install.mysqli.inc drupal-6.37/includes/install.mysqli.inc
--- drupal-6.21/includes/install.mysqli.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/install.mysqli.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 // MySQLi specific install functions
 
@@ -27,7 +26,7 @@
 
   $url = parse_url($url);
 
-  // Decode url-encoded information in the db connection string.
+  // Decode urlencoded information in the db connection string.
   $url['user'] = urldecode($url['user']);
   $url['pass'] = isset($url['pass']) ? urldecode($url['pass']) : '';
   $url['host'] = urldecode($url['host']);
diff -Naur drupal-6.21/includes/install.pgsql.inc drupal-6.37/includes/install.pgsql.inc
--- drupal-6.21/includes/install.pgsql.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/install.pgsql.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 // PostgreSQL specific install functions
 
@@ -28,7 +27,7 @@
   $url = parse_url($url);
   $conn_string = '';
 
-  // Decode url-encoded information in the db connection string
+  // Decode urlencoded information in the db connection string
   if (isset($url['user'])) {
     $conn_string .= ' user='. urldecode($url['user']);
   }
diff -Naur drupal-6.21/includes/language.inc drupal-6.37/includes/language.inc
--- drupal-6.21/includes/language.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/language.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/includes/locale.inc drupal-6.37/includes/locale.inc
--- drupal-6.21/includes/locale.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/locale.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -1294,14 +1293,11 @@
           // data untouched or if we don't have an existing plural formula.
           $header = _locale_import_parse_header($value['msgstr']);
 
-          // Get the plural formula and update in database.
+          // Get and store the plural formula if available.
           if (isset($header["Plural-Forms"]) && $p = _locale_import_parse_plural_forms($header["Plural-Forms"], $file->filename)) {
             list($nplurals, $plural) = $p;
             db_query("UPDATE {languages} SET plurals = %d, formula = '%s' WHERE language = '%s'", $nplurals, $plural, $lang);
           }
-          else {
-            db_query("UPDATE {languages} SET plurals = %d, formula = '%s' WHERE language = '%s'", 0, '', $lang);
-          }
         }
         $headerdone = TRUE;
       }
@@ -1672,7 +1668,7 @@
       break;
     }
   }
-  return substr($comm, 0, -2);
+  return trim(substr($comm, 0, -2));
 }
 
 /**
@@ -2159,35 +2155,12 @@
   }
 
   // Construct the array for JavaScript translations.
-  // We sort on plural so that we have all plural forms before singular forms.
-  $result = db_query("SELECT s.lid, s.source, t.plid, t.plural, t.translation FROM {locales_source} s LEFT JOIN {locales_target} t ON s.lid = t.lid AND t.language = '%s' WHERE s.location LIKE '%%.js%%' AND s.textgroup = 'default' ORDER BY t.plural DESC", $language->language);
+  // Only add strings with a translation to the translations array.
+  $result = db_query("SELECT s.lid, s.source, t.translation FROM {locales_source} s INNER JOIN {locales_target} t ON s.lid = t.lid AND t.language = '%s' WHERE s.location LIKE '%%.js%%' AND s.textgroup = 'default'", $language->language);
 
-  $translations = $plurals = array();
+  $translations = array();
   while ($data = db_fetch_object($result)) {
-    // Only add this to the translations array when there is actually a translation.
-    if (!empty($data->translation)) {
-      if ($data->plural) {
-        // When the translation is a plural form, first add it to another array and
-        // wait for the singular (parent) translation.
-        if (!isset($plurals[$data->plid])) {
-          $plurals[$data->plid] = array($data->plural => $data->translation);
-        }
-        else {
-          $plurals[$data->plid] += array($data->plural => $data->translation);
-        }
-      }
-      elseif (isset($plurals[$data->lid])) {
-        // There are plural translations for this translation, so get them from
-        // the plurals array and add them to the final translations array.
-        $translations[$data->source] = array($data->plural => $data->translation) + $plurals[$data->lid];
-        unset($plurals[$data->lid]);
-      }
-      else {
-        // There are no plural forms for this translation, so just add it to
-        // the translations array.
-        $translations[$data->source] = $data->translation;
-      }
-    }
+    $translations[$data->source] = $data->translation;
   }
 
   // Construct the JavaScript file, if there are translations.
@@ -2622,20 +2595,21 @@
     $operations = array();
     foreach ($files as $file) {
       // We call _locale_batch_import for every batch operation.
-      $operations[] = array('_locale_batch_import', array($file->filename));    }
-      $batch = array(
-        'operations'    => $operations,
-        'title'         => $t('Importing interface translations'),
-        'init_message'  => $t('Starting import'),
-        'error_message' => $t('Error importing interface translations'),
-        'file'          => './includes/locale.inc',
-        // This is not a batch API construct, but data passed along to the
-        // installer, so we know what did we import already.
-        '#components'   => $components,
-      );
-      if (isset($finished)) {
-        $batch['finished'] = $finished;
-      }
+      $operations[] = array('_locale_batch_import', array($file->filename));
+    }
+    $batch = array(
+      'operations'    => $operations,
+      'title'         => $t('Importing interface translations'),
+      'init_message'  => $t('Starting import'),
+      'error_message' => $t('Error importing interface translations'),
+      'file'          => './includes/locale.inc',
+      // This is not a batch API construct, but data passed along to the
+      // installer, so we know what did we import already.
+      '#components'   => $components,
+    );
+    if (isset($finished)) {
+      $batch['finished'] = $finished;
+    }
     return $batch;
   }
   return FALSE;
diff -Naur drupal-6.21/includes/lock-install.inc drupal-6.37/includes/lock-install.inc
--- drupal-6.21/includes/lock-install.inc	1970-01-01 01:00:00.000000000 +0100
+++ drupal-6.37/includes/lock-install.inc	2015-08-19 23:15:49.000000000 +0200
@@ -0,0 +1,62 @@
+<?php
+
+/**
+ * @file
+ * A stub lock implementation to be used during the installation
+ * process when database access is not yet available. Because Drupal's
+ * install system should never be running in more than on concurrant
+ * request, we can bypass any need for locking.
+ */
+
+/**
+ * Initialize the locking system.
+ */
+function lock_init() {
+}
+
+/**
+ * Acquire (or renew) a lock, but do not block if it fails.
+ *
+ * @return
+ *   TRUE if the lock was acquired, FALSE if it failed.
+ */
+function lock_acquire($name, $timeout = 30.0) {
+  return TRUE;
+}
+
+/**
+ * Check if lock acquired by a different process may be available.
+ *
+ * @return
+ *   TRUE if there is no lock or it was removed, FALSE otherwise.
+ */
+function lock_may_be_available($name) {
+  return TRUE;
+}
+
+/**
+ * Wait for a lock to be available.
+ *
+ * @return
+ *   TRUE if the lock holds, FALSE if it is available.
+ */
+function lock_wait($name, $delay = 30) {
+  return FALSE;
+}
+
+/**
+ * Release a lock previously acquired by lock_acquire().
+ *
+ * This will release the named lock if it is still held by the current request.
+ *
+ * @param $name
+ *   The name of the lock.
+ */
+function lock_release($name) {
+}
+
+/**
+ * Release all previously acquired locks.
+ */
+function lock_release_all($lock_id = NULL) {
+}
diff -Naur drupal-6.21/includes/lock.inc drupal-6.37/includes/lock.inc
--- drupal-6.21/includes/lock.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/lock.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -103,7 +102,8 @@
   $expire = (float)$usec + (float)$sec + $timeout;
   if (isset($locks[$name])) {
     // Try to extend the expiration of a lock we already acquired.
-    if (!db_result(db_query("UPDATE {semaphore} SET expire = %f WHERE name = '%s' AND value = '%s'", $expire, $name, _lock_id()))) {
+    db_query("UPDATE {semaphore} SET expire = %f WHERE name = '%s' AND value = '%s'", $expire, $name, _lock_id());
+    if (!db_affected_rows()) {
       // The lock was broken.
       unset($locks[$name]);
     }
diff -Naur drupal-6.21/includes/mail.inc drupal-6.37/includes/mail.inc
--- drupal-6.21/includes/mail.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/mail.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Compose and optionally send an e-mail message.
@@ -60,11 +59,13 @@
  *   will be {$module}_{$key}.
  * @param $to
  *   The e-mail address or addresses where the message will be sent to. The
- *   formatting of this string must comply with RFC 2822. Some examples are:
- *    user@example.com
- *    user@example.com, anotheruser@example.com
- *    User <user@example.com>
- *    User <user@example.com>, Another User <anotheruser@example.com>
+ *   formatting of this string must comply with
+ *   @link http://tools.ietf.org/html/rfc5322 RFC 5322 @endlink.
+ *   Some examples are:
+ *   - user@example.com
+ *   - user@example.com, anotheruser@example.com
+ *   - User <user@example.com>
+ *   - User <user@example.com>, Another User <anotheruser@example.com>
  * @param $language
  *   Language object to use to compose the e-mail.
  * @param $params
@@ -73,6 +74,7 @@
  *   Sets From to this value, if given.
  * @param $send
  *   Send the message directly, without calling drupal_mail_send() manually.
+ *
  * @return
  *   The $message array structure containing all details of the
  *   message. If already sent ($send = TRUE), then the 'result' element
@@ -146,26 +148,24 @@
  * how $message is composed.
  *
  * @param $message
- *  Message array with at least the following elements:
- *   - id
- *      A unique identifier of the e-mail type. Examples: 'contact_user_copy',
- *      'user_password_reset'.
- *   - to
- *      The mail address or addresses where the message will be sent to. The
- *      formatting of this string must comply with RFC 2822. Some examples are:
- *       user@example.com
- *       user@example.com, anotheruser@example.com
- *       User <user@example.com>
- *       User <user@example.com>, Another User <anotheruser@example.com>
- *   - subject
- *      Subject of the e-mail to be sent. This must not contain any newline
- *      characters, or the mail may not be sent properly.
- *   - body
- *      Message to be sent. Accepts both CRLF and LF line-endings.
- *      E-mail bodies must be wrapped. You can use drupal_wrap_mail() for
- *      smart plain text wrapping.
- *   - headers
- *      Associative array containing all mail headers.
+ *   Message array with at least the following elements:
+ *   - id: A unique identifier of the e-mail type. Examples:
+ *     'contact_user_copy', 'user_password_reset'.
+ *   - to: The mail address or addresses where the message will be sent to. The
+ *     formatting of this string must comply with
+ *     @link http://tools.ietf.org/html/rfc5322 RFC 5322 @endlink.
+ *     Some examples are:
+ *     - user@example.com
+ *     - user@example.com, anotheruser@example.com
+ *     - User <user@example.com>
+ *     - User <user@example.com>, Another User <anotheruser@example.com>
+ *   - subject: Subject of the e-mail to be sent. This must not contain any
+ *     newline characters, or the mail may not be sent properly.
+ *   - body: Message to be sent. Accepts both CRLF and LF line-endings.
+ *     E-mail bodies must be wrapped. You can use drupal_wrap_mail() for
+ *     smart plain text wrapping.
+ *   - headers: Associative array containing all mail headers.
+ *
  * @return
  *   Returns TRUE if the mail was successfully accepted for delivery,
  *   FALSE otherwise.
@@ -255,6 +255,7 @@
  * @param $allowed_tags (optional)
  *   If supplied, a list of tags that will be transformed. If omitted, all
  *   all supported tags are transformed.
+ *
  * @return
  *   The transformed string.
  */
diff -Naur drupal-6.21/includes/menu.inc drupal-6.37/includes/menu.inc
--- drupal-6.21/includes/menu.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/menu.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -49,8 +48,9 @@
  * Access to the callback functions is also protected by the menu system.
  * The "access callback" with an optional "access arguments" of each menu
  * item is called before the page callback proceeds. If this returns TRUE,
- * then access is granted; if FALSE, then access is denied. Menu items may
- * omit this attribute to use the value provided by an ancestor item.
+ * then access is granted; if FALSE, then access is denied. Default local task
+ * menu items (see next paragraph) may omit this attribute to use the value
+ * provided by the parent item.
  *
  * In the default Drupal interface, you will notice many links rendered as
  * tabs. These are known in the menu system as "local tasks", and they are
@@ -72,7 +72,7 @@
  */
 
 /**
- * @name Menu flags
+ * @defgroup menu_flags Menu flags
  * @{
  * Flags for use in the "type" attribute of menu items.
  */
@@ -90,8 +90,10 @@
  */
 
 /**
- * @name Menu item types
+ * @defgroup menu_item_types Menu item types
  * @{
+ * Definitions for various menu item types.
+ *
  * Menu item definitions provide one of these constants, which are shortcuts for
  * combinations of the above flags.
  */
@@ -135,7 +137,7 @@
  */
 
 /**
- * @name Menu status codes
+ * @defgroup menu_status_codes Menu status codes
  * @{
  * Status codes for menu callbacks.
  */
@@ -150,9 +152,9 @@
  */
 
 /**
- * @Name Menu tree parameters
+ * @defgroup menu_tree_parameters Menu tree parameters
  * @{
- * Menu tree
+ * Parameters for a menu tree.
  */
 
  /**
@@ -1000,7 +1002,7 @@
  */
 function menu_tree_check_access(&$tree, $node_links = array()) {
 
-  if ($node_links) {
+  if ($node_links && (user_access('access content') || user_access('bypass node access'))) {
     // Use db_rewrite_sql to evaluate view access without loading each full node.
     $nids = array_keys($node_links);
     $placeholders = '%d'. str_repeat(', %d', count($nids) - 1);
@@ -2471,8 +2473,16 @@
  * Returns TRUE if a path is external (e.g. http://example.com).
  */
 function menu_path_is_external($path) {
+  // Avoid calling filter_xss_bad_protocol() if there is any slash (/),
+  // hash (#) or question_mark (?) before the colon (:) occurrence - if any - as
+  // this would clearly mean it is not a URL. If the path starts with 2 slashes
+  // then it is always considered an external URL without an explicit protocol
+  // part.
   $colonpos = strpos($path, ':');
-  return $colonpos !== FALSE && !preg_match('![/?#]!', substr($path, 0, $colonpos)) && filter_xss_bad_protocol($path, FALSE) == check_plain($path);
+  return (strpos($path, '//') === 0)
+    || ($colonpos !== FALSE
+      && !preg_match('![/?#]!', substr($path, 0, $colonpos))
+      && filter_xss_bad_protocol($path, FALSE) == check_plain($path));
 }
 
 /**
diff -Naur drupal-6.21/includes/module.inc drupal-6.37/includes/module.inc
--- drupal-6.21/includes/module.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/module.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -94,6 +93,14 @@
  *   The array of filesystem objects used to rebuild the cache.
  */
 function module_rebuild_cache() {
+  $write_database = TRUE;
+  // If lock not acquired, return $files data without writing to database.
+  if (!lock_acquire('module_rebuild_cache')) {
+    $write_database = FALSE;
+    // Wait for the parallel thread to be done so we are more likely
+    // to get updated and consistent data.
+    lock_wait('module_rebuild_cache');
+  }
   // Get current list of modules
   $files = drupal_system_listing('\.module$', 'modules', 'name', 0);
 
@@ -120,32 +127,39 @@
       unset($files[$filename]);
       continue;
     }
-    // Merge in defaults and save.
-    $files[$filename]->info = $file->info + $defaults;
 
     // Invoke hook_system_info_alter() to give installed modules a chance to
     // modify the data in the .info files if necessary.
     drupal_alter('system_info', $files[$filename]->info, $files[$filename]);
 
-    // Log the critical hooks implemented by this module.
-    $bootstrap = 0;
-    foreach (bootstrap_hooks() as $hook) {
-      if (module_hook($file->name, $hook)) {
-        $bootstrap = 1;
-        break;
+    // Merge in defaults and save.
+    $files[$filename]->info = $file->info + $defaults;
+  }
+
+  // If lock not acquired, return $files data without writing to database.
+  if ($write_database) {
+    foreach ($files as $filename => $file) {
+      // Log the critical hooks implemented by this module.
+      $bootstrap = 0;
+      foreach (bootstrap_hooks() as $hook) {
+        if (module_hook($file->name, $hook)) {
+          $bootstrap = 1;
+          break;
+        }
       }
-    }
 
-    // Update the contents of the system table:
-    if (isset($file->status) || (isset($file->old_filename) && $file->old_filename != $file->filename)) {
-      db_query("UPDATE {system} SET info = '%s', name = '%s', filename = '%s', bootstrap = %d WHERE filename = '%s'", serialize($files[$filename]->info), $file->name, $file->filename, $bootstrap, $file->old_filename);
-    }
-    else {
-      // This is a new module.
-      $files[$filename]->status = 0;
-      $files[$filename]->throttle = 0;
-      db_query("INSERT INTO {system} (name, info, type, filename, status, throttle, bootstrap) VALUES ('%s', '%s', '%s', '%s', %d, %d, %d)", $file->name, serialize($files[$filename]->info), 'module', $file->filename, 0, 0, $bootstrap);
+      // Update the contents of the system table:
+      if (isset($file->status)) {
+        db_query("UPDATE {system} SET info = '%s', name = '%s', filename = '%s', bootstrap = %d WHERE filename = '%s'", serialize($files[$filename]->info), $file->name, $file->filename, $bootstrap, $file->old_filename);
+      }
+      else {
+        // This is a new module.
+        $files[$filename]->status = 0;
+        $files[$filename]->throttle = 0;
+        db_query("INSERT INTO {system} (name, info, type, filename, status, throttle, bootstrap) VALUES ('%s', '%s', '%s', '%s', %d, %d, %d)", $file->name, serialize($files[$filename]->info), 'module', $file->filename, 0, 0, $bootstrap);
+      }
     }
+    lock_release('module_rebuild_cache');
   }
   $files = _module_build_dependencies($files);
   return $files;
diff -Naur drupal-6.21/includes/pager.inc drupal-6.37/includes/pager.inc
--- drupal-6.21/includes/pager.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/pager.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -91,7 +90,7 @@
 }
 
 /**
- * Format a query pager.
+ * Returns HTML for a query pager.
  *
  * Menu callbacks that display paged query results should call theme('pager') to
  * retrieve a pager control so that users can view other results.
@@ -216,14 +215,15 @@
 
 
 /**
- * @name Pager pieces
+ * @defgroup pagerpieces Pager pieces
  * @{
- * Use these pieces to construct your own custom pagers in your theme. Note that
- * you should NOT modify this file to customize your pager.
+ * Theme functions for customizing pager elements.
+ *
+ * Note that you should NOT modify this file to customize your pager.
  */
 
 /**
- * Format a "first page" link.
+ * Returns HTML for a "first page" link.
  *
  * @param $text
  *   The name (or image) of the link.
@@ -251,7 +251,7 @@
 }
 
 /**
- * Format a "previous page" link.
+ * Returns HTML for a "previous page" link.
  *
  * @param $text
  *   The name (or image) of the link.
@@ -290,7 +290,7 @@
 }
 
 /**
- * Format a "next page" link.
+ * Returns HTML for a "next page" link.
  *
  * @param $text
  *   The name (or image) of the link.
@@ -328,7 +328,7 @@
 }
 
 /**
- * Format a "last page" link.
+ * Returns HTML for a "last page" link.
  *
  * @param $text
  *   The name (or image) of the link.
@@ -357,8 +357,13 @@
 
 
 /**
- * Format a link to a specific query result page.
+ * Returns HTML for a link to a specific query result page.
  *
+ * @param $text
+ *   The link text. Also used to figure out the title attribute of the link,
+ *   if it is not provided in $attributes['title']; in this case, $text must
+ *   be one of the standard pager link text strings that would be generated by
+ *   the pager theme functions, such as a number or t(' first').
  * @param $page_new
  *   The first result to display on the linked page.
  * @param $element
@@ -366,7 +371,7 @@
  * @param $parameters
  *   An associative array of query string parameters to append to the pager link.
  * @param $attributes
- *   An associative array of HTML attributes to apply to a pager anchor tag.
+ *   An associative array of HTML attributes to apply to the pager link.
  * @return
  *   An HTML string that generates the link.
  *
diff -Naur drupal-6.21/includes/path.inc drupal-6.37/includes/path.inc
--- drupal-6.21/includes/path.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/path.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/includes/session.inc drupal-6.37/includes/session.inc
--- drupal-6.21/includes/session.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/session.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -14,6 +13,25 @@
   return TRUE;
 }
 
+/**
+ * Reads an entire session from the database (internal use only).
+ *
+ * Also initializes the $user object for the user associated with the session.
+ * This function is registered with session_set_save_handler() to support
+ * database-backed sessions. It is called on every page load when PHP sets
+ * up the $_SESSION superglobal.
+ *
+ * This function is an internal function and must not be called directly.
+ * Doing so may result in logging out the current user, corrupting session data
+ * or other unexpected behavior. Session data must always be accessed via the
+ * $_SESSION superglobal.
+ *
+ * @param $key
+ *   The session ID of the session to retrieve.
+ *
+ * @return
+ *   The user's session, or an empty string if no session exists.
+ */
 function sess_read($key) {
   global $user;
 
@@ -23,7 +41,7 @@
   register_shutdown_function('session_write_close');
 
   // Handle the case of first time visitors and clients that don't store cookies (eg. web crawlers).
-  if (!isset($_COOKIE[session_name()])) {
+  if (empty($key) || !isset($_COOKIE[session_name()])) {
     $user = drupal_anonymous_user();
     return '';
   }
@@ -55,6 +73,24 @@
   return $user->session;
 }
 
+/**
+ * Writes an entire session to the database (internal use only).
+ *
+ * This function is registered with session_set_save_handler() to support
+ * database-backed sessions.
+ *
+ * This function is an internal function and must not be called directly.
+ * Doing so may result in corrupted session data or other unexpected behavior.
+ * Session data must always be accessed via the $_SESSION superglobal.
+ *
+ * @param $key
+ *   The session ID of the session to write to.
+ * @param $value
+ *   Session data to write as a serialized string.
+ *
+ * @return
+ *   Always returns TRUE.
+ */
 function sess_write($key, $value) {
   global $user;
 
diff -Naur drupal-6.21/includes/tablesort.inc drupal-6.37/includes/tablesort.inc
--- drupal-6.21/includes/tablesort.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/tablesort.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/includes/theme.inc drupal-6.37/includes/theme.inc
--- drupal-6.21/includes/theme.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/theme.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -12,14 +11,27 @@
  */
 
 /**
- * @name Content markers
+ * @defgroup content_flags Content markers
  * @{
  * Markers used by theme_mark() and node_mark() to designate content.
  * @see theme_mark(), node_mark()
  */
-define('MARK_READ',    0);
-define('MARK_NEW',     1);
+
+/**
+ * Mark content as read.
+ */
+define('MARK_READ', 0);
+
+/**
+ * Mark content as being new.
+ */
+define('MARK_NEW', 1);
+
+/**
+ * Mark content as being updated.
+ */
 define('MARK_UPDATED', 2);
+
 /**
  * @} End of "Content markers".
  */
@@ -511,7 +523,7 @@
 }
 
 /**
- * Generate the themed output.
+ * Generates the themed output.
  *
  * All requests for theme hooks must go through this function. It examines
  * the request and routes it to the appropriate theme function. The theme
@@ -527,14 +539,14 @@
  * functions may be used to modify the $variables array. They are processed in
  * this order when available:
  *
- * - template_preprocess(&$variables)
+ * - template_preprocess(&$variables, $hook)
  *   This sets a default set of variables for all template implementations.
  *
  * - template_preprocess_HOOK(&$variables)
  *   This is the first preprocessor called specific to the hook; it should be
  *   implemented by the module that registers it.
  *
- * - MODULE_preprocess(&$variables)
+ * - MODULE_preprocess(&$variables, $hook)
  *   This will be called for all templates; it should only be used if there
  *   is a real need. It's purpose is similar to template_preprocess().
  *
@@ -545,7 +557,7 @@
  *   preprocess function of foo_preprocess_node() can be created to intercept
  *   and alter the variable.
  *
- * - ENGINE_engine_preprocess(&$variables)
+ * - ENGINE_engine_preprocess(&$variables, $hook)
  *   This function should only be implemented by theme engines and exists
  *   so that it can set necessary variables for all hooks.
  *
@@ -553,7 +565,7 @@
  *   This is the same as the previous function, but it is called for a single
  *   theming hook.
  *
- * - ENGINE_preprocess(&$variables)
+ * - ENGINE_preprocess(&$variables, $hook)
  *   This is meant to be used by themes that utilize a theme engine. It is
  *   provided so that the preprocessor is not locked into a specific theme.
  *   This makes it easy to share and transport code but theme authors must be
@@ -569,7 +581,7 @@
  *   The same applies from the previous function, but it is called for a
  *   specific hook.
  *
- * - THEME_preprocess(&$variables)
+ * - THEME_preprocess(&$variables, $hook)
  *   These functions are based upon the raw theme; they should primarily be
  *   used by themes that do not use an engine or by sub-themes. It serves the
  *   same purpose as ENGINE_preprocess().
@@ -594,6 +606,7 @@
  *   implementations for named objects.
  * @param ...
  *   Additional arguments to pass along to the theme function.
+ * 
  * @return
  *   An HTML string that generates the themed output.
  */
@@ -1178,12 +1191,24 @@
 }
 
 /**
- * Return a themed set of links.
+ * Returns HTML for a set of links.
  *
  * @param $links
- *   A keyed array of links to be themed.
+ *   An associative array of links to be themed. The key for each link
+ *   is used as its CSS class. Each link should be itself an array, with the
+ *   following elements:
+ *   - title: The link text.
+ *   - href: The link URL. If omitted, the 'title' is shown as a plain text
+ *     item in the links list.
+ *   - html: (optional) Whether or not 'title' is HTML. If set, the title
+ *     will not be passed through check_plain().
+ *   - attributes: (optional) Attributes for the anchor, or for the <span> tag
+ *     used in its place if no 'href' is supplied.
+ *   If the 'href' element is supplied, the entire link array is passed to l()
+ *   as its $options parameter.
  * @param $attributes
- *   A keyed array of attributes
+ *   An associative array of attributes for the UL containing the list of links.
+ *
  * @return
  *   A string containing an unordered list of links.
  */
@@ -1567,7 +1592,7 @@
  *
  * @see theme_feed_icon()
  * @param $url
- *   The url of the feed.
+ *   The URL of the feed.
  */
 function theme_xml_icon($url) {
   if ($image = theme('image', 'misc/xml.png', t('XML feed'), t('XML feed'))) {
@@ -1579,7 +1604,7 @@
  * Return code that emits an feed icon.
  *
  * @param $url
- *   The url of the feed.
+ *   The URL of the feed.
  * @param $title
  *   A descriptive title of the feed.
   */
@@ -1593,7 +1618,7 @@
  * Returns code that emits the 'more' link used on blocks.
  *
  * @param $url
- *   The url of the main page
+ *   The URL of the main page
  * @param $title
  *   A descriptive verb for the link, like 'Read more'
  */
diff -Naur drupal-6.21/includes/theme.maintenance.inc drupal-6.37/includes/theme.maintenance.inc
--- drupal-6.21/includes/theme.maintenance.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/theme.maintenance.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/includes/unicode.entities.inc drupal-6.37/includes/unicode.entities.inc
--- drupal-6.21/includes/unicode.entities.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/unicode.entities.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id $
 
 /**
  * @file
diff -Naur drupal-6.21/includes/unicode.inc drupal-6.37/includes/unicode.inc
--- drupal-6.21/includes/unicode.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/unicode.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Indicates an error during check for PHP unicode support.
@@ -135,7 +134,7 @@
   }
 
   // Check for an encoding declaration in the XML prolog if no BOM was found.
-  if (!$bom && ereg('^<\?xml[^>]+encoding="([^"]+)"', $data, $match)) {
+  if (!$bom && @ereg('^<\?xml[^>]+encoding="([^"]+)"', $data, $match)) {
     $encoding = $match[1];
   }
 
@@ -145,7 +144,7 @@
     $out = drupal_convert_to_utf8($data, $encoding);
     if ($out !== FALSE) {
       $encoding = 'utf-8';
-      $data = ereg_replace('^(<\?xml[^>]+encoding)="([^"]+)"', '\\1="utf-8"', $out);
+      $data = @ereg_replace('^(<\?xml[^>]+encoding)="([^"]+)"', '\\1="utf-8"', $out);
     }
     else {
       watchdog('php', 'Could not convert XML encoding %s to UTF-8.', array('%s' => $encoding), WATCHDOG_WARNING);
diff -Naur drupal-6.21/includes/xmlrpc.inc drupal-6.37/includes/xmlrpc.inc
--- drupal-6.21/includes/xmlrpc.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/xmlrpc.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -164,7 +163,38 @@
   xml_set_element_handler($xmlrpc_message->_parser, 'xmlrpc_message_tag_open', 'xmlrpc_message_tag_close');
   xml_set_character_data_handler($xmlrpc_message->_parser, 'xmlrpc_message_cdata');
   xmlrpc_message_set($xmlrpc_message);
-  if (!xml_parse($xmlrpc_message->_parser, $xmlrpc_message->message)) {
+
+  // Strip XML declaration.
+  $header = preg_replace('/<\?xml.*?\?'.'>/s', '', substr($xmlrpc_message->message, 0, 100), 1);
+  $xml = trim(substr_replace($xmlrpc_message->message, $header, 0, 100));
+  if ($xml == '') {
+    return FALSE;
+  }
+  // Strip DTD.
+  $header = preg_replace('/^<!DOCTYPE[^>]*+>/i', '', substr($xml, 0, 200), 1);
+  $xml = trim(substr_replace($xml, $header, 0, 200));
+  if ($xml == '') {
+    return FALSE;
+  }
+  // Confirm the XML now starts with a valid root tag. A root tag can end in [> \t\r\n]
+  $root_tag = substr($xml, 0, strcspn(substr($xml, 0, 20), "> \t\r\n"));
+  // Reject a second DTD.
+  if (strtoupper($root_tag) == '<!DOCTYPE') {
+    return FALSE;
+  }
+  if (!in_array($root_tag, array('<methodCall', '<methodResponse', '<fault'))) {
+    return FALSE;
+  }
+  // Skip parsing if there is an unreasonably large number of tags.
+  // substr_count() has much better performance (compared to preg_match_all())
+  // for large payloads but is less accurate, so we check for twice the desired
+  // number of allowed tags (to take into account opening/closing tags as well
+  // as false positives).
+  if (substr_count($xml, '<') > 2 * variable_get('xmlrpc_message_maximum_tag_count', 30000)) {
+    return FALSE;
+  }
+
+  if (!xml_parse($xmlrpc_message->_parser, $xml)) {
     return FALSE;
   }
   xml_parser_free($xmlrpc_message->_parser);
diff -Naur drupal-6.21/includes/xmlrpcs.inc drupal-6.37/includes/xmlrpcs.inc
--- drupal-6.21/includes/xmlrpcs.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/includes/xmlrpcs.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * The main entry point for XML-RPC requests.
diff -Naur drupal-6.21/index.php drupal-6.37/index.php
--- drupal-6.21/index.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/index.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/install.php drupal-6.37/install.php
--- drupal-6.21/install.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/install.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 require_once './includes/install.inc';
 
@@ -131,9 +130,25 @@
     if (!$verify) {
       install_change_settings($profile, $install_locale);
     }
+    // The default lock implementation uses a database table,
+    // so we cannot use it for install, but we still need
+    // the API functions available.
+    require_once './includes/lock-install.inc';
+    $conf['lock_inc'] = './includes/lock-install.inc';
+    lock_init();
 
     // Install system.module.
     drupal_install_system();
+
+    // Ensure that all of Drupal's standard directories have appropriate
+    // .htaccess files. These directories will have already been created by
+    // this point in the installer, since Drupal creates them during the
+    // install_check_requirements() task. Note that we cannot create them any
+    // earlier than this, since the code below relies on system.module in order
+    // to work.
+    file_create_htaccess(file_directory_path());
+    file_create_htaccess(file_directory_temp());
+
     // Save the list of other modules to install for the 'profile-install'
     // task. variable_set() can be used now that system.module is installed
     // and drupal is bootstrapped.
diff -Naur drupal-6.21/misc/ahah.js drupal-6.37/misc/ahah.js
--- drupal-6.21/misc/ahah.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/ahah.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Provides AJAX-like page updating via AHAH (Asynchronous HTML and HTTP).
@@ -45,6 +44,8 @@
   this.method = element_settings.method;
   this.progress = element_settings.progress;
   this.button = element_settings.button || { };
+  this.immutable = element_settings.immutable;
+  this.buildId = null;
 
   if (this.effect == 'none') {
     this.showEffect = 'show';
@@ -77,6 +78,9 @@
     beforeSubmit: function(form_values, element_settings, options) {
       return ahah.beforeSubmit(form_values, element_settings, options);
     },
+    beforeSend: function(request, options) {
+      return ahah.beforeSend(request, options);
+    },
     success: function(response, status) {
       // Sanity check for browser support (object expected).
       // When using iFrame uploads, responses must be returned as a string.
@@ -86,6 +90,7 @@
       return ahah.success(response, status);
     },
     complete: function(response, status) {
+      ahah.complete(response, status);
       if (status == 'error' || status == 'parsererror') {
         return ahah.error(response, ahah.url);
       }
@@ -140,9 +145,29 @@
     }
     $(this.element).after(this.progress.element);
   }
+
+  // Record the build-id.
+  if (this.immutable) {
+    var ahah = this;
+    $.each(form_values, function () {
+      if (this.name == 'form_build_id') {
+        ahah.buildId = this.value;
+        return false;
+      }
+    });
+  }
 };
 
 /**
+ * Modify the request object before it is sent.
+ */
+Drupal.ahah.prototype.beforeSend = function (request, options) {
+  if (this.immutable) {
+    request.setRequestHeader('X-Drupal-Accept-Build-Id', '1');
+  }
+}
+
+/**
  * Handler for the form redirection completion.
  */
 Drupal.ahah.prototype.success = function (response, status) {
@@ -223,3 +248,19 @@
   // Re-enable the element.
   $(this.element).removeClass('progess-disabled').attr('disabled', false);
 };
+
+/**
+ * Handler called when the request finishes, whether in failure or success.
+ */
+Drupal.ahah.prototype.complete = function (response, status) {
+  // Update form build id if necessary.
+  if (this.immutable) {
+    var newBuildId = response.getResponseHeader('X-Drupal-Build-Id');
+    if (this.buildId && newBuildId && this.buildId != newBuildId) {
+      var $element = $('input[name="form_build_id"][value="' + this.buildId + '"]');
+      $element.val(newBuildId);
+      $element.attr('id', newBuildId);
+    }
+    this.buildId = null;
+  }
+}
diff -Naur drupal-6.21/misc/autocomplete.js drupal-6.37/misc/autocomplete.js
--- drupal-6.21/misc/autocomplete.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/autocomplete.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Attaches the autocomplete behavior to all required fields
@@ -254,6 +253,16 @@
   var db = this;
   this.searchString = searchString;
 
+  // See if this string needs to be searched for anyway. The pattern ../ is
+  // stripped since it may be misinterpreted by the browser.
+  searchString = searchString.replace(/^\s+|\.{2,}\/|\s+$/g, '');
+  // Skip empty search strings, or search strings ending with a comma, since
+  // that is the separator between search terms.
+  if (searchString.length <= 0 ||
+    searchString.charAt(searchString.length - 1) == ',') {
+    return;
+  }
+
   // See if this key has been searched for before
   if (this.cache[searchString]) {
     return this.owner.found(this.cache[searchString]);
diff -Naur drupal-6.21/misc/batch.js drupal-6.37/misc/batch.js
--- drupal-6.21/misc/batch.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/batch.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Attaches the batch behavior to progress bars.
diff -Naur drupal-6.21/misc/collapse.js drupal-6.37/misc/collapse.js
--- drupal-6.21/misc/collapse.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/collapse.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Toggle the visibility of a fieldset using smooth animations
diff -Naur drupal-6.21/misc/drupal.js drupal-6.37/misc/drupal.js
--- drupal-6.21/misc/drupal.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/drupal.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,26 @@
-// $Id$
+
+/**
+ * Override jQuery.fn.init to guard against XSS attacks.
+ *
+ * See http://bugs.jquery.com/ticket/9521
+ */
+(function () {
+  var jquery_init = jQuery.fn.init;
+  jQuery.fn.init = function (selector, context, rootjQuery) {
+    // If the string contains a "#" before a "<", treat it as invalid HTML.
+    if (selector && typeof selector === 'string') {
+      var hash_position = selector.indexOf('#');
+      if (hash_position >= 0) {
+        var bracket_position = selector.indexOf('<');
+        if (bracket_position > hash_position) {
+          throw 'Syntax error, unrecognized expression: ' + selector;
+        }
+      }
+    }
+    return jquery_init.call(this, selector, context, rootjQuery);
+  };
+  jQuery.fn.init.prototype = jquery_init.prototype;
+})();
 
 var Drupal = Drupal || { 'settings': {}, 'behaviors': {}, 'themes': {}, 'locale': {} };
 
@@ -150,7 +172,7 @@
   else {
     args['@count['+ index +']'] = args['@count'];
     delete args['@count'];
-    return Drupal.t(plural.replace('@count', '@count['+ index +']'));
+    return Drupal.t(plural.replace('@count', '@count['+ index +']'), args);
   }
 };
 
diff -Naur drupal-6.21/misc/farbtastic/farbtastic.css drupal-6.37/misc/farbtastic/farbtastic.css
--- drupal-6.21/misc/farbtastic/farbtastic.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/farbtastic/farbtastic.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .farbtastic {
   position: relative;
diff -Naur drupal-6.21/misc/farbtastic/farbtastic.js drupal-6.37/misc/farbtastic/farbtastic.js
--- drupal-6.21/misc/farbtastic/farbtastic.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/farbtastic/farbtastic.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 // Farbtastic 1.2
 
 jQuery.fn.farbtastic = function (callback) {
diff -Naur drupal-6.21/misc/form.js drupal-6.37/misc/form.js
--- drupal-6.21/misc/form.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/form.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 Drupal.behaviors.multiselectSelector = function() {
   // Automatically selects the right radio button in a multiselect control.
diff -Naur drupal-6.21/misc/jquery.form.js drupal-6.37/misc/jquery.form.js
--- drupal-6.21/misc/jquery.form.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/jquery.form.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /*
  * jQuery Form Plugin
diff -Naur drupal-6.21/misc/jquery.js drupal-6.37/misc/jquery.js
--- drupal-6.21/misc/jquery.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/jquery.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$ 
 
 /*
  * jQuery 1.2.6 - New Wave Javascript
diff -Naur drupal-6.21/misc/print-rtl.css drupal-6.37/misc/print-rtl.css
--- drupal-6.21/misc/print-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/print-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 body {
   direction: rtl;
diff -Naur drupal-6.21/misc/print.css drupal-6.37/misc/print.css
--- drupal-6.21/misc/print.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/print.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 body {
   margin: 1em;
diff -Naur drupal-6.21/misc/progress.js drupal-6.37/misc/progress.js
--- drupal-6.21/misc/progress.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/progress.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * A progressbar object. Initialized with the given id. Must be inserted into
diff -Naur drupal-6.21/misc/tabledrag.js drupal-6.37/misc/tabledrag.js
--- drupal-6.21/misc/tabledrag.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/tabledrag.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Drag and drop table rows with field manipulation.
@@ -1015,7 +1014,7 @@
   var siblings = new Array();
   var directions = new Array('prev', 'next');
   var rowIndentation = this.indents;
-  for (var d in directions) {
+  for (var d = 0; d < directions.length; d++) {
     var checkRow = $(this.element)[directions[d]]();
     while (checkRow.length) {
       // Check that the sibling contains a similar target field.
diff -Naur drupal-6.21/misc/tableheader.js drupal-6.37/misc/tableheader.js
--- drupal-6.21/misc/tableheader.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/tableheader.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 Drupal.tableHeaderDoScroll = function() {
   if (typeof(Drupal.tableHeaderOnScroll)=='function') {
@@ -70,7 +69,7 @@
     // Get the height of the header table and scroll up that amount.
     if (prevAnchor != location.hash) {
       if (location.hash != '') {
-        var offset = $('td' + location.hash).offset();
+        var offset = $(document).find('td' + location.hash).offset();
         if (offset) {
           var top = offset.top;
           var scrollLocation = top - $(e).height();
diff -Naur drupal-6.21/misc/tableselect.js drupal-6.37/misc/tableselect.js
--- drupal-6.21/misc/tableselect.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/tableselect.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 Drupal.behaviors.tableSelect = function (context) {
   $('form table:has(th.select-all):not(.tableSelect-processed)', context).each(Drupal.tableSelect);
diff -Naur drupal-6.21/misc/teaser.js drupal-6.37/misc/teaser.js
--- drupal-6.21/misc/teaser.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/teaser.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Auto-attach for teaser behavior.
diff -Naur drupal-6.21/misc/textarea.js drupal-6.37/misc/textarea.js
--- drupal-6.21/misc/textarea.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/misc/textarea.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 Drupal.behaviors.textarea = function(context) {
   $('textarea.resizable:not(.textarea-processed)', context).each(function() {
diff -Naur drupal-6.21/modules/aggregator/aggregator-feed-source.tpl.php drupal-6.37/modules/aggregator/aggregator-feed-source.tpl.php
--- drupal-6.21/modules/aggregator/aggregator-feed-source.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator-feed-source.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file aggregator-feed-source.tpl.php
diff -Naur drupal-6.21/modules/aggregator/aggregator-item.tpl.php drupal-6.37/modules/aggregator/aggregator-item.tpl.php
--- drupal-6.21/modules/aggregator/aggregator-item.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator-item.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file aggregator-item.tpl.php
diff -Naur drupal-6.21/modules/aggregator/aggregator-rtl.css drupal-6.37/modules/aggregator/aggregator-rtl.css
--- drupal-6.21/modules/aggregator/aggregator-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #aggregator .feed-source .feed-icon {
   float: left;
diff -Naur drupal-6.21/modules/aggregator/aggregator-summary-item.tpl.php drupal-6.37/modules/aggregator/aggregator-summary-item.tpl.php
--- drupal-6.21/modules/aggregator/aggregator-summary-item.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator-summary-item.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file aggregator-summary-item.tpl.php
diff -Naur drupal-6.21/modules/aggregator/aggregator-summary-items.tpl.php drupal-6.37/modules/aggregator/aggregator-summary-items.tpl.php
--- drupal-6.21/modules/aggregator/aggregator-summary-items.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator-summary-items.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file aggregator-summary-items.tpl.php
diff -Naur drupal-6.21/modules/aggregator/aggregator-wrapper.tpl.php drupal-6.37/modules/aggregator/aggregator-wrapper.tpl.php
--- drupal-6.21/modules/aggregator/aggregator-wrapper.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator-wrapper.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file comment-wrapper.tpl.php
diff -Naur drupal-6.21/modules/aggregator/aggregator.admin.inc drupal-6.37/modules/aggregator/aggregator.admin.inc
--- drupal-6.21/modules/aggregator/aggregator.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -27,7 +26,15 @@
   $header = array(t('Title'), t('Items'), t('Last update'), t('Next update'), array('data' => t('Operations'), 'colspan' => '3'));
   $rows = array();
   while ($feed = db_fetch_object($result)) {
-    $rows[] = array(l($feed->title, "aggregator/sources/$feed->fid"), format_plural($feed->items, '1 item', '@count items'), ($feed->checked ? t('@time ago', array('@time' => format_interval(time() - $feed->checked))) : t('never')), ($feed->checked ? t('%time left', array('%time' => format_interval($feed->checked + $feed->refresh - time()))) : t('never')), l(t('edit'), "admin/content/aggregator/edit/feed/$feed->fid"), l(t('remove items'), "admin/content/aggregator/remove/$feed->fid"), l(t('update items'), "admin/content/aggregator/update/$feed->fid"));
+    $rows[] = array(
+      l($feed->title, "aggregator/sources/$feed->fid"),
+      format_plural($feed->items, '1 item', '@count items'),
+      ($feed->checked ? t('@time ago', array('@time' => format_interval(time() - $feed->checked))) : t('never')),
+      ($feed->checked ? t('%time left', array('%time' => format_interval($feed->checked + $feed->refresh - time()))) : t('never')),
+      l(t('edit'), "admin/content/aggregator/edit/feed/$feed->fid"),
+      l(t('remove items'), "admin/content/aggregator/remove/$feed->fid"),
+      l(t('update items'), "admin/content/aggregator/update/$feed->fid", array('query' => array('token' => drupal_get_token("aggregator/update/$feed->fid")))),
+    );
   }
   $output .= theme('table', $header, $rows);
 
@@ -210,6 +217,9 @@
  *   An associative array describing the feed to be refreshed.
  */
 function aggregator_admin_refresh_feed($feed) {
+  if (!isset($_GET['token']) || !drupal_valid_token($_GET['token'], 'aggregator/update/' . $feed['fid'])) {
+    return drupal_access_denied();
+  }
   aggregator_refresh($feed);
   drupal_goto('admin/content/aggregator');
 }
diff -Naur drupal-6.21/modules/aggregator/aggregator.css drupal-6.37/modules/aggregator/aggregator.css
--- drupal-6.21/modules/aggregator/aggregator.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #aggregator .feed-source .feed-title {
   margin-top: 0;
diff -Naur drupal-6.21/modules/aggregator/aggregator.info drupal-6.37/modules/aggregator/aggregator.info
--- drupal-6.21/modules/aggregator/aggregator.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Aggregator
 description = "Aggregates syndicated content (RSS, RDF, and Atom feeds)."
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/aggregator/aggregator.install drupal-6.37/modules/aggregator/aggregator.install
--- drupal-6.21/modules/aggregator/aggregator.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/aggregator/aggregator.module drupal-6.37/modules/aggregator/aggregator.module
--- drupal-6.21/modules/aggregator/aggregator.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -299,38 +298,38 @@
  * Generates blocks for the latest news items in each category and feed.
  */
 function aggregator_block($op = 'list', $delta = 0, $edit = array()) {
-  if (user_access('access news feeds')) {
-    if ($op == 'list') {
-      $result = db_query('SELECT cid, title FROM {aggregator_category} ORDER BY title');
-      while ($category = db_fetch_object($result)) {
-        $block['category-'. $category->cid]['info'] = t('!title category latest items', array('!title' => $category->title));
-      }
-      $result = db_query('SELECT fid, title FROM {aggregator_feed} ORDER BY fid');
-      while ($feed = db_fetch_object($result)) {
-        $block['feed-'. $feed->fid]['info'] = t('!title feed latest items', array('!title' => $feed->title));
-      }
+  if ($op == 'list') {
+    $result = db_query('SELECT cid, title FROM {aggregator_category} ORDER BY title');
+    while ($category = db_fetch_object($result)) {
+      $block['category-'. $category->cid]['info'] = t('!title category latest items', array('!title' => $category->title));
+    }
+    $result = db_query('SELECT fid, title FROM {aggregator_feed} ORDER BY fid');
+    while ($feed = db_fetch_object($result)) {
+      $block['feed-'. $feed->fid]['info'] = t('!title feed latest items', array('!title' => $feed->title));
     }
-    else if ($op == 'configure') {
-      list($type, $id) = explode('-', $delta);
-      if ($type == 'category') {
-        $value = db_result(db_query('SELECT block FROM {aggregator_category} WHERE cid = %d', $id));
-      }
-      else {
-        $value = db_result(db_query('SELECT block FROM {aggregator_feed} WHERE fid = %d', $id));
-      }
-      $form['block'] = array('#type' => 'select', '#title' => t('Number of news items in block'), '#default_value' => $value, '#options' => drupal_map_assoc(array(2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20)));
-      return $form;
+  }
+  else if ($op == 'configure') {
+    list($type, $id) = explode('-', $delta);
+    if ($type == 'category') {
+      $value = db_result(db_query('SELECT block FROM {aggregator_category} WHERE cid = %d', $id));
     }
-    else if ($op == 'save') {
-      list($type, $id) = explode('-', $delta);
-      if ($type == 'category') {
-        $value = db_query('UPDATE {aggregator_category} SET block = %d WHERE cid = %d', $edit['block'], $id);
-      }
-      else {
-        $value = db_query('UPDATE {aggregator_feed} SET block = %d WHERE fid = %d', $edit['block'], $id);
-      }
+    else {
+      $value = db_result(db_query('SELECT block FROM {aggregator_feed} WHERE fid = %d', $id));
     }
-    else if ($op == 'view') {
+    $form['block'] = array('#type' => 'select', '#title' => t('Number of news items in block'), '#default_value' => $value, '#options' => drupal_map_assoc(array(2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20)));
+    return $form;
+  }
+  else if ($op == 'save') {
+    list($type, $id) = explode('-', $delta);
+    if ($type == 'category') {
+      $value = db_query('UPDATE {aggregator_category} SET block = %d WHERE cid = %d', $edit['block'], $id);
+    }
+    else {
+      $value = db_query('UPDATE {aggregator_feed} SET block = %d WHERE fid = %d', $edit['block'], $id);
+    }
+  }
+  else if ($op == 'view') {
+    if (user_access('access news feeds')) {
       list($type, $id) = explode('-', $delta);
       switch ($type) {
         case 'feed':
@@ -359,9 +358,9 @@
         $block['content'] = theme('item_list', $items) . $read_more;
       }
     }
-    if (isset($block)) {
-      return $block;
-    }
+  }
+  if (isset($block)) {
+    return $block;
   }
 }
 
@@ -752,7 +751,17 @@
     else {
       $link = $feed['link'];
     }
-    $guid = isset($item['GUID']) ? $item['GUID'] : '';
+
+    // Atom feeds use ID rather than GUID.
+    if (isset($item['GUID'])) {
+      $guid = $item['GUID'];
+    }
+    elseif (isset($item['ID'])) {
+      $guid = $item['ID'];
+    }
+    else {
+      $guid = '';
+    }
 
     // Atom feeds have a CONTENT and/or SUMMARY tag instead of a DESCRIPTION tag.
     if (!empty($item['CONTENT:ENCODED'])) {
@@ -783,6 +792,11 @@
       }
     }
 
+    // Resolve dc:creator tag as the item author if author tag is not set.
+    if (empty($item['AUTHOR']) && !empty($item['DC:CREATOR'])) {
+      $item['AUTHOR'] = $item['DC:CREATOR'];
+    }
+
     // Save this item. Try to avoid duplicate entries as much as possible. If
     // we find a duplicate entry, we resolve it and pass along its ID is such
     // that we can update it if needed.
diff -Naur drupal-6.21/modules/aggregator/aggregator.pages.inc drupal-6.37/modules/aggregator/aggregator.pages.inc
--- drupal-6.21/modules/aggregator/aggregator.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/aggregator/aggregator.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/block/block-admin-display-form.tpl.php drupal-6.37/modules/block/block-admin-display-form.tpl.php
--- drupal-6.21/modules/block/block-admin-display-form.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/block/block-admin-display-form.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file block-admin-display-form.tpl.php
diff -Naur drupal-6.21/modules/block/block.admin.inc drupal-6.37/modules/block/block.admin.inc
--- drupal-6.21/modules/block/block.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/block/block.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -386,6 +385,7 @@
       $variables['form'][$i]['region']['#attributes']['class'] = 'block-region-select block-region-'. $region;
       $variables['form'][$i]['weight']['#attributes']['class'] = 'block-weight block-weight-'. $region;
 
+      $variables['block_listing'][$region][$i] = new stdClass();
       $variables['block_listing'][$region][$i]->row_class = isset($block['#attributes']['class']) ? $block['#attributes']['class'] : '';
       $variables['block_listing'][$region][$i]->block_modified = isset($block['#attributes']['class']) && strpos($block['#attributes']['class'], 'block-modified') !== FALSE ? TRUE : FALSE;
       $variables['block_listing'][$region][$i]->block_title =  drupal_render($block['info']);
diff -Naur drupal-6.21/modules/block/block.css drupal-6.37/modules/block/block.css
--- drupal-6.21/modules/block/block.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/block/block.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #blocks td.region {
   font-weight: bold;
diff -Naur drupal-6.21/modules/block/block.info drupal-6.37/modules/block/block.info
--- drupal-6.21/modules/block/block.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/block/block.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Block
 description = Controls the boxes that are displayed around the main content.
 package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/block/block.install drupal-6.37/modules/block/block.install
--- drupal-6.21/modules/block/block.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/block/block.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_schema().
diff -Naur drupal-6.21/modules/block/block.js drupal-6.37/modules/block/block.js
--- drupal-6.21/modules/block/block.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/block/block.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Move a block in the blocks table from one region to another via select list.
diff -Naur drupal-6.21/modules/block/block.module drupal-6.37/modules/block/block.module
--- drupal-6.21/modules/block/block.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/block/block.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -224,15 +223,22 @@
 /**
  * Update the 'blocks' DB table with the blocks currently exported by modules.
  *
+ * @param $theme
+ *   The theme to rehash blocks for. If not provided, defaults to the currently
+ *   used theme.
+ *
  * @return
  *   Blocks currently exported by modules.
  */
-function _block_rehash() {
+function _block_rehash($theme = NULL) {
   global $theme_key;
 
   init_theme();
+  if (!isset($theme)) {
+    $theme = $theme_key;
+  }
 
-  $result = db_query("SELECT * FROM {blocks} WHERE theme = '%s'", $theme_key);
+  $result = db_query("SELECT * FROM {blocks} WHERE theme = '%s'", $theme);
   $old_blocks = array();
   while ($old_block = db_fetch_array($result)) {
     $old_blocks[$old_block['module']][$old_block['delta']] = $old_block;
@@ -240,7 +246,7 @@
 
   $blocks = array();
   // Valid region names for the theme.
-  $regions = system_region_list($theme_key);
+  $regions = system_region_list($theme);
 
   foreach (module_list() as $module) {
     $module_blocks = module_invoke($module, 'block', 'list');
@@ -250,7 +256,7 @@
           // If it's a new block, add identifiers.
           $block['module'] = $module;
           $block['delta']  = $delta;
-          $block['theme']  = $theme_key;
+          $block['theme']  = $theme;
           if (!isset($block['pages'])) {
             // {block}.pages is type 'text', so it cannot have a
             // default value, and not null, so we need to provide
@@ -266,9 +272,13 @@
         }
         else {
           // If it's an existing block, database settings should overwrite
-          // the code. But aside from 'info' everything that's definable in
-          // code is stored in the database and we do not store 'info', so we
-          // do not need to update the database here.
+          // the code. The only exceptions are 'cache' which is only definable
+          // and updatable in the code, and 'info' which is not stored in
+          // the database.
+          // Update the cache mode only; the other values don't need to change.
+          if (isset($block['cache']) && $block['cache'] != $old_blocks[$module][$delta]['cache']) {
+            db_query("UPDATE {blocks} SET cache = %d WHERE bid = %d", $block['cache'], $old_blocks[$module][$delta]['bid']);
+          }
           // Add 'info' to this block.
           $old_blocks[$module][$delta]['info'] = $block['info'];
           // If the region name does not exist, disable the block and assign it to none.
@@ -291,14 +301,31 @@
 
   // Remove blocks that are no longer defined by the code from the database.
   foreach ($old_blocks as $module => $old_module_blocks) {
-    foreach ($old_module_blocks as $delta => $block) {
-      db_query("DELETE FROM {blocks} WHERE module = '%s' AND delta = '%s' AND theme = '%s'", $module, $delta, $theme_key);
+    // This cleanup does not apply to disabled modules, to avoid configuration
+    // being lost when modules are disabled.
+    if (module_exists($module)) {
+      foreach ($old_module_blocks as $delta => $block) {
+        db_query("DELETE FROM {blocks} WHERE module = '%s' AND delta = '%s' AND theme = '%s'", $module, $delta, $theme);
+      }
     }
   }
   return $blocks;
 }
 
 /**
+ * Implementation of hook_flush_caches().
+ */
+function block_flush_caches() {
+  // Rehash blocks for active themes. We don't use list_themes() here,
+  // because if MAINTENANCE_MODE is defined it skips reading the database,
+  // and we can't tell which themes are active.
+  $result = db_query("SELECT name FROM {system} WHERE type = 'theme' AND status = 1");
+  while ($theme = db_result($result)) {
+    _block_rehash($theme);
+  }
+}
+
+/**
  * Returns information from database about a user-created (custom) block.
  *
  * @param $bid
@@ -414,14 +441,14 @@
  *   The name of a region.
  *
  * @return
- *   An array of block objects, indexed with <i>module</i>_<i>delta</i>.
- *   If you are displaying your blocks in one or two sidebars, you may check
- *   whether this array is empty to see how many columns are going to be
- *   displayed.
+ *   An array of block objects, indexed with module name and block delta
+ *   concatenated with an underscore, thus: MODULE_DELTA. If you are displaying
+ *   your blocks in one or two sidebars, you may check whether this array is
+ *   empty to see how many columns are going to be displayed.
  *
  * @todo
  *   Now that the blocks table has a primary key, we should use that as the
- *   array key instead of <i>module</i>_<i>delta</i>.
+ *   array key instead of MODULE_DELTA.
  */
 function block_list($region) {
   global $user, $theme_key;
diff -Naur drupal-6.21/modules/blog/blog.info drupal-6.37/modules/blog/blog.info
--- drupal-6.21/modules/blog/blog.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/blog/blog.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Blog
 description = Enables keeping easily and regularly updated user web pages or blogs.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/blog/blog.module drupal-6.37/modules/blog/blog.module
--- drupal-6.21/modules/blog/blog.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/blog/blog.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/blog/blog.pages.inc drupal-6.37/modules/blog/blog.pages.inc
--- drupal-6.21/modules/blog/blog.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/blog/blog.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -64,7 +63,7 @@
 
   $output = theme('item_list', $items);
 
-  $result = pager_query(db_rewrite_sql("SELECT n.nid, n.created FROM {node} n WHERE n.type = 'blog' AND n.status = 1 ORDER BY n.sticky DESC, n.created DESC"), variable_get('default_nodes_main', 10));
+  $result = pager_query(db_rewrite_sql("SELECT n.nid, n.sticky, n.created FROM {node} n WHERE n.type = 'blog' AND n.status = 1 ORDER BY n.sticky DESC, n.created DESC"), variable_get('default_nodes_main', 10));
   $has_posts = FALSE;
 
   while ($node = db_fetch_object($result)) {
diff -Naur drupal-6.21/modules/blogapi/blogapi.info drupal-6.37/modules/blogapi/blogapi.info
--- drupal-6.21/modules/blogapi/blogapi.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/blogapi/blogapi.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Blog API
 description = Allows users to post content using applications that support XML-RPC blog APIs.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/blogapi/blogapi.install drupal-6.37/modules/blogapi/blogapi.install
--- drupal-6.21/modules/blogapi/blogapi.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/blogapi/blogapi.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
@@ -59,7 +58,7 @@
 }
 
 /**
- * @defgroup updates-5.x-to-6.x Blog API updates from 5.x to 6.x
+ * @addtogroup updates-5.x-to-6.x
  * @{
  */
 
@@ -119,7 +118,7 @@
 }
 
 /**
- * @} End of "defgroup updates-5.x-to-6.x"
+ * @} End of "addtogroup updates-5.x-to-6.x".
  * The next series of updates should start at 7000.
  */
 
diff -Naur drupal-6.21/modules/blogapi/blogapi.module drupal-6.37/modules/blogapi/blogapi.module
--- drupal-6.21/modules/blogapi/blogapi.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/blogapi/blogapi.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/book/book-all-books-block.tpl.php drupal-6.37/modules/book/book-all-books-block.tpl.php
--- drupal-6.21/modules/book/book-all-books-block.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book-all-books-block.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file book-all-books-block.tpl.php
diff -Naur drupal-6.21/modules/book/book-export-html.tpl.php drupal-6.37/modules/book/book-export-html.tpl.php
--- drupal-6.21/modules/book/book-export-html.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book-export-html.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file book-export-html.tpl.php
diff -Naur drupal-6.21/modules/book/book-navigation.tpl.php drupal-6.37/modules/book/book-navigation.tpl.php
--- drupal-6.21/modules/book/book-navigation.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book-navigation.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file book-navigation.tpl.php
diff -Naur drupal-6.21/modules/book/book-node-export-html.tpl.php drupal-6.37/modules/book/book-node-export-html.tpl.php
--- drupal-6.21/modules/book/book-node-export-html.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book-node-export-html.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file book-node-export-html.tpl.php
diff -Naur drupal-6.21/modules/book/book-rtl.css drupal-6.37/modules/book/book-rtl.css
--- drupal-6.21/modules/book/book-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .book-navigation .page-previous {
   float: right;
diff -Naur drupal-6.21/modules/book/book.admin.inc drupal-6.37/modules/book/book.admin.inc
--- drupal-6.21/modules/book/book.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/book/book.css drupal-6.37/modules/book/book.css
--- drupal-6.21/modules/book/book.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .book-navigation .menu {
   border-top: 1px solid #888;
diff -Naur drupal-6.21/modules/book/book.info drupal-6.37/modules/book/book.info
--- drupal-6.21/modules/book/book.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/book/book.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Book
 description = Allows users to structure site pages in a hierarchy or outline.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/book/book.install drupal-6.37/modules/book/book.install
--- drupal-6.21/modules/book/book.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/book/book.module drupal-6.37/modules/book/book.module
--- drupal-6.21/modules/book/book.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -650,7 +649,7 @@
  * Appends book navigation to all nodes in the book, and handles book outline
  * insertions and updates via the node form.
  */
-function book_nodeapi(&$node, $op, $teaser, $page) {
+function book_nodeapi(&$node, $op, $teaser = NULL, $page = NULL) {
   switch ($op) {
     case 'load':
       // Note - we cannot use book_link_load() because it will call node_load()
diff -Naur drupal-6.21/modules/book/book.pages.inc drupal-6.37/modules/book/book.pages.inc
--- drupal-6.21/modules/book/book.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/book/book.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -40,6 +39,14 @@
  *   in a format determined by the $type parameter.
  */
 function book_export($type, $nid) {
+  // Check that the node exists and that the current user has access to it.
+  $node = node_load($nid);
+  if (!$node) {
+    return MENU_NOT_FOUND;
+  }
+  if (!node_access('view', $node)) {
+    return MENU_ACCESS_DENIED;
+  }
 
   $type = drupal_strtolower($type);
 
@@ -78,8 +85,11 @@
     if (isset($node->book)) {
       $tree = book_menu_subtree_data($node->book);
       $contents = book_export_traverse($tree, 'book_node_export');
+      return theme('book_export_html', $node->title, $contents, $node->book['depth']);
+    }
+    else {
+      drupal_not_found();
     }
-    return theme('book_export_html', $node->title, $contents, $node->book['depth']);
   }
   else {
     drupal_access_denied();
diff -Naur drupal-6.21/modules/color/color-rtl.css drupal-6.37/modules/color/color-rtl.css
--- drupal-6.21/modules/color/color-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/color/color-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #placeholder {
   left: 0;
diff -Naur drupal-6.21/modules/color/color.css drupal-6.37/modules/color/color.css
--- drupal-6.21/modules/color/color.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/color/color.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /* Farbtastic placement */
 .color-form {
diff -Naur drupal-6.21/modules/color/color.info drupal-6.37/modules/color/color.info
--- drupal-6.21/modules/color/color.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/color/color.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Color
 description = Allows the user to change the color scheme of certain themes.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/color/color.install drupal-6.37/modules/color/color.install
--- drupal-6.21/modules/color/color.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/color/color.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-/* $Id$ */
 
 function color_requirements($phase) {
   $requirements = array();
diff -Naur drupal-6.21/modules/color/color.js drupal-6.37/modules/color/color.js
--- drupal-6.21/modules/color/color.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/color/color.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 Drupal.behaviors.color = function (context) {
   // This behavior attaches by ID, so is only valid once on a page.
diff -Naur drupal-6.21/modules/color/color.module drupal-6.37/modules/color/color.module
--- drupal-6.21/modules/color/color.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/color/color.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_help().
diff -Naur drupal-6.21/modules/comment/comment-folded.tpl.php drupal-6.37/modules/comment/comment-folded.tpl.php
--- drupal-6.21/modules/comment/comment-folded.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment-folded.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file comment-folded.tpl.php
diff -Naur drupal-6.21/modules/comment/comment-rtl.css drupal-6.37/modules/comment/comment-rtl.css
--- drupal-6.21/modules/comment/comment-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .indented {
   margin-left: 0;
diff -Naur drupal-6.21/modules/comment/comment-wrapper.tpl.php drupal-6.37/modules/comment/comment-wrapper.tpl.php
--- drupal-6.21/modules/comment/comment-wrapper.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment-wrapper.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file comment-wrapper.tpl.php
@@ -28,7 +27,6 @@
  *   - COMMENT_CONTROLS_HIDDEN
  *
  * @see template_preprocess_comment_wrapper()
- * @see theme_comment_wrapper()
  */
 ?>
 <div id="comments">
diff -Naur drupal-6.21/modules/comment/comment.admin.inc drupal-6.37/modules/comment/comment.admin.inc
--- drupal-6.21/modules/comment/comment.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/comment/comment.css drupal-6.37/modules/comment/comment.css
--- drupal-6.21/modules/comment/comment.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .indented {
   margin-left: 25px; /* LTR */
diff -Naur drupal-6.21/modules/comment/comment.info drupal-6.37/modules/comment/comment.info
--- drupal-6.21/modules/comment/comment.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/comment/comment.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Comment
 description = Allows users to comment on and discuss published content.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/comment/comment.install drupal-6.37/modules/comment/comment.install
--- drupal-6.21/modules/comment/comment.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_enable().
@@ -67,6 +66,35 @@
   return $ret;
 }
 
+/**
+ * @addtogroup updates-6.x-extra
+ * @{
+ */
+
+/**
+ * Add index to to node_comment_statistics on comment_count
+ */
+function comment_update_6004() {
+  $ret = array();
+  db_add_index($ret, 'node_comment_statistics', 'comment_count', array('comment_count'));
+  return $ret;
+}
+
+/**
+ * Add indices to uid fields.
+ */
+function comment_update_6005() {
+  $ret = array();
+  db_add_index($ret, 'comments', 'comment_uid', array('uid'));
+  db_add_index($ret, 'node_comment_statistics', 'last_comment_uid', array('last_comment_uid'));
+  return $ret;
+}
+
+/**
+ * @} End of "addtogroup updates-6.x-extra".
+ * The next series of updates should start at 7000.
+ */
+
 
 /**
  * Implementation of hook_schema().
@@ -167,6 +195,7 @@
     'indexes' => array(
       'pid'    => array('pid'),
       'nid'    => array('nid'),
+      'comment_uid'    => array('uid'),
       'status' => array('status'), // This index is probably unused
     ),
     'primary key' => array('cid'),
@@ -210,10 +239,11 @@
     ),
     'primary key' => array('nid'),
     'indexes' => array(
-      'node_comment_timestamp' => array('last_comment_timestamp')
+      'node_comment_timestamp' => array('last_comment_timestamp'),
+      'comment_count' => array('comment_count'),
+      'last_comment_uid' => array('last_comment_uid'),
     ),
   );
 
   return $schema;
 }
-
diff -Naur drupal-6.21/modules/comment/comment.js drupal-6.37/modules/comment/comment.js
--- drupal-6.21/modules/comment/comment.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 Drupal.behaviors.comment = function (context) {
   var parts = new Array("name", "homepage", "mail");
diff -Naur drupal-6.21/modules/comment/comment.module drupal-6.37/modules/comment/comment.module
--- drupal-6.21/modules/comment/comment.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -1820,7 +1819,6 @@
  * Process variables for comment-wrapper.tpl.php.
  *
  * @see comment-wrapper.tpl.php
- * @see theme_comment_wrapper()
  */
 function template_preprocess_comment_wrapper(&$variables) {
   // Provide contextual information.
diff -Naur drupal-6.21/modules/comment/comment.pages.inc drupal-6.37/modules/comment/comment.pages.inc
--- drupal-6.21/modules/comment/comment.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/comment/comment.tpl.php drupal-6.37/modules/comment/comment.tpl.php
--- drupal-6.21/modules/comment/comment.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/comment/comment.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file comment.tpl.php
diff -Naur drupal-6.21/modules/contact/contact.admin.inc drupal-6.37/modules/contact/contact.admin.inc
--- drupal-6.21/modules/contact/contact.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/contact/contact.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/contact/contact.info drupal-6.37/modules/contact/contact.info
--- drupal-6.21/modules/contact/contact.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/contact/contact.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Contact
 description = Enables the use of both personal and site-wide contact forms.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/contact/contact.install drupal-6.37/modules/contact/contact.install
--- drupal-6.21/modules/contact/contact.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/contact/contact.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/contact/contact.module drupal-6.37/modules/contact/contact.module
--- drupal-6.21/modules/contact/contact.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/contact/contact.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/contact/contact.pages.inc drupal-6.37/modules/contact/contact.pages.inc
--- drupal-6.21/modules/contact/contact.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/contact/contact.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/dblog/dblog-rtl.css drupal-6.37/modules/dblog/dblog-rtl.css
--- drupal-6.21/modules/dblog/dblog-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/dblog/dblog-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #edit-type-wrapper, #edit-severity-wrapper {
   float: right;
diff -Naur drupal-6.21/modules/dblog/dblog.admin.inc drupal-6.37/modules/dblog/dblog.admin.inc
--- drupal-6.21/modules/dblog/dblog.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/dblog/dblog.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -80,7 +79,7 @@
         format_date($dblog->timestamp, 'small'),
         l(truncate_utf8(_dblog_format_message($dblog), 56, TRUE, TRUE), 'admin/reports/event/'. $dblog->wid, array('html' => TRUE)),
         theme('username', $dblog),
-        $dblog->link,
+        filter_xss($dblog->link),
       ),
       // Attributes for tr
       'class' => "dblog-". preg_replace('/[^a-z]/i', '-', $dblog->type) .' '. $classes[$dblog->severity]
diff -Naur drupal-6.21/modules/dblog/dblog.css drupal-6.37/modules/dblog/dblog.css
--- drupal-6.21/modules/dblog/dblog.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/dblog/dblog.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #edit-type-wrapper, #edit-severity-wrapper {
   float: left; /* LTR */
diff -Naur drupal-6.21/modules/dblog/dblog.info drupal-6.37/modules/dblog/dblog.info
--- drupal-6.21/modules/dblog/dblog.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/dblog/dblog.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Database logging
 description = Logs and records system events to the database.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/dblog/dblog.install drupal-6.37/modules/dblog/dblog.install
--- drupal-6.21/modules/dblog/dblog.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/dblog/dblog.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
@@ -101,7 +100,7 @@
 }
 
 /**
- * @defgroup updates-6.x-extra Extra database logging updates for 6.x
+ * @addtogroup updates-6.x-extra
  * @{
  */
 
@@ -115,6 +114,6 @@
 }
 
 /**
- * @} End of "defgroup updates-6.x-extra"
+ * @} End of "addtogroup updates-6.x-extra".
  * The next series of updates should start at 7000.
  */
diff -Naur drupal-6.21/modules/dblog/dblog.module drupal-6.37/modules/dblog/dblog.module
--- drupal-6.21/modules/dblog/dblog.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/dblog/dblog.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -98,7 +97,7 @@
 /**
  * Implementation of hook_cron().
  *
- * Remove expired log messages and flood control events.
+ * Remove expired log messages.
  */
 function dblog_cron() {
   // Cleanup the watchdog table
diff -Naur drupal-6.21/modules/filter/filter.admin.inc drupal-6.37/modules/filter/filter.admin.inc
--- drupal-6.21/modules/filter/filter.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/filter/filter.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/filter/filter.info drupal-6.37/modules/filter/filter.info
--- drupal-6.21/modules/filter/filter.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/filter/filter.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Filter
 description = Handles the filtering of content in preparation for display.
 package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/filter/filter.install drupal-6.37/modules/filter/filter.install
--- drupal-6.21/modules/filter/filter.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/filter/filter.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_schema().
diff -Naur drupal-6.21/modules/filter/filter.module drupal-6.37/modules/filter/filter.module
--- drupal-6.21/modules/filter/filter.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/filter/filter.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -397,10 +396,9 @@
 }
 
 /**
- * @name Filtering functions
+ * @defgroup filtering_functions Filtering functions
  * @{
- * Modules which need to have content filtered can use these functions to
- * interact with the filter system.
+ * Functions for interacting with the content filtering system.
  *
  * For more info, see the hook_filter() documentation.
  *
@@ -604,19 +602,20 @@
 }
 
 /**
- * @name Standard filters
+ * @defgroup standard_filters Standard filters
  * @{
  * Filters implemented by the filter.module.
  */
 
 /**
- * Implementation of hook_filter(). Contains a basic set of essential filters.
- * - HTML filter:
- *     Validates user-supplied HTML, transforming it as necessary.
- * - Line break converter:
- *     Converts newlines into paragraph and break tags.
- * - URL and e-mail address filter:
- *     Converts newlines into paragraph and break tags.
+ * Implementation of hook_filter().
+ *
+ * Sets up a basic set of essential filters.
+ * - HTML filter: Restricts user-supplied HTML to certain tags, and removes
+ *   dangerous components in allowed tags.
+ * - Line break converter: Converts newlines into paragraph and break tags.
+ * - URL filter: Converts URLs and e-mail addresses into links.
+ * - HTML corrector: Fixes faulty HTML.
  */
 function filter_filter($op, $delta = 0, $format = -1, $text = '') {
   switch ($op) {
@@ -747,7 +746,7 @@
 
 /**
  * URL filter. Automatically converts text web addresses (URLs, e-mail addresses,
- * ftp links, etc.) into hyperlinks.
+ * FTP links, etc.) into hyperlinks.
  */
 function _filter_url($text, $format) {
   // Pass length to regexp callback
diff -Naur drupal-6.21/modules/filter/filter.pages.inc drupal-6.37/modules/filter/filter.pages.inc
--- drupal-6.21/modules/filter/filter.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/filter/filter.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/forum/forum-icon.tpl.php drupal-6.37/modules/forum/forum-icon.tpl.php
--- drupal-6.21/modules/forum/forum-icon.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum-icon.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file forum-icon.tpl.php
diff -Naur drupal-6.21/modules/forum/forum-list.tpl.php drupal-6.37/modules/forum/forum-list.tpl.php
--- drupal-6.21/modules/forum/forum-list.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum-list.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file forum-list.tpl.php
diff -Naur drupal-6.21/modules/forum/forum-rtl.css drupal-6.37/modules/forum/forum-rtl.css
--- drupal-6.21/modules/forum/forum-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #forum tr td.forum {
   padding-left: 0.5em;
diff -Naur drupal-6.21/modules/forum/forum-submitted.tpl.php drupal-6.37/modules/forum/forum-submitted.tpl.php
--- drupal-6.21/modules/forum/forum-submitted.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum-submitted.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file forum-submitted.tpl.php
diff -Naur drupal-6.21/modules/forum/forum-topic-list.tpl.php drupal-6.37/modules/forum/forum-topic-list.tpl.php
--- drupal-6.21/modules/forum/forum-topic-list.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum-topic-list.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file forum-topic-list.tpl.php
diff -Naur drupal-6.21/modules/forum/forum-topic-navigation.tpl.php drupal-6.37/modules/forum/forum-topic-navigation.tpl.php
--- drupal-6.21/modules/forum/forum-topic-navigation.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum-topic-navigation.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file forum-topic-navigation.tpl.php
diff -Naur drupal-6.21/modules/forum/forum.admin.inc drupal-6.37/modules/forum/forum.admin.inc
--- drupal-6.21/modules/forum/forum.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/forum/forum.css drupal-6.37/modules/forum/forum.css
--- drupal-6.21/modules/forum/forum.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #forum .description {
   font-size: 0.9em;
diff -Naur drupal-6.21/modules/forum/forum.info drupal-6.37/modules/forum/forum.info
--- drupal-6.21/modules/forum/forum.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/forum/forum.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,4 +1,3 @@
-; $Id$
 name = Forum
 description = Enables threaded discussions about general topics.
 dependencies[] = taxonomy
@@ -7,8 +6,8 @@
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/forum/forum.install drupal-6.37/modules/forum/forum.install
--- drupal-6.21/modules/forum/forum.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/forum/forum.module drupal-6.37/modules/forum/forum.module
--- drupal-6.21/modules/forum/forum.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -166,7 +165,7 @@
 /**
  * Implementation of hook_nodeapi().
  */
-function forum_nodeapi(&$node, $op, $teaser, $page) {
+function forum_nodeapi(&$node, $op, $teaser = NULL, $page = NULL) {
   // We are going to return if $node->type is not one of the node
   // types assigned to the forum vocabulary.  If forum_nav_vocabulary
   // is undefined or the vocabulary does not exist, it clearly cannot
@@ -495,11 +494,31 @@
   $_forums = taxonomy_get_tree($vid, $tid);
 
   if (count($_forums)) {
-
-    $counts = array();
-
-    $sql = "SELECT r.tid, COUNT(n.nid) AS topic_count, SUM(l.comment_count) AS comment_count FROM {node} n INNER JOIN {node_comment_statistics} l ON n.nid = l.nid INNER JOIN {term_node} r ON n.vid = r.vid WHERE n.status = 1 GROUP BY r.tid";
-    $sql = db_rewrite_sql($sql);
+  $counts = array();
+    $sql = "
+      SELECT r.tid AS tid, n.nid AS nid, l.comment_count AS nid_comment_count
+        FROM {node} n
+        INNER JOIN {node_comment_statistics} l ON n.nid = l.nid
+        INNER JOIN {term_node} r ON n.vid = r.vid
+        WHERE n.status = 1
+        GROUP BY r.tid, n.nid, l.comment_count";
+    $sql_rewritten = db_rewrite_sql($sql);
+    if ($sql_rewritten == $sql) {
+      $sql = "
+        SELECT r.tid, COUNT(n.nid) AS topic_count, SUM(l.comment_count) AS comment_count
+          FROM {node} n
+          INNER JOIN {node_comment_statistics} l ON n.nid = l.nid
+          INNER JOIN {term_node} r ON n.vid = r.vid
+          WHERE n.status = 1
+          GROUP BY r.tid";
+      $sql = db_rewrite_sql($sql);
+    }
+    else {
+      $sql = "
+        SELECT tid, COUNT(nid) AS topic_count, SUM(nid_comment_count) AS comment_count
+          FROM ($sql_rewritten) AS forum_content_list
+          GROUP BY tid";
+    }
     $_counts = db_query($sql);
     while ($count = db_fetch_object($_counts)) {
       $counts[$count->tid] = $count;
@@ -546,7 +565,7 @@
  * than NODE_NEW_LIMIT.
  */
 function _forum_topics_unread($term, $uid) {
-  $sql = "SELECT COUNT(n.nid) FROM {node} n INNER JOIN {term_node} tn ON n.vid = tn.vid AND tn.tid = %d LEFT JOIN {history} h ON n.nid = h.nid AND h.uid = %d WHERE n.status = 1 AND n.created > %d AND h.nid IS NULL";
+  $sql = "SELECT COUNT(DISTINCT n.nid) FROM {node} n INNER JOIN {term_node} tn ON n.vid = tn.vid AND tn.tid = %d LEFT JOIN {history} h ON n.nid = h.nid AND h.uid = %d WHERE n.status = 1 AND n.created > %d AND h.nid IS NULL";
   $sql = db_rewrite_sql($sql);
   return db_result(db_query($sql, $term, $uid, NODE_NEW_LIMIT));
 }
@@ -575,7 +594,7 @@
   $sql .= tablesort_sql($forum_topic_list_header, 'n.sticky DESC,');
   $sql .= ', n.created DESC';  // Always add a secondary sort order so that the news forum topics are on top.
 
-  $sql_count = db_rewrite_sql("SELECT COUNT(n.nid) FROM {node} n INNER JOIN {term_node} r ON n.vid = r.vid AND r.tid = %d WHERE n.status = 1");
+  $sql_count = db_rewrite_sql("SELECT COUNT(DISTINCT n.nid) FROM {node} n INNER JOIN {term_node} r ON n.vid = r.vid AND r.tid = %d WHERE n.status = 1");
 
   $result = pager_query($sql, $forum_per_page, 0, $sql_count, $tid);
   $topics = array();
@@ -671,7 +690,7 @@
       // Check if the current user has the 'create' permission for this node type.
       if (node_access('create', $type)) {
         // Fetch the "General" name of the content type;
-        // Push the link with title and url to the array.
+        // Push the link with title and URL to the array.
         $forum_types[$type] = array('title' => t('Post new @node_type', array('@node_type' => node_get_types('name', $type))), 'href' => 'node/add/'. str_replace('_', '-', $type) .'/'. $variables['tid']);
       }
     }
diff -Naur drupal-6.21/modules/forum/forum.pages.inc drupal-6.37/modules/forum/forum.pages.inc
--- drupal-6.21/modules/forum/forum.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forum.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/forum/forums.tpl.php drupal-6.37/modules/forum/forums.tpl.php
--- drupal-6.21/modules/forum/forums.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/forum/forums.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file forums.tpl.php
diff -Naur drupal-6.21/modules/help/help-rtl.css drupal-6.37/modules/help/help-rtl.css
--- drupal-6.21/modules/help/help-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/help/help-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .help-items {
   float: right;
diff -Naur drupal-6.21/modules/help/help.admin.inc drupal-6.37/modules/help/help.admin.inc
--- drupal-6.21/modules/help/help.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/help/help.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/help/help.css drupal-6.37/modules/help/help.css
--- drupal-6.21/modules/help/help.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/help/help.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .help-items {
   float: left; /* LTR */
diff -Naur drupal-6.21/modules/help/help.info drupal-6.37/modules/help/help.info
--- drupal-6.21/modules/help/help.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/help/help.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Help
 description = Manages the display of online help.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/help/help.module drupal-6.37/modules/help/help.module
--- drupal-6.21/modules/help/help.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/help/help.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/locale/locale.css drupal-6.37/modules/locale/locale.css
--- drupal-6.21/modules/locale/locale.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/locale/locale.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .locale-untranslated {
   font-style: normal;
diff -Naur drupal-6.21/modules/locale/locale.info drupal-6.37/modules/locale/locale.info
--- drupal-6.21/modules/locale/locale.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/locale/locale.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Locale
 description = Adds language handling functionality and enables the translation of the user interface to languages other than English.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/locale/locale.install drupal-6.37/modules/locale/locale.install
--- drupal-6.21/modules/locale/locale.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/locale/locale.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
@@ -16,7 +15,7 @@
 }
 
 /**
- * @defgroup updates-5.x-to-6.x Locale updates from 5.x to 6.x
+ * @addtogroup updates-5.x-to-6.x
  * @{
  */
 
@@ -222,7 +221,26 @@
 }
 
 /**
- * @} End of "defgroup updates-5.x-to-6.x"
+ * @} End of "addtogroup updates-5.x-to-6.x".
+ */
+
+/**
+ * @addtogroup updates-6.x-extra
+ * @{
+ */
+
+/**
+ * Fix Drupal.formatPlural().
+ */
+function locale_update_6007() {
+  drupal_load('module', 'locale');
+  locale_inc_callback('_locale_invalidate_js');
+  return array();
+}
+
+/**
+ * @} End of "addtogroup updates-6.x-extra".
+ * The next series of updates should start at 7000.
  */
 
 /**
diff -Naur drupal-6.21/modules/locale/locale.module drupal-6.37/modules/locale/locale.module
--- drupal-6.21/modules/locale/locale.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/locale/locale.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/menu/menu.admin.inc drupal-6.37/modules/menu/menu.admin.inc
--- drupal-6.21/modules/menu/menu.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/menu/menu.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -410,7 +409,7 @@
     $form['menu_name'] = array(
       '#type' => 'textfield',
       '#title' => t('Menu name'),
-      '#maxsize' => MENU_MAX_MENU_NAME_LENGTH_UI,
+      '#maxlength' => MENU_MAX_MENU_NAME_LENGTH_UI,
       '#description' => t('The machine-readable name of this menu. This text will be used for constructing the URL of the <em>menu overview</em> page for this menu. This name must contain only lowercase letters, numbers, and hyphens, and must be unique.'),
       '#required' => TRUE,
     );
@@ -510,9 +509,6 @@
   if (preg_match('/[^a-z0-9-]/', $item['menu_name'])) {
     form_set_error('menu_name', t('The menu name may only consist of lowercase letters, numbers, and hyphens.'));
   }
-  if (strlen($item['menu_name']) > MENU_MAX_MENU_NAME_LENGTH_UI) {
-    form_set_error('menu_name', format_plural(MENU_MAX_MENU_NAME_LENGTH_UI, "The menu name can't be longer than 1 character.", "The menu name can't be longer than @count characters."));
-  }
   if ($form['#insert']) {
     // We will add 'menu-' to the menu name to help avoid name-space conflicts.
     $item['menu_name'] = 'menu-'. $item['menu_name'];
diff -Naur drupal-6.21/modules/menu/menu.info drupal-6.37/modules/menu/menu.info
--- drupal-6.21/modules/menu/menu.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/menu/menu.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Menu
 description = Allows administrators to customize the site navigation menu.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/menu/menu.install drupal-6.37/modules/menu/menu.install
--- drupal-6.21/modules/menu/menu.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/menu/menu.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/menu/menu.module drupal-6.37/modules/menu/menu.module
--- drupal-6.21/modules/menu/menu.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/menu/menu.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -46,7 +45,7 @@
 function menu_menu() {
   $items['admin/build/menu'] = array(
     'title' => 'Menus',
-    'description' => "Control your site's navigation menu, primary links and secondary links. as well as rename and reorganize menu items.",
+    'description' => "Control your site's navigation menu, primary links and secondary links, as well as rename and reorganize menu items.",
     'page callback' => 'menu_overview_page',
     'access callback' => 'user_access',
     'access arguments' => array('administer menu'),
@@ -274,7 +273,6 @@
   if ($op == 'list') {
     $blocks = array();
     foreach ($menus as $name => $title) {
-      // Default "Navigation" block is handled by user.module.
       $blocks[$name]['info'] = check_plain($title);
       // Menu blocks can't be cached because each menu item can have
       // a custom access callback. menu.inc manages its own caching.
diff -Naur drupal-6.21/modules/node/content_types.inc drupal-6.37/modules/node/content_types.inc
--- drupal-6.21/modules/node/content_types.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/node/content_types.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/node/node-rtl.css drupal-6.37/modules/node/node-rtl.css
--- drupal-6.21/modules/node/node-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/node/node-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #node-admin-buttons {
   float: right;
diff -Naur drupal-6.21/modules/node/node.admin.inc drupal-6.37/modules/node/node.admin.inc
--- drupal-6.21/modules/node/node.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/node/node.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -182,7 +181,7 @@
       case 'category':
         $table = "tn$index";
         $where[] = "$table.tid = %d";
-        $join .= "INNER JOIN {term_node} $table ON n.nid = $table.nid ";
+        $join .= "INNER JOIN {term_node} $table ON n.vid = $table.vid ";
         break;
       case 'type':
         $where[] = "n.type = '%s'";
diff -Naur drupal-6.21/modules/node/node.css drupal-6.37/modules/node/node.css
--- drupal-6.21/modules/node/node.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/node/node.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .node-unpublished {
   background-color: #fff4f4;
diff -Naur drupal-6.21/modules/node/node.info drupal-6.37/modules/node/node.info
--- drupal-6.21/modules/node/node.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/node/node.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Node
 description = Allows content to be submitted to the site and displayed on pages.
 package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/node/node.install drupal-6.37/modules/node/node.install
--- drupal-6.21/modules/node/node.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/node/node.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_schema().
diff -Naur drupal-6.21/modules/node/node.module drupal-6.37/modules/node/node.module
--- drupal-6.21/modules/node/node.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/node/node.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -398,23 +397,30 @@
 }
 
 /**
- * Builds a list of available node types, and returns all of part of this list
- * in the specified format.
+ * Builds a list of available node types, and returns all or part of this list.
  *
  * @param $op
- *   The format in which to return the list. When this is set to 'type',
- *   'module', or 'name', only the specified node type is returned. When set to
- *   'types' or 'names', all node types are returned.
+ *   The format in which to return the list: 'type', 'types', 'module', 'name',
+ *   or 'names'. See return value section below for details.
  * @param $node
- *   A node object, array, or string that indicates the node type to return.
- *   Leave at default value (NULL) to return a list of all node types.
+ *   A node object, an array representation of a node object, or a node type
+ *   name string. See return value section below for details.
  * @param $reset
  *   Whether or not to reset this function's internal cache (defaults to
  *   FALSE).
  *
  * @return
- *   Either an array of all available node types, or a single node type, in a
- *   variable format. Returns FALSE if the node type is not found.
+ *   If $node is supplied and it doesn't correspond to a known node type,
+ *   or if $op is 'type', 'name', or 'module' and $node is not given, the
+ *   function returns FALSE. Otherwise, the return value depends on the
+ *   value of $op:
+ *   - 'types': An array of all available node type objects, keyed by machine
+ *     name.
+ *   - 'type': The single node type object indicated by $node.
+ *   - 'names': An array of the display names of all available node types,
+ *     keyed by machine name and sorted by display name.
+ *   - 'name': The single node type display name indicated by $node.
+ *   - 'module': The name of the node type module indicated by $node.
  */
 function node_get_types($op = 'types', $node = NULL, $reset = FALSE) {
   static $_node_types, $_node_names;
@@ -788,7 +794,7 @@
   // Make sure the body has the minimum number of words.
   // TODO : use a better word counting algorithm that will work in other languages
   if (!empty($type->min_word_count) && isset($node->body) && count(explode(' ', $node->body)) < $type->min_word_count) {
-    form_set_error('body', t('The body of your @type is too short. You need at least %words words.', array('%words' => $type->min_word_count, '@type' => $type->name)));
+    form_set_error('body', t('The @body_label of your @type is too short. You need at least %words words.', array('@body_label' => $type->body_label, '@type' => $type->name, '%words' => $type->min_word_count)));
   }
 
   if (isset($node->nid) && (node_last_changed($node->nid) > $node->changed)) {
@@ -974,6 +980,7 @@
   if (node_access('delete', $node)) {
     db_query('DELETE FROM {node} WHERE nid = %d', $node->nid);
     db_query('DELETE FROM {node_revisions} WHERE nid = %d', $node->nid);
+    db_query('DELETE FROM {node_access} WHERE nid = %d', $node->nid);
 
     // Call the node-specific callback (if any):
     node_invoke($node, 'delete');
@@ -1069,8 +1076,8 @@
  *   Whether the node is being displayed by itself as a page.
  *
  * @return
- *   An structured array containing the individual elements
- *   of the node's body.
+ *   A node object with its content property set to a structured array
+ *   containing the individual elements of the node's body.
  */
 function node_build_content($node, $teaser = FALSE, $page = FALSE) {
 
@@ -1625,7 +1632,7 @@
  */
 function node_revision_list($node) {
   $revisions = array();
-  $result = db_query('SELECT r.vid, r.title, r.log, r.uid, n.vid AS current_vid, r.timestamp, u.name FROM {node_revisions} r LEFT JOIN {node} n ON n.vid = r.vid INNER JOIN {users} u ON u.uid = r.uid WHERE r.nid = %d ORDER BY r.timestamp DESC', $node->nid);
+  $result = db_query('SELECT r.vid, r.title, r.log, r.uid, n.vid AS current_vid, r.timestamp, u.name FROM {node_revisions} r LEFT JOIN {node} n ON n.vid = r.vid INNER JOIN {users} u ON u.uid = r.uid WHERE r.nid = %d ORDER BY r.vid DESC', $node->nid);
   while ($revision = db_fetch_object($result)) {
     $revisions[$revision->vid] = $revision;
   }
diff -Naur drupal-6.21/modules/node/node.pages.inc drupal-6.37/modules/node/node.pages.inc
--- drupal-6.21/modules/node/node.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/node/node.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -15,6 +14,9 @@
   return drupal_get_form($node->type .'_node_form', $node);
 }
 
+/**
+ * Page callback: Displays add content links for available content types.
+ */
 function node_add_page() {
   $item = menu_get_item();
   $content = system_admin_menu_block($item);
diff -Naur drupal-6.21/modules/node/node.tpl.php drupal-6.37/modules/node/node.tpl.php
--- drupal-6.21/modules/node/node.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/node/node.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file node.tpl.php
@@ -16,7 +15,7 @@
  * - $links: Themed links like "Read more", "Add new comment", etc. output
  *   from theme_links().
  * - $name: Themed username of node author output from theme_username().
- * - $node_url: Direct url of the current node.
+ * - $node_url: Direct URL of the current node.
  * - $terms: the themed list of taxonomy term links output from theme_links().
  * - $submitted: themed submission information output from
  *   theme_node_submitted().
diff -Naur drupal-6.21/modules/openid/openid.css drupal-6.37/modules/openid/openid.css
--- drupal-6.21/modules/openid/openid.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/openid/openid.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #edit-openid-identifier {
   background-image: url("login-bg.png");
diff -Naur drupal-6.21/modules/openid/openid.inc drupal-6.37/modules/openid/openid.inc
--- drupal-6.21/modules/openid/openid.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/openid/openid.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -362,7 +361,7 @@
   }
 
   do {
-    $bytes = "\x00". _openid_get_bytes($nbytes);
+    $bytes = "\x00". drupal_random_bytes($nbytes);
     $n = _openid_dh_binary_to_long($bytes);
     // Keep looping if this value is in the low duplicated range.
   } while (bccomp($n, $duplicate) < 0);
@@ -371,23 +370,7 @@
 }
 
 function _openid_get_bytes($num_bytes) {
-  static $f = null;
-  $bytes = '';
-  if (!isset($f)) {
-    $f = @fopen(OPENID_RAND_SOURCE, "r");
-  }
-  if (!$f) {
-    // pseudorandom used
-    $bytes = '';
-    for ($i = 0; $i < $num_bytes; $i += 4) {
-      $bytes .= pack('L', mt_rand());
-    }
-    $bytes = substr($bytes, 0, $num_bytes);
-  }
-  else {
-    $bytes = fread($f, $num_bytes);
-  }
-  return $bytes;
+  return drupal_random_bytes($num_bytes);
 }
 
 function _openid_response($str = NULL) {
diff -Naur drupal-6.21/modules/openid/openid.info drupal-6.37/modules/openid/openid.info
--- drupal-6.21/modules/openid/openid.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/openid/openid.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = OpenID
 description = "Allows users to log into your site using OpenID."
 version = VERSION
 package = Core - optional
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/openid/openid.install drupal-6.37/modules/openid/openid.install
--- drupal-6.21/modules/openid/openid.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/openid/openid.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
@@ -27,13 +26,14 @@
       'idp_endpoint_uri' => array(
         'type' => 'varchar',
         'length' => 255,
-        'description' => 'URI of the OpenID Provider endpoint.',
+        'not null' => TRUE,
+        'description' => 'Primary Key: URI of the OpenID Provider endpoint.',
       ),
       'assoc_handle' => array(
         'type' => 'varchar',
         'length' => 255,
         'not null' => TRUE,
-        'description' => 'Primary Key: Used to refer to this association in subsequent messages.',
+        'description' => 'Used to refer to this association in subsequent messages.',
       ),
       'assoc_type' => array(
         'type' => 'varchar',
@@ -63,7 +63,10 @@
         'description' => 'The lifetime, in seconds, of this association.',
       ),
     ),
-    'primary key' => array('assoc_handle'),
+    'primary key' => array('idp_endpoint_uri'),
+    'unique keys' => array(
+      'assoc_handle' => array('assoc_handle'),
+    ),
   );
 
   $schema['openid_nonce'] = array(
@@ -96,7 +99,7 @@
 }
 
 /**
- * @defgroup updates-6.x-extra Extra openid updates for 6.x
+ * @addtogroup updates-6.x-extra
  * @{
  */
 
@@ -140,6 +143,68 @@
 }
 
 /**
- * @} End of "defgroup updates-6.x-extra"
+ * Bind associations to their providers.
+ */
+function openid_update_6001() {
+  $ret = array();
+
+  db_drop_table($ret, 'openid_association');
+
+  $schema['openid_association'] = array(
+    'description' => 'Stores temporary shared key association information for OpenID authentication.',
+    'fields' => array(
+      'idp_endpoint_uri' => array(
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'description' => 'Primary Key: URI of the OpenID Provider endpoint.',
+      ),
+      'assoc_handle' => array(
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'description' => 'Used to refer to this association in subsequent messages.',
+      ),
+      'assoc_type' => array(
+        'type' => 'varchar',
+        'length' => 32,
+        'description' => 'The signature algorithm used: one of HMAC-SHA1 or HMAC-SHA256.',
+      ),
+      'session_type' => array(
+        'type' => 'varchar',
+        'length' => 32,
+        'description' => 'Valid association session types: "no-encryption", "DH-SHA1", and "DH-SHA256".',
+      ),
+      'mac_key' => array(
+        'type' => 'varchar',
+        'length' => 255,
+        'description' => 'The MAC key (shared secret) for this association.',
+      ),
+      'created' => array(
+        'type' => 'int',
+        'not null' => TRUE,
+        'default' => 0,
+        'description' => 'UNIX timestamp for when the association was created.',
+      ),
+      'expires_in' => array(
+        'type' => 'int',
+        'not null' => TRUE,
+        'default' => 0,
+        'description' => 'The lifetime, in seconds, of this association.',
+      ),
+    ),
+    'primary key' => array('idp_endpoint_uri'),
+    'unique keys' => array(
+      'assoc_handle' => array('assoc_handle'),
+    ),
+  );
+
+  db_create_table($ret, 'openid_association', $schema['openid_association']);
+
+  return $ret;
+}
+
+/**
+ * @} End of "addtogroup updates-6.x-extra".
  * The next series of updates should start at 7000.
  */
diff -Naur drupal-6.21/modules/openid/openid.js drupal-6.37/modules/openid/openid.js
--- drupal-6.21/modules/openid/openid.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/openid/openid.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 Drupal.behaviors.openid = function (context) {
   var $loginElements = $("#edit-name-wrapper, #edit-pass-wrapper, li.openid-link");
diff -Naur drupal-6.21/modules/openid/openid.module drupal-6.37/modules/openid/openid.module
--- drupal-6.21/modules/openid/openid.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/openid/openid.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -242,10 +241,34 @@
         if (openid_verify_assertion($service, $response)) {
           // If the returned claimed_id is different from the session claimed_id,
           // then we need to do discovery and make sure the op_endpoint matches.
-          if ($service['version'] == 2 && $response['openid.claimed_id'] != $claimed_id) {
-            $disco = openid_discovery($response['openid.claimed_id']);
-            if ($disco[0]['uri'] != $service['uri']) {
-              return $response;
+          if ($service['version'] == 2) {
+            // Returned Claimed Identifier could contain unique fragment
+            // identifier to allow identifier recycling so we need to preserve
+            // it in the response.
+            $response_claimed_id = _openid_normalize($response['openid.claimed_id']);
+
+            if ($response_claimed_id != $claimed_id || $response_claimed_id != $response['openid.identity']) {
+              $disco = openid_discovery($response['openid.claimed_id']);
+
+              if ($disco[0]['uri'] != $service['uri']) {
+                return $response;
+              }
+
+              if (!empty($disco[0]['localid'])) {
+                $identity = $disco[0]['localid'];
+              }
+              else if (!empty($disco[0]['delegate'])) {
+                $identity = $disco[0]['delegate'];
+              }
+              else {
+                $identity = FALSE;
+              }
+
+              // The OP-Local Identifier (if different than the Claimed
+              // Identifier) must be present in the XRDS document.
+              if ($response_claimed_id != $response['openid.identity'] && (!$identity || $identity != $response['openid.identity'])) {
+                return $response;
+              }
             }
           }
           else {
@@ -426,14 +449,17 @@
   elseif (variable_get('user_register', 1)) {
     // Register new user
     $form_state['redirect'] = NULL;
-    $form_state['values']['name'] = (empty($response['openid.sreg.nickname'])) ? '' : $response['openid.sreg.nickname'];
-    $form_state['values']['mail'] = (empty($response['openid.sreg.email'])) ? '' : $response['openid.sreg.email'];
+    // Only signed SREG keys are included as required by OpenID Simple
+    // Registration Extension 1.0, section 4.
+    $signed_keys = explode(',', $response['openid.signed']);
+    $form_state['values']['name'] = in_array('sreg.nickname', $signed_keys) ? $response['openid.sreg.nickname'] : '';
+    $form_state['values']['mail'] = in_array('sreg.email', $signed_keys) ? $response['openid.sreg.email'] : '';
     $form_state['values']['pass']  = user_password();
     $form_state['values']['status'] = variable_get('user_register', 1) == 1;
     $form_state['values']['response'] = $response;
     $form_state['values']['auth_openid'] = $identity;
 
-    if (empty($response['openid.sreg.email']) && empty($response['openid.sreg.nickname'])) {
+    if (empty($form_state['values']['name']) && empty($form_state['values']['mail'])) {
       drupal_set_message(t('Please complete the registration by filling out the form below. If you already have an account, you can <a href="@login">log in</a> now and add your OpenID under "My account".', array('@login' => url('user/login'))), 'warning');
       $success = FALSE;
     }
@@ -497,6 +523,8 @@
 }
 
 function openid_authentication_request($claimed_id, $identity, $return_to = '', $assoc_handle = '', $version = 2) {
+  global $base_url;
+
   module_load_include('inc', 'openid');
 
   $ns = ($version == 2) ? OPENID_NS_2_0 : OPENID_NS_1_0;
@@ -510,10 +538,10 @@
   );
 
   if ($version == 2) {
-    $request['openid.realm'] = url('', array('absolute' => TRUE));
+    $request['openid.realm'] = $base_url . '/';
   }
   else {
-    $request['openid.trust_root'] = url('', array('absolute' => TRUE));
+    $request['openid.trust_root'] = $base_url . '/';
   }
 
   // Simple Registration
@@ -547,7 +575,7 @@
   // http://openid.net/specs/openid-authentication-2_0.html#rfc.section.11.4
   // Verify the signatures.
   $valid = FALSE;
-  $association = db_fetch_object(db_query("SELECT * FROM {openid_association} WHERE assoc_handle = '%s'", $response['openid.assoc_handle']));
+  $association = db_fetch_object(db_query("SELECT * FROM {openid_association} WHERE idp_endpoint_uri = '%s' AND assoc_handle = '%s'", $service['uri'], $response['openid.assoc_handle']));
   if ($association && isset($association->session_type)) {
     // http://openid.net/specs/openid-authentication-2_0.html#rfc.section.11.4.2
     // Verification using an association.
diff -Naur drupal-6.21/modules/openid/openid.pages.inc drupal-6.37/modules/openid/openid.pages.inc
--- drupal-6.21/modules/openid/openid.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/openid/openid.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/openid/xrds.inc drupal-6.37/modules/openid/xrds.inc
--- drupal-6.21/modules/openid/xrds.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/openid/xrds.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 // Global variables to track parsing state
 $xrds_open_elements = array();
@@ -16,6 +15,22 @@
   xml_set_element_handler($parser, '_xrds_element_start', '_xrds_element_end');
   xml_set_character_data_handler($parser, '_xrds_cdata');
 
+  // Since DOCTYPE declarations from an untrusted source could be malicious, we
+  // stop parsing here and treat the XML as invalid. XRDS documents do not
+  // require, and are not expected to have, a DOCTYPE.
+  if (preg_match('/<!DOCTYPE/i', $xml)) {
+    return array();
+  }
+
+  // Also stop parsing if there is an unreasonably large number of tags.
+  // substr_count() has much better performance (compared to preg_match_all())
+  // for large payloads but is less accurate, so we check for twice the desired
+  // number of allowed tags (to take into account opening/closing tags as well
+  // as false positives).
+  if (substr_count($xml, '<') > 2 * variable_get('openid_xrds_maximum_tag_count', 30000)) {
+    return array();
+  }
+
   xml_parse($parser, $xml);
   xml_parser_free($parser);
 
diff -Naur drupal-6.21/modules/path/path.admin.inc drupal-6.37/modules/path/path.admin.inc
--- drupal-6.21/modules/path/path.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/path/path.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/path/path.info drupal-6.37/modules/path/path.info
--- drupal-6.21/modules/path/path.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/path/path.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Path
 description = Allows users to rename URLs.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/path/path.module drupal-6.37/modules/path/path.module
--- drupal-6.21/modules/path/path.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/path/path.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -84,8 +83,27 @@
 
 /**
  * Set an aliased path for a given Drupal path, preventing duplicates.
+ * 
+ * @param $path
+ *   Path URL. Set to NULL to delete alias.
+ * @param $alias
+ *   Alias URL. Set to NULL to delete alias.
+ * @param $pid
+ *   Path id to update. Set to NULL to create a new alias or to delete a group of aliases.
+ * @param $language
+ *   The language this alias is valid for.
  */
 function path_set_alias($path = NULL, $alias = NULL, $pid = NULL, $language = '') {
+  /* This function claimed to prevent duplicate aliases but has not done
+   * so since the end of 2007.
+   * The uniqueness of dst+language pairs was enforced on the database level
+   * until D6.16 (march 2010); trying to insert duplicate aliass would yield a
+   * database error.
+   * From D6.16 onwards, duplicates would silently be inserted, and
+   * drupal_lookup_path() consistently uses those newer aliases.
+   * While fixing an issue in D6.23, the behavior was reverted to preventing
+   * duplicates by the below code. Watchdog errors are now logged instead.
+   */
   $path = urldecode($path);
   $alias = urldecode($alias);
   // First we check if we deal with an existing alias and delete or modify it based on pid.
@@ -97,20 +115,43 @@
     }
     else {
       // Update the existing alias.
-      db_query("UPDATE {url_alias} SET src = '%s', dst = '%s', language = '%s' WHERE pid = %d", $path, $alias, $language, $pid);
+      // Check if the alias exists already.
+      $existing = db_fetch_array(db_query("SELECT pid, src FROM {url_alias} WHERE dst = '%s' AND language = '%s' ORDER BY pid DESC", $alias, $language));
+      if (!$existing || ($existing['pid'] == $pid && $existing['src'] != $path)) {
+        db_query("UPDATE {url_alias} SET src = '%s', dst = '%s', language = '%s' WHERE pid = %d", $path, $alias, $language, $pid);
+      }
+      else {
+        if ($existing['src'] != $path) {
+          watchdog('path', "The alias for path '@path' (language '@lang') was not updated to '@alias', because the path '@expath' already has the same alias.",
+            array('@path' => $path, '@lang' => $language, '@alias' => $alias, '@expath' => $existing['src']),
+            WATCHDOG_ERROR);
+        }
+        // Don't clear cache if we didn't change anything
+        return;
+      }
     }
   }
-  else if ($path && $alias) {
-    // Check for existing aliases.
-    if ($alias == drupal_get_path_alias($path, $language)) {
-      // There is already such an alias, neutral or in this language.
-      // Update the alias based on alias; setting the language if not yet done.
-      db_query("UPDATE {url_alias} SET src = '%s', dst = '%s', language = '%s' WHERE dst = '%s'", $path, $alias, $language, $alias);
-    }
-    else {
+  elseif ($path && $alias) {
+    // Add this alias to the database, if it's new & doesn't cause conflicts.
+    $existing = db_fetch_array(db_query("SELECT src, language, pid FROM {url_alias} WHERE dst = '%s' AND language IN('%s', '') ORDER BY language DESC, pid DESC", $alias, $language));
+    if (!$existing || ($existing['language'] != $language && $existing['src'] != $path)) {
       // A new alias. Add it to the database.
       db_query("INSERT INTO {url_alias} (src, dst, language) VALUES ('%s', '%s', '%s')", $path, $alias, $language);
     }
+    elseif ($existing['language'] != $language) {
+      // This alias already exists ONLY for 'language neutral': update language.
+      // (We can only get here if $language != '')
+      db_query("UPDATE {url_alias} SET language = '%s' WHERE pid = %d", $language, $existing['pid']);
+    }
+    else {
+      if ($existing['src'] != $path) {
+        watchdog('path', "The alias '@alias' for path '@path' (language '@lang') was not created, because the path '@expath' already has the same alias.",
+          array('@path' => $path, '@lang' => $language, '@alias' => $alias, '@expath' => $existing['src']),
+          WATCHDOG_ERROR);
+      }
+      // Don't clear cache if we didn't change anything
+      return;
+    }
   }
   else {
     // Delete the alias.
@@ -131,7 +172,7 @@
  * Allows URL aliases for nodes to be specified at node edit time rather
  * than through the administrative interface.
  */
-function path_nodeapi(&$node, $op, $arg) {
+function path_nodeapi(&$node, $op, $arg = NULL) {
   // Permissions are required for everything except node loading.
   if (user_access('create url aliases') || user_access('administer url aliases') || ($op == 'load')) {
     $language = isset($node->language) ? $node->language : '';
@@ -162,6 +203,10 @@
         break;
 
       case 'update':
+        // $node->pid is usually only set when updating from a node edit form
+        // (see path_form_alter). If it is not set (e.g. on most node_save()
+        // commands), we cannot be sure whether a change in $node->path is meant
+        // to replace an existing alias or add one extra, so we do the latter.
         path_set_alias('node/'. $node->nid, isset($node->path) ? $node->path : NULL, isset($node->pid) ? $node->pid : NULL, $language);
         break;
 
diff -Naur drupal-6.21/modules/php/php.info drupal-6.37/modules/php/php.info
--- drupal-6.21/modules/php/php.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/php/php.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = PHP filter
 description = Allows embedded PHP code/snippets to be evaluated.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/php/php.install drupal-6.37/modules/php/php.install
--- drupal-6.21/modules/php/php.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/php/php.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/php/php.module drupal-6.37/modules/php/php.module
--- drupal-6.21/modules/php/php.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/php/php.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/ping/ping.info drupal-6.37/modules/ping/ping.info
--- drupal-6.21/modules/ping/ping.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/ping/ping.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Ping
 description = Alerts other sites when your site has been updated.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/ping/ping.module drupal-6.37/modules/ping/ping.module
--- drupal-6.21/modules/ping/ping.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/ping/ping.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/poll/poll-bar-block.tpl.php drupal-6.37/modules/poll/poll-bar-block.tpl.php
--- drupal-6.21/modules/poll/poll-bar-block.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll-bar-block.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file poll-bar-block.tpl.php
diff -Naur drupal-6.21/modules/poll/poll-bar.tpl.php drupal-6.37/modules/poll/poll-bar.tpl.php
--- drupal-6.21/modules/poll/poll-bar.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll-bar.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file poll-bar.tpl.php
diff -Naur drupal-6.21/modules/poll/poll-results-block.tpl.php drupal-6.37/modules/poll/poll-results-block.tpl.php
--- drupal-6.21/modules/poll/poll-results-block.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll-results-block.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 /**
  * @file poll-results-block.tpl.php
  * Display the poll results in a block.
diff -Naur drupal-6.21/modules/poll/poll-results.tpl.php drupal-6.37/modules/poll/poll-results.tpl.php
--- drupal-6.21/modules/poll/poll-results.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll-results.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file poll-results-block.tpl.php
diff -Naur drupal-6.21/modules/poll/poll-rtl.css drupal-6.37/modules/poll/poll-rtl.css
--- drupal-6.21/modules/poll/poll-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .poll .bar .foreground {
   float: right;
diff -Naur drupal-6.21/modules/poll/poll-vote.tpl.php drupal-6.37/modules/poll/poll-vote.tpl.php
--- drupal-6.21/modules/poll/poll-vote.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll-vote.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file poll-vote.tpl.php
diff -Naur drupal-6.21/modules/poll/poll.css drupal-6.37/modules/poll/poll.css
--- drupal-6.21/modules/poll/poll.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .poll .bar {
   height: 1em;
diff -Naur drupal-6.21/modules/poll/poll.info drupal-6.37/modules/poll/poll.info
--- drupal-6.21/modules/poll/poll.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/poll/poll.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Poll
 description = Allows your site to capture votes on different topics in the form of multiple choice questions.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/poll/poll.install drupal-6.37/modules/poll/poll.install
--- drupal-6.21/modules/poll/poll.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/poll/poll.module drupal-6.37/modules/poll/poll.module
--- drupal-6.21/modules/poll/poll.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -128,26 +127,24 @@
  * Generates a block containing the latest poll.
  */
 function poll_block($op = 'list', $delta = 0) {
-  if (user_access('access content')) {
-    if ($op == 'list') {
-      $blocks[0]['info'] = t('Most recent poll');
-      return $blocks;
-    }
-    else if ($op == 'view') {
-      // Retrieve the latest poll.
-      $sql = db_rewrite_sql("SELECT MAX(n.created) FROM {node} n INNER JOIN {poll} p ON p.nid = n.nid WHERE n.status = 1 AND p.active = 1");
-      $timestamp = db_result(db_query($sql));
-      if ($timestamp) {
-        $poll = node_load(array('type' => 'poll', 'created' => $timestamp, 'status' => 1));
-
-        if ($poll->nid) {
-          $poll = poll_view($poll, TRUE, FALSE, TRUE);
-        }
+  if ($op == 'list') {
+    $blocks[0]['info'] = t('Most recent poll');
+    return $blocks;
+  }
+  else if ($op == 'view' && user_access('access content')) {
+    // Retrieve the latest poll.
+    $sql = db_rewrite_sql("SELECT MAX(n.created) FROM {node} n INNER JOIN {poll} p ON p.nid = n.nid WHERE n.status = 1 AND p.active = 1");
+    $timestamp = db_result(db_query($sql));
+    if ($timestamp) {
+      $poll = node_load(array('type' => 'poll', 'created' => $timestamp, 'status' => 1));
+
+      if ($poll->nid) {
+        $poll = poll_view($poll, TRUE, FALSE, TRUE);
       }
-      $block['subject'] = t('Poll');
-      $block['content'] = drupal_render($poll->content);
-      return $block;
     }
+    $block['subject'] = t('Poll');
+    $block['content'] = drupal_render($poll->content);
+    return $block;
   }
 }
 
diff -Naur drupal-6.21/modules/poll/poll.pages.inc drupal-6.37/modules/poll/poll.pages.inc
--- drupal-6.21/modules/poll/poll.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/poll/poll.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/profile/profile-block.tpl.php drupal-6.37/modules/profile/profile-block.tpl.php
--- drupal-6.21/modules/profile/profile-block.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/profile/profile-block.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file profile-block.tpl.php
diff -Naur drupal-6.21/modules/profile/profile-listing.tpl.php drupal-6.37/modules/profile/profile-listing.tpl.php
--- drupal-6.21/modules/profile/profile-listing.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/profile/profile-listing.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file profile-listing.tpl.php
diff -Naur drupal-6.21/modules/profile/profile-wrapper.tpl.php drupal-6.37/modules/profile/profile-wrapper.tpl.php
--- drupal-6.21/modules/profile/profile-wrapper.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/profile/profile-wrapper.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file profile-wrapper.tpl.php
@@ -7,7 +6,7 @@
  * profiles.
  *
  * This template is used when viewing a list of users. It can be a general
- * list for viewing all users with the url of "example.com/profile" or when
+ * list for viewing all users with the URL of "example.com/profile" or when
  * viewing a set of users who share a specific value for a profile such
  * as "example.com/profile/country/belgium".
  *
diff -Naur drupal-6.21/modules/profile/profile.admin.inc drupal-6.37/modules/profile/profile.admin.inc
--- drupal-6.21/modules/profile/profile.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/profile/profile.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/profile/profile.css drupal-6.37/modules/profile/profile.css
--- drupal-6.21/modules/profile/profile.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/profile/profile.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #profile-fields td.category {
   font-weight: bold;
diff -Naur drupal-6.21/modules/profile/profile.info drupal-6.37/modules/profile/profile.info
--- drupal-6.21/modules/profile/profile.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/profile/profile.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Profile
 description = Supports configurable user profiles.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/profile/profile.install drupal-6.37/modules/profile/profile.install
--- drupal-6.21/modules/profile/profile.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/profile/profile.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/profile/profile.js drupal-6.37/modules/profile/profile.js
--- drupal-6.21/modules/profile/profile.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/profile/profile.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Add functionality to the profile drag and drop table.
diff -Naur drupal-6.21/modules/profile/profile.module drupal-6.37/modules/profile/profile.module
--- drupal-6.21/modules/profile/profile.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/profile/profile.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/profile/profile.pages.inc drupal-6.37/modules/profile/profile.pages.inc
--- drupal-6.21/modules/profile/profile.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/profile/profile.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/search/search-block-form.tpl.php drupal-6.37/modules/search/search-block-form.tpl.php
--- drupal-6.21/modules/search/search-block-form.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search-block-form.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file search-block-form.tpl.php
diff -Naur drupal-6.21/modules/search/search-result.tpl.php drupal-6.37/modules/search/search-result.tpl.php
--- drupal-6.21/modules/search/search-result.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search-result.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file search-result.tpl.php
diff -Naur drupal-6.21/modules/search/search-results.tpl.php drupal-6.37/modules/search/search-results.tpl.php
--- drupal-6.21/modules/search/search-results.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search-results.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file search-results.tpl.php
diff -Naur drupal-6.21/modules/search/search-rtl.css drupal-6.37/modules/search/search-rtl.css
--- drupal-6.21/modules/search/search-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .search-advanced .criterion {
   float: right;
diff -Naur drupal-6.21/modules/search/search-theme-form.tpl.php drupal-6.37/modules/search/search-theme-form.tpl.php
--- drupal-6.21/modules/search/search-theme-form.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search-theme-form.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file search-theme-form.tpl.php
diff -Naur drupal-6.21/modules/search/search.admin.inc drupal-6.37/modules/search/search.admin.inc
--- drupal-6.21/modules/search/search.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/search/search.css drupal-6.37/modules/search/search.css
--- drupal-6.21/modules/search/search.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .search-form {
   margin-bottom: 1em;
diff -Naur drupal-6.21/modules/search/search.info drupal-6.37/modules/search/search.info
--- drupal-6.21/modules/search/search.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/search/search.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Search
 description = Enables site-wide keyword searching.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/search/search.install drupal-6.37/modules/search/search.install
--- drupal-6.21/modules/search/search.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/search/search.module drupal-6.37/modules/search/search.module
--- drupal-6.21/modules/search/search.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -44,7 +43,7 @@
 '\x{2ce5}-\x{2cff}\x{2d6f}\x{2e00}-\x{3005}\x{3007}-\x{303b}\x{303d}-\x{303f}'.
 '\x{3099}-\x{309e}\x{30a0}\x{30fb}\x{30fd}\x{30fe}\x{3190}-\x{319f}\x{31c0}-'.
 '\x{31cf}\x{3200}-\x{33ff}\x{4dc0}-\x{4dff}\x{a015}\x{a490}-\x{a716}\x{a802}'.
-'\x{a806}\x{a80b}\x{a823}-\x{a82b}\x{d800}-\x{f8ff}\x{fb1e}\x{fb29}\x{fd3e}'.
+'\x{a806}\x{a80b}\x{a823}-\x{a82b}\x{e000}-\x{f8ff}\x{fb1e}\x{fb29}\x{fd3e}'.
 '\x{fd3f}\x{fdfc}-\x{fe6b}\x{feff}-\x{ff0f}\x{ff1a}-\x{ff20}\x{ff3b}-\x{ff40}'.
 '\x{ff5b}-\x{ff65}\x{ff70}\x{ff9e}\x{ff9f}\x{ffe0}-\x{fffd}');
 
@@ -1037,7 +1036,7 @@
     '#attributes' => array('class' => 'search-form'),
   );
   $form['module'] = array('#type' => 'value', '#value' => $type);
-  $form['basic'] = array('#type' => 'item', '#title' => $prompt);
+  $form['basic'] = array('#type' => 'item', '#title' => $prompt, '#id' => 'edit-keys');
   $form['basic']['inline'] = array('#prefix' => '<div class="container-inline">', '#suffix' => '</div>');
   $form['basic']['inline']['keys'] = array(
     '#type' => 'textfield',
@@ -1059,7 +1058,7 @@
  *
  * @ingroup forms
  * @see search_box_form_submit()
- * @see theme_search_box_form()
+ * @see search-block-form.tpl.php
  */
 function search_box(&$form_state, $form_id) {
   $form[$form_id] = array(
diff -Naur drupal-6.21/modules/search/search.pages.inc drupal-6.37/modules/search/search.pages.inc
--- drupal-6.21/modules/search/search.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/search/search.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/statistics/statistics.admin.inc drupal-6.37/modules/statistics/statistics.admin.inc
--- drupal-6.21/modules/statistics/statistics.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/statistics/statistics.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/statistics/statistics.info drupal-6.37/modules/statistics/statistics.info
--- drupal-6.21/modules/statistics/statistics.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/statistics/statistics.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Statistics
 description = Logs access statistics for your site.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/statistics/statistics.install drupal-6.37/modules/statistics/statistics.install
--- drupal-6.21/modules/statistics/statistics.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/statistics/statistics.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
@@ -119,7 +118,7 @@
 }
 
 /**
- * @defgroup updates-6.x-extra Extra statistics updates for 6.x
+ * @addtogroup updates-6.x-extra
  * @{
  */
 
@@ -133,6 +132,6 @@
 }
 
 /**
- * @} End of "defgroup updates-6.x-extra"
+ * @} End of "addtogroup updates-6.x-extra".
  * The next series of updates should start at 7000.
  */
diff -Naur drupal-6.21/modules/statistics/statistics.module drupal-6.37/modules/statistics/statistics.module
--- drupal-6.21/modules/statistics/statistics.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/statistics/statistics.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/statistics/statistics.pages.inc drupal-6.37/modules/statistics/statistics.pages.inc
--- drupal-6.21/modules/statistics/statistics.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/statistics/statistics.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/syslog/syslog.info drupal-6.37/modules/syslog/syslog.info
--- drupal-6.21/modules/syslog/syslog.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/syslog/syslog.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Syslog
 description = Logs and records system events to syslog.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/syslog/syslog.install drupal-6.37/modules/syslog/syslog.install
--- drupal-6.21/modules/syslog/syslog.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/syslog/syslog.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/syslog/syslog.module drupal-6.37/modules/syslog/syslog.module
--- drupal-6.21/modules/syslog/syslog.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/syslog/syslog.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/system/admin-rtl.css drupal-6.37/modules/system/admin-rtl.css
--- drupal-6.21/modules/system/admin-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/admin-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 div.admin-panel .body {
   padding: 0 8px 2px 4px;
diff -Naur drupal-6.21/modules/system/admin.css drupal-6.37/modules/system/admin.css
--- drupal-6.21/modules/system/admin.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/admin.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /*
 ** Formatting for administration page
diff -Naur drupal-6.21/modules/system/block.tpl.php drupal-6.37/modules/system/block.tpl.php
--- drupal-6.21/modules/system/block.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/block.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file block.tpl.php
diff -Naur drupal-6.21/modules/system/box.tpl.php drupal-6.37/modules/system/box.tpl.php
--- drupal-6.21/modules/system/box.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/box.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file box.tpl.php
diff -Naur drupal-6.21/modules/system/defaults-rtl.css drupal-6.37/modules/system/defaults-rtl.css
--- drupal-6.21/modules/system/defaults-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/defaults-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 th {
   text-align: right;
diff -Naur drupal-6.21/modules/system/defaults.css drupal-6.37/modules/system/defaults.css
--- drupal-6.21/modules/system/defaults.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/defaults.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /*
 ** HTML elements
diff -Naur drupal-6.21/modules/system/maintenance-page.tpl.php drupal-6.37/modules/system/maintenance-page.tpl.php
--- drupal-6.21/modules/system/maintenance-page.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/maintenance-page.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file maintenance-page.tpl.php
diff -Naur drupal-6.21/modules/system/maintenance.css drupal-6.37/modules/system/maintenance.css
--- drupal-6.21/modules/system/maintenance.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/maintenance.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /* Update styles */
 #update-results {
diff -Naur drupal-6.21/modules/system/page.tpl.php drupal-6.37/modules/system/page.tpl.php
--- drupal-6.21/modules/system/page.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/page.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/system/system-menus-rtl.css drupal-6.37/modules/system/system-menus-rtl.css
--- drupal-6.21/modules/system/system-menus-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/system-menus-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 ul.menu {
   text-align:right;
diff -Naur drupal-6.21/modules/system/system-menus.css drupal-6.37/modules/system/system-menus.css
--- drupal-6.21/modules/system/system-menus.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/system-menus.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 ul.menu {
   list-style: none;
diff -Naur drupal-6.21/modules/system/system-rtl.css drupal-6.37/modules/system/system-rtl.css
--- drupal-6.21/modules/system/system-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/system-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 thead th {
   text-align: right;
diff -Naur drupal-6.21/modules/system/system.admin.inc drupal-6.37/modules/system/system.admin.inc
--- drupal-6.21/modules/system/system.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/system.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -62,6 +61,7 @@
 
 /**
  * Provide a single block from the administration menu as a page.
+ *
  * This function is often a destination for these blocks.
  * For example, 'admin/content/types' needs to have a destination to be valid
  * in the Drupal menu system, but too much information there might be
@@ -128,7 +128,7 @@
 }
 
 /**
- * Menu callback; displays a module's settings page.
+ * Menu callback: Displays the configuration overview page.
  */
 function system_settings_overview() {
   // Check database setup if necessary
diff -Naur drupal-6.21/modules/system/system.css drupal-6.37/modules/system/system.css
--- drupal-6.21/modules/system/system.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/system.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /*
 ** HTML elements
diff -Naur drupal-6.21/modules/system/system.info drupal-6.37/modules/system/system.info
--- drupal-6.21/modules/system/system.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/system/system.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = System
 description = Handles general site configuration for administrators.
 package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/system/system.install drupal-6.37/modules/system/system.install
--- drupal-6.21/modules/system/system.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/system.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,13 +1,7 @@
 <?php
-// $Id$
 
 /**
- * Test and report Drupal installation requirements.
- *
- * @param $phase
- *   The current system installation phase.
- * @return
- *   An array of system requirements.
+ * Implementation of hook_requirements().
  */
 function system_requirements($phase) {
   $requirements = array();
@@ -123,6 +117,35 @@
     $requirements['settings.php']['title'] = $t('Configuration file');
   }
 
+  // Test the contents of the .htaccess files.
+  if ($phase == 'runtime') {
+    // Try to write the .htaccess files first, to prevent false alarms in case
+    // (for example) the /tmp directory was wiped.
+    file_create_htaccess(file_directory_path());
+    file_create_htaccess(file_directory_temp());
+    $htaccess_files['files_htaccess'] = array(
+      'title' => $t('Files directory'),
+      'directory' => file_directory_path(),
+    );
+    $htaccess_files['temporary_files_htaccess'] = array(
+      'title' => $t('Temporary files directory'),
+      'directory' => file_directory_temp(),
+    );
+    foreach ($htaccess_files as $key => $file_info) {
+      // Check for the string which was added to the recommended .htaccess file
+      // in the latest security update.
+      $htaccess_file = $file_info['directory'] . '/.htaccess';
+      if (!file_exists($htaccess_file) || !($contents = @file_get_contents($htaccess_file)) || strpos($contents, 'Drupal_Security_Do_Not_Remove_See_SA_2013_003') === FALSE) {
+        $requirements[$key] = array(
+          'title' => $file_info['title'],
+          'value' => $t('Not fully protected'),
+          'severity' => REQUIREMENT_ERROR,
+          'description' => $t('See <a href="@url">@url</a> for information about the recommended .htaccess file which should be added to the %directory directory to help protect against arbitrary code execution.', array('@url' => 'http://drupal.org/SA-CORE-2013-003', '%directory' => $file_info['directory'])),
+        );
+      }
+    }
+  }
+
   // Report cron status.
   if ($phase == 'runtime') {
     // Cron warning threshold defaults to two days.
@@ -1175,7 +1198,7 @@
 }
 
 /**
- * @} End of "defgroup updates-5.x-extra"
+ * @} End of "defgroup updates-5.x-extra".
  */
 
 /**
@@ -2577,7 +2600,7 @@
 }
 
 /**
- * @} End of "defgroup updates-5.x-to-6.x"
+ * @} End of "defgroup updates-5.x-to-6.x".
  */
 
 /**
@@ -2714,7 +2737,7 @@
 }
 
 /**
- * @} End of "defgroup updates-6.x-extra"
+ * @} End of "defgroup updates-6.x-extra".
  * The next series of updates should start at 7000.
  */
 
diff -Naur drupal-6.21/modules/system/system.js drupal-6.37/modules/system/system.js
--- drupal-6.21/modules/system/system.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/system.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Internal function to check using Ajax if clean URLs can be enabled on the
diff -Naur drupal-6.21/modules/system/system.module drupal-6.37/modules/system/system.module
--- drupal-6.21/modules/system/system.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/system/system.module	2015-08-19 23:15:49.000000000 +0200
@@ -8,7 +8,7 @@
 /**
  * The current system version.
  */
-define('VERSION', '6.21');
+define('VERSION', '6.37');
 
 /**
  * Core API compatibility.
@@ -169,7 +169,7 @@
   $type['submit'] = array('#input' => TRUE, '#name' => 'op', '#button_type' => 'submit', '#executes_submit_callback' => TRUE, '#process' => array('form_expand_ahah'));
   $type['button'] = array('#input' => TRUE, '#name' => 'op', '#button_type' => 'submit', '#executes_submit_callback' => FALSE, '#process' => array('form_expand_ahah'));
   $type['image_button'] = array('#input' => TRUE, '#button_type' => 'submit', '#executes_submit_callback' => TRUE, '#process' => array('form_expand_ahah'), '#return_value' => TRUE, '#has_garbage_value' => TRUE, '#src' => NULL);
-  $type['textfield'] = array('#input' => TRUE, '#size' => 60, '#maxlength' => 128, '#autocomplete_path' => FALSE, '#process' => array('form_expand_ahah'));
+  $type['textfield'] = array('#input' => TRUE, '#size' => 60, '#maxlength' => 128, '#autocomplete_path' => FALSE, '#process' => array('form_process_autocomplete', 'form_expand_ahah'));
   $type['password'] = array('#input' => TRUE, '#size' => 60, '#maxlength' => 128, '#process' => array('form_expand_ahah'));
   $type['password_confirm'] = array('#input' => TRUE, '#process' => array('expand_password_confirm'));
   $type['textarea'] = array('#input' => TRUE, '#cols' => 60, '#rows' => 5, '#resizable' => TRUE, '#process' => array('form_expand_ahah'));
@@ -805,22 +805,52 @@
  *   Array of all available themes and their data.
  */
 function system_theme_data() {
+  $write_database = TRUE;
+  // If lock not acquired, return $files data without writing to database.
+  if (!lock_acquire('system_theme_data')) {
+    $write_database = FALSE;
+    // Wait for the parallel thread to be done so we are more likely
+    // to get updated and consistent data.
+    lock_wait('system_theme_data');
+  }
   // Scan the installation theme .info files and their engines.
   $themes = _system_theme_data();
+  foreach ($themes as $key => $theme) {
+    if (!isset($theme->owner)) {
+      $themes[$key]->owner = '';
+    }
+  }
 
   // Extract current files from database.
   system_get_files_database($themes, 'theme');
 
-  db_query("DELETE FROM {system} WHERE type = 'theme'");
+  // If lock not acquired, return $themes data without writing to database.
+  if ($write_database) {
+    $filenames = array();
 
-  foreach ($themes as $theme) {
-    if (!isset($theme->owner)) {
-      $theme->owner = '';
+    foreach ($themes as $theme) {
+      // Record the filename of each theme that was found.
+      $filenames[] = $theme->filename;
+      // Existing themes will always have $theme->status set, since it's a
+      // property that is only stored in the database.
+      if (isset($theme->status)) {
+        db_query("UPDATE {system} SET owner = '%s', info = '%s', filename = '%s' WHERE name = '%s' AND type = '%s'", $theme->owner, serialize($theme->info), $theme->filename, $theme->name, 'theme');
+      }
+      // New themes must get a $theme->status before they are inserted into the
+      // database. For the default theme, we force it to be enabled (to handle
+      // the initial installation of Drupal), but otherwise new themes should
+      // always start off as disabled.
+      else {
+        $theme->status = ($theme->name == variable_get('theme_default', 'garland'));
+        db_query("INSERT INTO {system} (name, owner, info, type, filename, status, throttle, bootstrap) VALUES ('%s', '%s', '%s', '%s', '%s', %d, %d, %d)", $theme->name, $theme->owner, serialize($theme->info), 'theme', $theme->filename, $theme->status, 0, 0);
+      }
     }
-
-    db_query("INSERT INTO {system} (name, owner, info, type, filename, status, throttle, bootstrap) VALUES ('%s', '%s', '%s', '%s', '%s', %d, %d, %d)", $theme->name, $theme->owner, serialize($theme->info), 'theme', $theme->filename, isset($theme->status) ? $theme->status : 0, 0, 0);
+    // Delete from the system table any themes missing from the file system.
+    if ($filenames) {
+      db_query("DELETE FROM {system} WHERE type = 'theme' AND filename NOT IN (". db_placeholders($filenames, 'varchar') .")", $filenames);
+    }
+    lock_release('system_theme_data');
   }
-
   return $themes;
 }
 
@@ -919,7 +949,13 @@
     $themes_info = $themes;
   }
 
-  return $themes_info;
+  // To avoid side effects, we don't return the original objects.
+  $themes_info_cloned = array();
+  foreach ($themes_info as $key => $theme) {
+    $themes_info_cloned[$key] = drupal_clone($theme);
+  }
+
+  return $themes_info_cloned;
 }
 
 /**
@@ -1172,8 +1208,6 @@
  *   - A string containing a Drupal path.
  *   - An associative array with a 'path' key. Additional array values are
  *     passed as the $options parameter to l().
- *   If the 'destination' query parameter is set in the URL when viewing a
- *   confirmation form, that value will be used instead of $path.
  * @param $description
  *   Additional text to display. Defaults to t('This action cannot be undone.').
  * @param $yes
@@ -1660,7 +1694,7 @@
     '#default_value' => $context['message'],
     '#cols' => '80',
     '#rows' => '20',
-    '#description' => t('The message that should be sent. You may include the following variables: %site_name, %username, %node_url, %node_type, %title, %teaser, %body. Not all variables will be available in all contexts.'),
+    '#description' => t('The message that should be sent. You may include the following variables: %site_name, %username, %node_url, %node_type, %title, %teaser, %body, %term_name, %term_description, %term_id, %vocabulary_name, %vocabulary_description, %vocabulary_id. Not all variables will be available in all contexts.'),
   );
   return $form;
 }
@@ -1923,8 +1957,8 @@
 function system_check_http_request() {
   // Try to get the content of the front page via drupal_http_request().
   $result = drupal_http_request(url('', array('absolute' => TRUE)), array(), 'GET', NULL, 0);
-  // We only care that we get a http response - this means that Drupal
-  // can make a http request.
+  // We only care that we get a HTTP response - this means that Drupal
+  // can make a HTTP request.
   $works = isset($result->code) && ($result->code >= 100) && ($result->code < 600);
   variable_set('drupal_http_request_fails', !$works);
   return $works;
diff -Naur drupal-6.21/modules/taxonomy/taxonomy.admin.inc drupal-6.37/modules/taxonomy/taxonomy.admin.inc
--- drupal-6.21/modules/taxonomy/taxonomy.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/taxonomy/taxonomy.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/taxonomy/taxonomy.css drupal-6.37/modules/taxonomy/taxonomy.css
--- drupal-6.21/modules/taxonomy/taxonomy.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/taxonomy/taxonomy.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 tr.taxonomy-term-preview {
   background-color: #EEE;
diff -Naur drupal-6.21/modules/taxonomy/taxonomy.info drupal-6.37/modules/taxonomy/taxonomy.info
--- drupal-6.21/modules/taxonomy/taxonomy.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/taxonomy/taxonomy.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Taxonomy
 description = Enables the categorization of content.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/taxonomy/taxonomy.install drupal-6.37/modules/taxonomy/taxonomy.install
--- drupal-6.21/modules/taxonomy/taxonomy.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/taxonomy/taxonomy.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_schema().
diff -Naur drupal-6.21/modules/taxonomy/taxonomy.js drupal-6.37/modules/taxonomy/taxonomy.js
--- drupal-6.21/modules/taxonomy/taxonomy.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/taxonomy/taxonomy.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Move a block in the blocks table from one region to another via select list.
diff -Naur drupal-6.21/modules/taxonomy/taxonomy.module drupal-6.37/modules/taxonomy/taxonomy.module
--- drupal-6.21/modules/taxonomy/taxonomy.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/taxonomy/taxonomy.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -254,18 +253,22 @@
 
 /**
  * Dynamically check and update the hierarachy flag of a vocabulary.
+ * Checks and updates the hierarchy flag of a vocabulary.
  *
  * Checks the current parents of all terms in a vocabulary and updates the
- * vocabularies hierarchy setting to the lowest possible level. A hierarchy with
- * no parents in any of its terms will be given a hierarchy of 0. If terms
- * contain at most a single parent, the vocabulary will be given a hierarchy of
- * 1. If any term contain multiple parents, the vocabulary will be given a
- * hieararchy of 2.
+ * vocabulary's hierarchy setting to the lowest possible level. If no term
+ * has parent terms then the vocabulary will be given a hierarchy of 0.
+ * If any term has a single parent then the vocabulary will be given a
+ * hierarchy of 1. If any term has multiple parents then the vocabulary
+ * will be given a hierarchy of 2.
  *
  * @param $vocabulary
  *   An array of the vocabulary structure.
  * @param $changed_term
  *   An array of the term structure that was updated.
+ *
+ * @return
+ *   An integer that represents the level of the vocabulary's hierarchy.
  */
 function taxonomy_check_vocabulary_hierarchy($vocabulary, $changed_term) {
   $tree = taxonomy_get_tree($vocabulary['vid']);
@@ -626,11 +629,15 @@
 /**
  * Find all terms associated with the given node, ordered by vocabulary and term weight.
  */
-function taxonomy_node_get_terms($node, $key = 'tid') {
+function taxonomy_node_get_terms($node, $key = 'tid', $reset = FALSE) {
   static $terms;
 
+  if ($reset) {
+    unset($terms[$node->vid]);
+  }
+
   if (!isset($terms[$node->vid][$key])) {
-    $result = db_query(db_rewrite_sql('SELECT t.* FROM {term_node} r INNER JOIN {term_data} t ON r.tid = t.tid INNER JOIN {vocabulary} v ON t.vid = v.vid WHERE r.vid = %d ORDER BY v.weight, t.weight, t.name', 't', 'tid'), $node->vid);
+    $result = db_query(db_rewrite_sql('SELECT t.*,v.weight AS v_weight_unused FROM {term_node} r INNER JOIN {term_data} t ON r.tid = t.tid INNER JOIN {vocabulary} v ON t.vid = v.vid WHERE r.vid = %d ORDER BY v.weight, t.weight, t.name', 't', 'tid'), $node->vid);
     $terms[$node->vid][$key] = array();
     while ($term = db_fetch_object($result)) {
       $terms[$node->vid][$key][$term->$key] = $term;
@@ -661,7 +668,7 @@
 /**
  * Save term associations for a given node.
  */
-function taxonomy_node_save($node, $terms) {
+function taxonomy_node_save(&$node, $terms) {
 
   taxonomy_node_delete_revision($node);
 
@@ -718,6 +725,9 @@
       }
     }
   }
+
+  // Flush the term "cache" for this node
+  $node->taxonomy = taxonomy_node_get_terms($node, 'tid', TRUE);
 }
 
 /**
@@ -824,7 +834,8 @@
  *   for the entire vocabulary.
  *
  * @param $depth
- *   Internal use only.
+ *   Internal use only. Now deprecated and isn't used. It is left here only
+ *   because of @link http://drupal.org/node/556842 compatibility issues. @endlink
  *
  * @param $max_depth
  *   The number of levels of the tree to return. Leave NULL to return all levels.
@@ -837,12 +848,12 @@
 function taxonomy_get_tree($vid, $parent = 0, $depth = -1, $max_depth = NULL) {
   static $children, $parents, $terms;
 
-  $depth++;
-
   // We cache trees, so it's not CPU-intensive to call get_tree() on a term
   // and its children, too.
   if (!isset($children[$vid])) {
     $children[$vid] = array();
+    $parents[$vid] = array();
+    $terms[$vid] = array();
 
     $result = db_query(db_rewrite_sql('SELECT t.tid, t.*, parent FROM {term_data} t INNER JOIN {term_hierarchy} h ON t.tid = h.tid WHERE t.vid = %d ORDER BY weight, name', 't', 'tid'), $vid);
     while ($term = db_fetch_object($result)) {
@@ -852,18 +863,58 @@
     }
   }
 
-  $max_depth = (is_null($max_depth)) ? count($children[$vid]) : $max_depth;
+  $max_depth = (!isset($max_depth)) ? count($children[$vid]) : $max_depth;
   $tree = array();
-  if ($max_depth > $depth && !empty($children[$vid][$parent])) {
-    foreach ($children[$vid][$parent] as $child) {
-      $term = drupal_clone($terms[$vid][$child]);
-      $term->depth = $depth;
-      // The "parent" attribute is not useful, as it would show one parent only.
-      unset($term->parent);
-      $term->parents = $parents[$vid][$child];
-      $tree[] = $term;
-      if (!empty($children[$vid][$child])) {
-        $tree = array_merge($tree, taxonomy_get_tree($vid, $child, $depth, $max_depth));
+
+  // Keeps track of the parents we have to process, the last entry is used
+  // for the next processing step.
+  $process_parents = array();
+  $process_parents[] = $parent;
+
+  // Loops over the parent terms and adds its children to the tree array.
+  // Uses a loop instead of a recursion, because it's more efficient.
+  while (count($process_parents)) {
+    $parent = array_pop($process_parents);
+    // The number of parents determines the current depth.
+    $depth = count($process_parents);
+    if ($max_depth > $depth && !empty($children[$vid][$parent])) {
+      $has_children = FALSE;
+      $child = current($children[$vid][$parent]);
+      do {
+        if (empty($child)) {
+          break;
+        }
+        $term = $terms[$vid][$child];
+        if (count($parents[$vid][$term->tid]) > 1) {
+          // We have a term with multi parents here. Clone the term,
+          // so that the depth attribute remains correct.
+          $term = clone $term;
+        }
+        $term->depth = $depth;
+        unset($term->parent);
+        $term->parents = $parents[$vid][$term->tid];
+        $tree[] = $term;
+        if (!empty($children[$vid][$term->tid])) {
+          $has_children = TRUE;
+
+          // We have to continue with this parent later.
+          $process_parents[] = $parent;
+          // Use the current term as parent for the next iteration.
+          $process_parents[] = $term->tid;
+
+          // Reset pointers for child lists because we step in there more often
+          // with multi parents.
+          reset($children[$vid][$term->tid]);
+          // Move pointer so that we get the correct term the next time.
+          next($children[$vid][$parent]);
+          break;
+        }
+      } while ($child = next($children[$vid][$parent]));
+
+      if (!$has_children) {
+        // We processed all terms in this hierarchy-level, reset pointer
+        // so that this function works the next time it gets called.
+        reset($children[$vid][$parent]);
       }
     }
   }
@@ -1196,7 +1247,7 @@
 /**
  * Implementation of hook_nodeapi().
  */
-function taxonomy_nodeapi($node, $op, $arg = 0) {
+function taxonomy_nodeapi(&$node, $op, $arg = 0) {
   switch ($op) {
     case 'load':
       $output['taxonomy'] = taxonomy_node_get_terms($node);
diff -Naur drupal-6.21/modules/taxonomy/taxonomy.pages.inc drupal-6.37/modules/taxonomy/taxonomy.pages.inc
--- drupal-6.21/modules/taxonomy/taxonomy.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/taxonomy/taxonomy.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/throttle/throttle.admin.inc drupal-6.37/modules/throttle/throttle.admin.inc
--- drupal-6.21/modules/throttle/throttle.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/throttle/throttle.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/throttle/throttle.info drupal-6.37/modules/throttle/throttle.info
--- drupal-6.21/modules/throttle/throttle.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/throttle/throttle.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Throttle
 description = Handles the auto-throttling mechanism, to control site congestion.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/throttle/throttle.module drupal-6.37/modules/throttle/throttle.module
--- drupal-6.21/modules/throttle/throttle.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/throttle/throttle.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/tracker/tracker.css drupal-6.37/modules/tracker/tracker.css
--- drupal-6.21/modules/tracker/tracker.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/tracker/tracker.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #tracker td.replies {
   text-align: center;
diff -Naur drupal-6.21/modules/tracker/tracker.info drupal-6.37/modules/tracker/tracker.info
--- drupal-6.21/modules/tracker/tracker.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/tracker/tracker.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,4 +1,3 @@
-; $Id$
 name = Tracker
 description = Enables tracking of recent posts for users.
 dependencies[] = comment
@@ -6,8 +5,8 @@
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/tracker/tracker.module drupal-6.37/modules/tracker/tracker.module
--- drupal-6.21/modules/tracker/tracker.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/tracker/tracker.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/tracker/tracker.pages.inc drupal-6.37/modules/tracker/tracker.pages.inc
--- drupal-6.21/modules/tracker/tracker.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/tracker/tracker.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/translation/translation.info drupal-6.37/modules/translation/translation.info
--- drupal-6.21/modules/translation/translation.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/translation/translation.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,4 +1,3 @@
-; $Id$
 name = Content translation
 description = Allows content to be translated into different languages.
 dependencies[] = locale
@@ -6,8 +5,8 @@
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/translation/translation.module drupal-6.37/modules/translation/translation.module
--- drupal-6.21/modules/translation/translation.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/translation/translation.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -181,7 +180,7 @@
  *
  * Manages translation information for nodes.
  */
-function translation_nodeapi(&$node, $op, $teaser, $page) {
+function translation_nodeapi(&$node, $op, $teaser = NULL, $page = NULL) {
   // Only act if we are dealing with a content type supporting translations.
   if (!translation_supported_type($node->type)) {
     return;
diff -Naur drupal-6.21/modules/translation/translation.pages.inc drupal-6.37/modules/translation/translation.pages.inc
--- drupal-6.21/modules/translation/translation.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/translation/translation.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/trigger/trigger.admin.inc drupal-6.37/modules/trigger/trigger.admin.inc
--- drupal-6.21/modules/trigger/trigger.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/trigger/trigger.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/trigger/trigger.info drupal-6.37/modules/trigger/trigger.info
--- drupal-6.21/modules/trigger/trigger.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/trigger/trigger.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Trigger
 description = Enables actions to be fired on certain system events, such as when new content is created.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/trigger/trigger.install drupal-6.37/modules/trigger/trigger.install
--- drupal-6.21/modules/trigger/trigger.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/trigger/trigger.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/trigger/trigger.module drupal-6.37/modules/trigger/trigger.module
--- drupal-6.21/modules/trigger/trigger.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/trigger/trigger.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -211,7 +210,7 @@
 /**
  * Implementation of hook_nodeapi().
  */
-function trigger_nodeapi(&$node, $op, $a3, $a4) {
+function trigger_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
   // Keep objects for reuse so that changes actions make to objects can persist.
   static $objects;
   // Prevent recursion by tracking which operations have already been called.
diff -Naur drupal-6.21/modules/update/update-rtl.css drupal-6.37/modules/update/update-rtl.css
--- drupal-6.21/modules/update/update-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/update/update-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .update .project {
   padding-right: .25em;
diff -Naur drupal-6.21/modules/update/update.compare.inc drupal-6.37/modules/update/update.compare.inc
--- drupal-6.21/modules/update/update.compare.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/update/update.compare.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/update/update.css drupal-6.37/modules/update/update.css
--- drupal-6.21/modules/update/update.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/update/update.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 .update .project {
   font-weight: bold;
diff -Naur drupal-6.21/modules/update/update.fetch.inc drupal-6.37/modules/update/update.fetch.inc
--- drupal-6.21/modules/update/update.fetch.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/update/update.fetch.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -222,6 +221,11 @@
         $this->current_term = array();
         $this->current_object = &$this->current_term;
         break;
+      case 'FILE':
+        unset($this->current_object);
+        $this->current_file = array();
+        $this->current_object = &$this->current_file;
+        break;
     }
   }
 
@@ -253,6 +257,13 @@
       case 'TERMS':
         $this->current_object = &$this->current_release;
         break;
+      case 'FILE':
+        unset($this->current_object);
+        $this->current_release['files'][] = $this->current_file;
+        break;
+      case 'FILES':
+        $this->current_object = &$this->current_release;
+        break;
       default:
         $this->current_object[strtolower($this->current_tag)] = trim($this->current_object[strtolower($this->current_tag)]);
         $this->current_tag = '';
@@ -260,7 +271,7 @@
   }
 
   function data($parser, $data) {
-    if ($this->current_tag && !in_array($this->current_tag, array('PROJECT', 'RELEASE', 'RELEASES', 'TERM', 'TERMS'))) {
+    if ($this->current_tag && !in_array($this->current_tag, array('PROJECT', 'RELEASE', 'RELEASES', 'TERM', 'TERMS', 'FILE', 'FILES'))) {
       $tag = strtolower($this->current_tag);
       if (isset($this->current_object[$tag])) {
         $this->current_object[$tag] .= $data;
diff -Naur drupal-6.21/modules/update/update.info drupal-6.37/modules/update/update.info
--- drupal-6.21/modules/update/update.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/update/update.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Update status
 description = Checks the status of available updates for Drupal and your installed modules and themes.
 version = VERSION
 package = Core - optional
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/update/update.install drupal-6.37/modules/update/update.install
--- drupal-6.21/modules/update/update.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/update/update.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/update/update.module drupal-6.37/modules/update/update.module
--- drupal-6.21/modules/update/update.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/update/update.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/update/update.report.inc drupal-6.37/modules/update/update.report.inc
--- drupal-6.21/modules/update/update.report.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/update/update.report.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/update/update.settings.inc drupal-6.37/modules/update/update.settings.inc
--- drupal-6.21/modules/update/update.settings.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/update/update.settings.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/modules/upload/upload.admin.inc drupal-6.37/modules/upload/upload.admin.inc
--- drupal-6.21/modules/upload/upload.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/upload/upload.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Form API callback to validate the upload settings form.
diff -Naur drupal-6.21/modules/upload/upload.info drupal-6.37/modules/upload/upload.info
--- drupal-6.21/modules/upload/upload.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/upload/upload.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Upload
 description = Allows users to upload and attach files to content.
 package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/upload/upload.install drupal-6.37/modules/upload/upload.install
--- drupal-6.21/modules/upload/upload.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/upload/upload.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_install().
diff -Naur drupal-6.21/modules/upload/upload.module drupal-6.37/modules/upload/upload.module
--- drupal-6.21/modules/upload/upload.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/upload/upload.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -273,7 +272,7 @@
 /**
  * Implementation of hook_nodeapi().
  */
-function upload_nodeapi(&$node, $op, $teaser) {
+function upload_nodeapi(&$node, $op, $teaser = NULL) {
   switch ($op) {
 
     case 'load':
@@ -315,10 +314,10 @@
       break;
 
     case 'search result':
-      return isset($node->files) && is_array($node->files) ? format_plural(count($node->files), '1 attachment', '@count attachments') : NULL;
+      return isset($node->files) && is_array($node->files) && user_access('view uploaded files') ? format_plural(count($node->files), '1 attachment', '@count attachments') : NULL;
 
     case 'rss item':
-      if (is_array($node->files)) {
+      if (is_array($node->files) && user_access('view uploaded files')) {
         $files = array();
         foreach ($node->files as $file) {
           if ($file->list) {
@@ -625,7 +624,12 @@
     '#tree' => FALSE,
     '#parents' => array(),
   );
-  drupal_alter('form', $form, array(), 'upload_js');
+
+  $empty_form_state = array();
+  $data = &$form;
+  $data['__drupal_alter_by_ref'] = array(&$empty_form_state);
+  drupal_alter('form', $data, 'upload_js');
+
   $form_state = array('submitted' => FALSE);
   $form = form_builder('upload_js', $form, $form_state);
   $output = theme('status_messages') . drupal_render($form);
diff -Naur drupal-6.21/modules/user/user-picture.tpl.php drupal-6.37/modules/user/user-picture.tpl.php
--- drupal-6.21/modules/user/user-picture.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user-picture.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file user-picture.tpl.php
diff -Naur drupal-6.21/modules/user/user-profile-category.tpl.php drupal-6.37/modules/user/user-profile-category.tpl.php
--- drupal-6.21/modules/user/user-profile-category.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user-profile-category.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file user-profile-category.tpl.php
diff -Naur drupal-6.21/modules/user/user-profile-item.tpl.php drupal-6.37/modules/user/user-profile-item.tpl.php
--- drupal-6.21/modules/user/user-profile-item.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user-profile-item.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file user-profile-item.tpl.php
diff -Naur drupal-6.21/modules/user/user-profile.tpl.php drupal-6.37/modules/user/user-profile.tpl.php
--- drupal-6.21/modules/user/user-profile.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user-profile.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file user-profile.tpl.php
diff -Naur drupal-6.21/modules/user/user-rtl.css drupal-6.37/modules/user/user-rtl.css
--- drupal-6.21/modules/user/user-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #permissions td.permission {
   padding-left: 0;
diff -Naur drupal-6.21/modules/user/user.admin.inc drupal-6.37/modules/user/user.admin.inc
--- drupal-6.21/modules/user/user.admin.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user.admin.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,11 +1,25 @@
 <?php
-// $Id$
 
 /**
  * @file
  * Admin page callback file for the user module.
  */
 
+/**
+ * Page callback: Generates the appropriate user administration form.
+ *
+ * This function generates the user registration, multiple user cancellation,
+ * or filtered user list admin form, depending on the argument and the POST
+ * form values.
+ *
+ * @param string $callback_arg
+ *   (optional) Indicates which form to build. Defaults to '', which will
+ *   trigger the user filter form. If the POST value 'op' is present, this
+ *   function uses that value as the callback argument.
+ *
+ * @return string
+ *   A renderable form array for the respective request.
+ */
 function user_admin($callback_arg = '') {
   $op = isset($_POST['op']) ? $_POST['op'] : $callback_arg;
 
diff -Naur drupal-6.21/modules/user/user.css drupal-6.37/modules/user/user.css
--- drupal-6.21/modules/user/user.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 #permissions td.module {
   font-weight: bold;
diff -Naur drupal-6.21/modules/user/user.info drupal-6.37/modules/user/user.info
--- drupal-6.21/modules/user/user.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/modules/user/user.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = User
 description = Manages the user registration and login system.
 package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/modules/user/user.install drupal-6.37/modules/user/user.install
--- drupal-6.21/modules/user/user.install	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user.install	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Implementation of hook_schema().
diff -Naur drupal-6.21/modules/user/user.js drupal-6.37/modules/user/user.js
--- drupal-6.21/modules/user/user.js	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user.js	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 /**
  * Attach handlers to evaluate the strength of any password fields and to check
diff -Naur drupal-6.21/modules/user/user.module drupal-6.37/modules/user/user.module
--- drupal-6.21/modules/user/user.module	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user.module	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -14,12 +13,23 @@
  *
  * We cannot use module_invoke() for this, because the arguments need to
  * be passed by reference.
+ *
+ * @param $op
+ *   The operation to be passed as the first parameter of the hook function.
+ * @param $edit
+ *   An associative array variable containing form values to be passed
+ *   as the second parameter of the hook function.
+ * @param $account
+ *   The user account object to be passed as the third parameter of the hook
+ *   function.
+ * @param $category
+ *   The category of user information being acted upon.
  */
-function user_module_invoke($type, &$array, &$user, $category = NULL) {
+function user_module_invoke($op, &$edit, &$account, $category = NULL) {
   foreach (module_list() as $module) {
     $function = $module .'_user';
     if (function_exists($function)) {
-      $function($type, $array, $user, $category);
+      $function($op, $edit, $account, $category);
     }
   }
 }
@@ -195,14 +205,17 @@
  * Save changes to a user account or add a new user.
  *
  * @param $account
- *   The $user object for the user to modify or add. If $user->uid is
- *   omitted, a new user will be added.
- *
+ *   The user object for to modify or add. If you want to modify an existing
+ *   user account, you will need to ensure that (a) $account is an object, and
+ *   (b) you have set $account->uid to the numeric user ID of the user account
+ *   you wish to modify. Pass in NULL or any non-object to add a new user.
  * @param $array
  *   (optional) An array of fields and values to save. For example,
- *   array('name' => 'My name'); Setting a field to NULL deletes it from
- *   the data column.
- *
+ *   array('name' => 'My name'); Keys that do not belong to columns
+ *   in the user-related tables are added to the a serialized array
+ *   in the 'data' column and will be loaded in the $user->data array by
+ *   user_load(). Setting a field to NULL deletes it from the data column,
+ *   if you are modifying an existing user account.
  * @param $category
  *   (optional) The category for storing profile information in.
  *
@@ -464,12 +477,15 @@
 
   // Loop the number of times specified by $length.
   for ($i = 0; $i < $length; $i++) {
+    do {
+      // Find a secure random number within the range needed.
+      $index = ord(drupal_random_bytes(1));
+    } while ($index > $len);
 
     // Each iteration, pick a random character from the
     // allowable string and append it to the password:
-    $pass .= $allowable_characters[mt_rand(0, $len)];
+    $pass .= $allowable_characters[$index];
   }
-
   return $pass;
 }
 
@@ -527,7 +543,12 @@
 /**
  * Checks for usernames blocked by user administration.
  *
- * @return boolean TRUE for blocked users, FALSE for active.
+ * @param $name
+ *   A string containing a name of the user.
+ *
+ * @return
+ *   Object with property 'name' (the user name), if the user is blocked;
+ *   FALSE if the user is not blocked.
  */
 function user_is_blocked($name) {
   $deny = db_fetch_object(db_query("SELECT name FROM {users} WHERE status = 0 AND name = LOWER('%s')", $name));
@@ -586,14 +607,17 @@
         // Replace wildcards with MySQL/PostgreSQL wildcards.
         $keys = preg_replace('!\*+!', '%', $keys);
         if (user_access('administer users')) {
-          // Administrators can also search in the otherwise private email field.
+          // Administrators can also search in the otherwise private email
+          // field, and they don't need to be restricted to only active users.
           $result = pager_query("SELECT name, uid, mail FROM {users} WHERE LOWER(name) LIKE LOWER('%%%s%%') OR LOWER(mail) LIKE LOWER('%%%s%%')", 15, 0, NULL, $keys, $keys);
           while ($account = db_fetch_object($result)) {
             $find[] = array('title' => $account->name .' ('. $account->mail .')', 'link' => url('user/'. $account->uid, array('absolute' => TRUE)));
           }
         }
         else {
-          $result = pager_query("SELECT name, uid FROM {users} WHERE LOWER(name) LIKE LOWER('%%%s%%')", 15, 0, NULL, $keys);
+          // Regular users can only search via user names, and we do not show
+          // them blocked accounts.
+          $result = pager_query("SELECT name, uid FROM {users} WHERE status = 1 AND LOWER(name) LIKE LOWER('%%%s%%')", 15, 0, NULL, $keys);
           while ($account = db_fetch_object($result)) {
             $find[] = array('title' => $account->name, 'link' => url('user/'. $account->uid, array('absolute' => TRUE)));
           }
@@ -774,17 +798,7 @@
           // Perform database queries to gather online user lists.  We use s.timestamp
           // rather than u.access because it is much faster.
           $anonymous_count = sess_count($interval);
-          $authenticated_users = db_query('SELECT DISTINCT u.uid, u.name, s.timestamp FROM {users} u INNER JOIN {sessions} s ON u.uid = s.uid WHERE s.timestamp >= %d AND s.uid > 0 ORDER BY s.timestamp DESC', $interval);
-          $authenticated_count = 0;
-          $max_users = variable_get('user_block_max_list_count', 10);
-          $items = array();
-          while ($account = db_fetch_object($authenticated_users)) {
-            if ($max_users > 0) {
-              $items[] = $account;
-              $max_users--;
-            }
-            $authenticated_count++;
-          }
+          $authenticated_count = db_result(db_query('SELECT COUNT(DISTINCT s.uid) FROM {sessions} s WHERE s.timestamp >= %d AND s.uid > 0', $interval));
 
           // Format the output with proper grammar.
           if ($anonymous_count == 1 && $authenticated_count == 1) {
@@ -797,6 +811,10 @@
           // Display a list of currently online users.
           $max_users = variable_get('user_block_max_list_count', 10);
           if ($authenticated_count && $max_users) {
+            $authenticated_users = db_query_range('SELECT u.uid, u.name, MAX(s.timestamp) AS timestamp FROM {users} u INNER JOIN {sessions} s ON u.uid = s.uid WHERE s.timestamp >= %d AND s.uid > 0 GROUP BY u.uid, u.name ORDER BY s.timestamp DESC', $interval, 0, $max_users);
+            while ($account = db_fetch_object($authenticated_users)) {
+              $items[] = $account;
+            }
             $output .= theme('user_list', $items, t('Online users'));
           }
 
@@ -1083,8 +1101,8 @@
     'title' => 'Delete',
     'page callback' => 'drupal_get_form',
     'page arguments' => array('user_confirm_delete', 1),
-    'access callback' => 'user_access',
-    'access arguments' => array('administer users'),
+    'access callback' => 'user_delete_access',
+    'access arguments' => array(1),
     'type' => MENU_CALLBACK,
     'file' => 'user.pages.inc',
   );
@@ -1466,11 +1484,33 @@
  */
 function user_pass_reset_url($account) {
   $timestamp = time();
-  return url("user/reset/$account->uid/$timestamp/". user_pass_rehash($account->pass, $timestamp, $account->login), array('absolute' => TRUE));
+  return url("user/reset/$account->uid/$timestamp/". user_pass_rehash($account->pass, $timestamp, $account->login, $account->uid), array('absolute' => TRUE));
 }
 
-function user_pass_rehash($password, $timestamp, $login) {
-  return md5($timestamp . $password . $login);
+function user_pass_rehash($password, $timestamp, $login, $uid) {
+  // Backwards compatibility: Try to determine a $uid if one was not passed.
+  // (Since $uid is a required parameter to this function, a PHP warning will
+  // be generated if it's not provided, which is an indication that the calling
+  // code should be updated. But the code below will try to generate a correct
+  // hash in the meantime.)
+  if (!isset($uid)) {
+    $uids = array();
+    $result = db_query_range("SELECT uid FROM {users} WHERE pass = '%s' AND login = '%s' AND uid > 0", $password, $login, 0, 2);
+    while ($row = db_fetch_array($result)) {
+      $uids[] = $row['uid'];
+    }
+    // If exactly one user account matches the provided password and login
+    // timestamp, proceed with that $uid.
+    if (count($uids) == 1) {
+      $uid = reset($uids);
+    }
+    // Otherwise there is no safe hash to return, so return a random string
+    // that will never be treated as a valid token.
+    else {
+      return drupal_random_key();
+    }
+  }
+  return drupal_hmac_base64($timestamp . $login . $uid, drupal_get_private_key() . $password);
 }
 
 function user_edit_form(&$form_state, $uid, $edit, $register = FALSE) {
@@ -2117,7 +2157,7 @@
  *
  * @param $account
  *  The user object of the account being notified.  Must contain at
- *  least the fields 'uid', 'name', and 'mail'.
+ *  least the fields 'uid', 'name', 'pass', 'login', and 'mail'.
  * @param $language
  *  Language object to generate the tokens with.
  * @return
@@ -2173,22 +2213,25 @@
  * @see drupal_mail()
  *
  * @param $op
- *  The operation being performed on the account.  Possible values:
- *  'register_admin_created': Welcome message for user created by the admin
- *  'register_no_approval_required': Welcome message when user self-registers
- *  'register_pending_approval': Welcome message, user pending admin approval
- *  'password_reset': Password recovery request
- *  'status_activated': Account activated
- *  'status_blocked': Account blocked
- *  'status_deleted': Account deleted
+ *   The operation being performed on the account. Possible values:
+ *   - 'register_admin_created': Welcome message for user created by the admin.
+ *   - 'register_no_approval_required': Welcome message when user
+ *     self-registers.
+ *   - 'register_pending_approval': Welcome message, user pending admin
+ *     approval.
+ *   - 'password_reset': Password recovery request.
+ *   - 'status_activated': Account activated.
+ *   - 'status_blocked': Account blocked.
+ *   - 'status_deleted': Account deleted.
  *
  * @param $account
- *  The user object of the account being notified.  Must contain at
- *  least the fields 'uid', 'name', and 'mail'.
+ *   The user object of the account being notified. Must contain at
+ *   least the fields 'uid', 'name', and 'mail'.
  * @param $language
- *  Optional language to use for the notification, overriding account language.
+ *   Optional language to use for the notification, overriding account language.
+ *
  * @return
- *  The return value from drupal_mail_send(), if ends up being called.
+ *   The return value from drupal_mail_send(), if ends up being called.
  */
 function _user_mail_notify($op, $account, $language = NULL) {
   // By default, we always notify except for deleted and blocked.
@@ -2510,7 +2553,8 @@
 }
 
 function user_register_validate($form, &$form_state) {
-  user_module_invoke('validate', $form_state['values'], $form_state['values'], 'account');
+  $account = (object) $form_state['values'];
+  user_module_invoke('validate', $form_state['values'], $account, 'account');
 }
 
 /**
@@ -2544,3 +2588,13 @@
   $destination = drupal_get_destination();
   return $destination == 'destination=user%2Flogin' ? 'destination=user' : $destination;
 }
+
+/**
+ * Menu access callback; limit access to account deletion pages.
+ *
+ * Limit access to administrative users, and prevent the anonymous user account
+ * from being deleted.
+ */
+function user_delete_access($account) {
+  return user_access('administer users') && $account->uid > 0;
+}
diff -Naur drupal-6.21/modules/user/user.pages.inc drupal-6.37/modules/user/user.pages.inc
--- drupal-6.21/modules/user/user.pages.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/modules/user/user.pages.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -107,7 +106,7 @@
         drupal_set_message(t('You have tried to use a one-time login link that has expired. Please request a new one using the form below.'));
         drupal_goto('user/password');
       }
-      else if ($account->uid && $timestamp > $account->login && $timestamp < $current && $hashed_pass == user_pass_rehash($account->pass, $timestamp, $account->login)) {
+      else if ($account->uid && $timestamp > $account->login && $timestamp < $current && $hashed_pass == user_pass_rehash($account->pass, $timestamp, $account->login, $account->uid)) {
         // First stage is a confirmation form, then login
         if ($action == 'login') {
           watchdog('user', 'User %name used one-time login link at time %timestamp.', array('%name' => $account->name, '%timestamp' => $timestamp));
diff -Naur drupal-6.21/profiles/default/default.profile drupal-6.37/profiles/default/default.profile
--- drupal-6.21/profiles/default/default.profile	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/profiles/default/default.profile	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Return an array of the modules to be enabled when this profile is installed.
diff -Naur drupal-6.21/robots.txt drupal-6.37/robots.txt
--- drupal-6.21/robots.txt	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/robots.txt	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-# $Id$
 #
 # robots.txt
 #
@@ -41,7 +40,7 @@
 # Paths (clean URLs)
 Disallow: /admin/
 Disallow: /comment/reply/
-Disallow: /contact/
+Disallow: /filter/tips/
 Disallow: /logout/
 Disallow: /node/add/
 Disallow: /search/
@@ -51,7 +50,7 @@
 # Paths (no clean URLs)
 Disallow: /?q=admin/
 Disallow: /?q=comment/reply/
-Disallow: /?q=contact/
+Disallow: /?q=filter/tips/
 Disallow: /?q=logout/
 Disallow: /?q=node/add/
 Disallow: /?q=search/
diff -Naur drupal-6.21/scripts/code-clean.sh drupal-6.37/scripts/code-clean.sh
--- drupal-6.21/scripts/code-clean.sh	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/scripts/code-clean.sh	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 #!/bin/sh
-# $Id$
 
 find . -name "*~" -type f | xargs rm -f
 find . -name ".#*" -type f | xargs rm -f
diff -Naur drupal-6.21/scripts/code-style.pl drupal-6.37/scripts/code-style.pl
--- drupal-6.21/scripts/code-style.pl	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/scripts/code-style.pl	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 #!/usr/bin/perl -w
-# $Id$
 
 use Pod::Usage;
 use Getopt::Long qw(GetOptions);
diff -Naur drupal-6.21/scripts/cron-curl.sh drupal-6.37/scripts/cron-curl.sh
--- drupal-6.21/scripts/cron-curl.sh	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/scripts/cron-curl.sh	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
 #!/bin/sh
-# $Id$
 
 curl --silent --compressed http://example.com/cron.php
diff -Naur drupal-6.21/scripts/cron-lynx.sh drupal-6.37/scripts/cron-lynx.sh
--- drupal-6.21/scripts/cron-lynx.sh	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/scripts/cron-lynx.sh	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
 #!/bin/sh
-# $Id$
 
 /usr/bin/lynx -source http://example.com/cron.php > /dev/null 2>&1
diff -Naur drupal-6.21/scripts/drupal.sh drupal-6.37/scripts/drupal.sh
--- drupal-6.21/scripts/drupal.sh	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/scripts/drupal.sh	2015-08-19 23:15:49.000000000 +0200
@@ -1,6 +1,5 @@
 #!/usr/bin/php
 <?php
-// $Id$
 
 /**
  * Drupal shell execution script
@@ -113,7 +112,7 @@
           $_REQUEST = $_GET;
         }
 
-        // set file to execute or Drupal path (clean urls enabled)
+        // set file to execute or Drupal path (clean URLs enabled)
         if (isset($path['path']) && file_exists(substr($path['path'], 1))) {
           $_SERVER['PHP_SELF'] = $_SERVER['REQUEST_URI'] = $path['path'];
           $cmd = substr($path['path'], 1);
diff -Naur drupal-6.21/sites/all/README.txt drupal-6.37/sites/all/README.txt
--- drupal-6.21/sites/all/README.txt	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/sites/all/README.txt	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-// $Id$
 
 This directory should be used to place downloaded and custom modules
 and themes which are common to all sites. This will allow you to
diff -Naur drupal-6.21/sites/default/default.settings.php drupal-6.37/sites/default/default.settings.php
--- drupal-6.21/sites/default/default.settings.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/sites/default/default.settings.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/themes/bluemarine/block.tpl.php drupal-6.37/themes/bluemarine/block.tpl.php
--- drupal-6.21/themes/bluemarine/block.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/bluemarine/block.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
   <div class="block block-<?php print $block->module; ?>" id="block-<?php print $block->module; ?>-<?php print $block->delta; ?>">
     <h2 class="title"><?php print $block->subject; ?></h2>
diff -Naur drupal-6.21/themes/bluemarine/bluemarine.info drupal-6.37/themes/bluemarine/bluemarine.info
--- drupal-6.21/themes/bluemarine/bluemarine.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/themes/bluemarine/bluemarine.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Bluemarine
 description = Table-based multi-column theme with a marine and ash color scheme.
 version = VERSION
 core = 6.x
 engine = phptemplate
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/themes/bluemarine/box.tpl.php drupal-6.37/themes/bluemarine/box.tpl.php
--- drupal-6.21/themes/bluemarine/box.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/bluemarine/box.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
   <div class="box">
     <?php if ($title) { ?><h2 class="title"><?php print $title; ?></h2><?php } ?>
diff -Naur drupal-6.21/themes/bluemarine/comment.tpl.php drupal-6.37/themes/bluemarine/comment.tpl.php
--- drupal-6.21/themes/bluemarine/comment.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/bluemarine/comment.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
   <div class="comment<?php print ' '. $status; ?>">
     <?php if ($picture) {
diff -Naur drupal-6.21/themes/bluemarine/node.tpl.php drupal-6.37/themes/bluemarine/node.tpl.php
--- drupal-6.21/themes/bluemarine/node.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/bluemarine/node.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
   <div class="node<?php if ($sticky) { print " sticky"; } ?><?php if (!$status) { print " node-unpublished"; } ?>">
     <?php if ($picture) {
diff -Naur drupal-6.21/themes/bluemarine/page.tpl.php drupal-6.37/themes/bluemarine/page.tpl.php
--- drupal-6.21/themes/bluemarine/page.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/bluemarine/page.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml" lang="<?php print $language->language ?>" xml:lang="<?php print $language->language ?>" dir="<?php print $language->dir ?>">
 
diff -Naur drupal-6.21/themes/bluemarine/style-rtl.css drupal-6.37/themes/bluemarine/style-rtl.css
--- drupal-6.21/themes/bluemarine/style-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/bluemarine/style-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 body {
   direction: rtl;
 }
diff -Naur drupal-6.21/themes/bluemarine/style.css drupal-6.37/themes/bluemarine/style.css
--- drupal-6.21/themes/bluemarine/style.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/bluemarine/style.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /*
 ** HTML elements
diff -Naur drupal-6.21/themes/chameleon/chameleon.info drupal-6.37/themes/chameleon/chameleon.info
--- drupal-6.21/themes/chameleon/chameleon.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/themes/chameleon/chameleon.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,4 +1,3 @@
-; $Id$
 name = Chameleon
 description = Minimalist tabled theme with light colors.
 regions[left] = Left sidebar
@@ -12,8 +11,8 @@
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/themes/chameleon/chameleon.theme drupal-6.37/themes/chameleon/chameleon.theme
--- drupal-6.21/themes/chameleon/chameleon.theme	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/chameleon/chameleon.theme	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/themes/chameleon/common-rtl.css drupal-6.37/themes/chameleon/common-rtl.css
--- drupal-6.21/themes/chameleon/common-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/chameleon/common-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 body {
   direction: rtl;
diff -Naur drupal-6.21/themes/chameleon/common.css drupal-6.37/themes/chameleon/common.css
--- drupal-6.21/themes/chameleon/common.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/chameleon/common.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /*
 ** HTML elements
diff -Naur drupal-6.21/themes/chameleon/marvin/marvin.info drupal-6.37/themes/chameleon/marvin/marvin.info
--- drupal-6.21/themes/chameleon/marvin/marvin.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/themes/chameleon/marvin/marvin.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,4 +1,3 @@
-; $Id$
 name = Marvin
 description = Boxy tabled theme in all grays.
 regions[left] = Left sidebar
@@ -7,8 +6,8 @@
 core = 6.x
 base theme = chameleon
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/themes/chameleon/marvin/style-rtl.css drupal-6.37/themes/chameleon/marvin/style-rtl.css
--- drupal-6.21/themes/chameleon/marvin/style-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/chameleon/marvin/style-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 body {
   background-image: url(druplicon-watermark-rtl.png);
diff -Naur drupal-6.21/themes/chameleon/marvin/style.css drupal-6.37/themes/chameleon/marvin/style.css
--- drupal-6.21/themes/chameleon/marvin/style.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/chameleon/marvin/style.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /*
 ** HTML elements
diff -Naur drupal-6.21/themes/chameleon/style-rtl.css drupal-6.37/themes/chameleon/style-rtl.css
--- drupal-6.21/themes/chameleon/style-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/chameleon/style-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 body {
   padding: 5em 3em 0 0;
diff -Naur drupal-6.21/themes/chameleon/style.css drupal-6.37/themes/chameleon/style.css
--- drupal-6.21/themes/chameleon/style.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/chameleon/style.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /*
 ** HTML elements
diff -Naur drupal-6.21/themes/engines/phptemplate/phptemplate.engine drupal-6.37/themes/engines/phptemplate/phptemplate.engine
--- drupal-6.21/themes/engines/phptemplate/phptemplate.engine	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/engines/phptemplate/phptemplate.engine	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
diff -Naur drupal-6.21/themes/garland/block.tpl.php drupal-6.37/themes/garland/block.tpl.php
--- drupal-6.21/themes/garland/block.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/block.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
 <div id="block-<?php print $block->module .'-'. $block->delta; ?>" class="clear-block block block-<?php print $block->module ?>">
 
diff -Naur drupal-6.21/themes/garland/color/color.inc drupal-6.37/themes/garland/color/color.inc
--- drupal-6.21/themes/garland/color/color.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/color/color.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 $info = array(
 
diff -Naur drupal-6.21/themes/garland/color/preview.css drupal-6.37/themes/garland/color/preview.css
--- drupal-6.21/themes/garland/color/preview.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/color/preview.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /* Positioning */
 #preview {
diff -Naur drupal-6.21/themes/garland/comment.tpl.php drupal-6.37/themes/garland/comment.tpl.php
--- drupal-6.21/themes/garland/comment.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/comment.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
 <div class="comment<?php print ($comment->new) ? ' comment-new' : ''; print ' '. $status; print ' '. $zebra; ?>">
 
diff -Naur drupal-6.21/themes/garland/fix-ie-rtl.css drupal-6.37/themes/garland/fix-ie-rtl.css
--- drupal-6.21/themes/garland/fix-ie-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/fix-ie-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 body {
   /* Center layout */
diff -Naur drupal-6.21/themes/garland/fix-ie.css drupal-6.37/themes/garland/fix-ie.css
--- drupal-6.21/themes/garland/fix-ie.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/fix-ie.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /**
  * Garland, for Drupal 6.x
diff -Naur drupal-6.21/themes/garland/garland.info drupal-6.37/themes/garland/garland.info
--- drupal-6.21/themes/garland/garland.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/themes/garland/garland.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,4 +1,3 @@
-; $Id$
 name = Garland
 description = Tableless, recolorable, multi-column, fluid width theme (default).
 version = VERSION
@@ -7,8 +6,8 @@
 stylesheets[all][] = style.css
 stylesheets[print][] = print.css
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/themes/garland/maintenance-page.tpl.php drupal-6.37/themes/garland/maintenance-page.tpl.php
--- drupal-6.21/themes/garland/maintenance-page.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/maintenance-page.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file maintenance-page.tpl.php
diff -Naur drupal-6.21/themes/garland/minnelli/color/color.inc drupal-6.37/themes/garland/minnelli/color/color.inc
--- drupal-6.21/themes/garland/minnelli/color/color.inc	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/minnelli/color/color.inc	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 $info = array(
 
diff -Naur drupal-6.21/themes/garland/minnelli/minnelli.css drupal-6.37/themes/garland/minnelli/minnelli.css
--- drupal-6.21/themes/garland/minnelli/minnelli.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/minnelli/minnelli.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /**
  * Minnelli, for Drupal 6.x
diff -Naur drupal-6.21/themes/garland/minnelli/minnelli.info drupal-6.37/themes/garland/minnelli/minnelli.info
--- drupal-6.21/themes/garland/minnelli/minnelli.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/themes/garland/minnelli/minnelli.info	2015-08-19 23:35:59.000000000 +0200
@@ -1,4 +1,3 @@
-; $Id$
 name = Minnelli
 description = Tableless, recolorable, multi-column, fixed width theme.
 version = VERSION
@@ -6,8 +5,8 @@
 base theme = garland
 stylesheets[all][] = minnelli.css
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/themes/garland/node.tpl.php drupal-6.37/themes/garland/node.tpl.php
--- drupal-6.21/themes/garland/node.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/node.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
 <div id="node-<?php print $node->nid; ?>" class="node<?php if ($sticky) { print ' sticky'; } ?><?php if (!$status) { print ' node-unpublished'; } ?>">
 
diff -Naur drupal-6.21/themes/garland/page.tpl.php drupal-6.37/themes/garland/page.tpl.php
--- drupal-6.21/themes/garland/page.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/page.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="<?php print $language->language ?>" lang="<?php print $language->language ?>" dir="<?php print $language->dir ?>">
diff -Naur drupal-6.21/themes/garland/print.css drupal-6.37/themes/garland/print.css
--- drupal-6.21/themes/garland/print.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/print.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /**
  * Garland, for Drupal 5.0
diff -Naur drupal-6.21/themes/garland/style-rtl.css drupal-6.37/themes/garland/style-rtl.css
--- drupal-6.21/themes/garland/style-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/style-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 html {
   direction: rtl;
diff -Naur drupal-6.21/themes/garland/style.css drupal-6.37/themes/garland/style.css
--- drupal-6.21/themes/garland/style.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/style.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /**
  * Garland, for Drupal 6.x
@@ -223,7 +222,7 @@
 }
 
 tr.drag {
-  background-color: #fffff0;
+  background-color: #ffb;
 }
 
 tr.drag-previous {
diff -Naur drupal-6.21/themes/garland/template.php drupal-6.37/themes/garland/template.php
--- drupal-6.21/themes/garland/template.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/garland/template.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * Sets the body-tag class attribute.
diff -Naur drupal-6.21/themes/pushbutton/block.tpl.php drupal-6.37/themes/pushbutton/block.tpl.php
--- drupal-6.21/themes/pushbutton/block.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/pushbutton/block.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
 <div class="<?php print "block block-$block->module" ?>" id="<?php print "block-$block->module-$block->delta"; ?>">
   <div class="title"><h3><?php print $block->subject ?></h3></div>
diff -Naur drupal-6.21/themes/pushbutton/box.tpl.php drupal-6.37/themes/pushbutton/box.tpl.php
--- drupal-6.21/themes/pushbutton/box.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/pushbutton/box.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
 <div class="box">
   <?php if ($title): ?>
diff -Naur drupal-6.21/themes/pushbutton/comment.tpl.php drupal-6.37/themes/pushbutton/comment.tpl.php
--- drupal-6.21/themes/pushbutton/comment.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/pushbutton/comment.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
 <div class="comment<?php print ' '. $status; ?>">
   <?php if ($picture) : ?>
diff -Naur drupal-6.21/themes/pushbutton/node.tpl.php drupal-6.37/themes/pushbutton/node.tpl.php
--- drupal-6.21/themes/pushbutton/node.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/pushbutton/node.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?>
 <div class="node<?php if ($sticky) { print " sticky"; } ?><?php if (!$status) { print " node-unpublished"; } ?>">
   <?php print $picture ?>
diff -Naur drupal-6.21/themes/pushbutton/page.tpl.php drupal-6.37/themes/pushbutton/page.tpl.php
--- drupal-6.21/themes/pushbutton/page.tpl.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/pushbutton/page.tpl.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml" lang="<?php print $language->language ?>" xml:lang="<?php print $language->language ?>" dir="<?php print $language->dir ?>">
 <head>
diff -Naur drupal-6.21/themes/pushbutton/pushbutton.info drupal-6.37/themes/pushbutton/pushbutton.info
--- drupal-6.21/themes/pushbutton/pushbutton.info	2011-05-25 22:21:57.000000000 +0200
+++ drupal-6.37/themes/pushbutton/pushbutton.info	2015-08-19 23:36:00.000000000 +0200
@@ -1,12 +1,11 @@
-; $Id$
 name = Pushbutton
 description = Tabled, multi-column theme in blue and orange tones.
 version = VERSION
 core = 6.x
 engine = phptemplate
 
-; Information added by drupal.org packaging script on 2011-05-25
-version = "6.21"
+; Information added by Drupal.org packaging script on 2015-08-19
+version = "6.37"
 project = "drupal"
-datestamp = "1306354917"
+datestamp = "1440020160"
 
diff -Naur drupal-6.21/themes/pushbutton/style-rtl.css drupal-6.37/themes/pushbutton/style-rtl.css
--- drupal-6.21/themes/pushbutton/style-rtl.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/pushbutton/style-rtl.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 body {
   direction: rtl;
diff -Naur drupal-6.21/themes/pushbutton/style.css drupal-6.37/themes/pushbutton/style.css
--- drupal-6.21/themes/pushbutton/style.css	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/themes/pushbutton/style.css	2015-08-19 23:15:49.000000000 +0200
@@ -1,4 +1,3 @@
-/* $Id$ */
 
 /*
 ** HTML elements
diff -Naur drupal-6.21/update.php drupal-6.37/update.php
--- drupal-6.21/update.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/update.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
@@ -184,6 +183,9 @@
   $context['message'] = 'Updating '. check_plain($module) .' module';
 }
 
+/**
+ * Renders a form with a list of available database updates.
+ */
 function update_selection_page() {
   $output = '<p>The version of Drupal you are updating from has been automatically detected. You can select a different version, but you should not need to.</p>';
   $output .= '<p>Click Update to start the update process.</p>';
@@ -346,8 +348,8 @@
           if (!count($queries)) {
             $output .= '<li class="none">No queries</li>';
           }
+          $output .= '</ul>';
         }
-        $output .= '</ul>';
       }
     }
     $output .= '</div>';
@@ -369,7 +371,7 @@
   update_task_list('info');
   drupal_set_title('Drupal database update');
   $token = drupal_get_token('update');
-  $output = '<p>Use this utility to update your database whenever a new release of Drupal or a module is installed.</p><p>For more detailed information, see the <a href="http://drupal.org/node/258">Installation and upgrading handbook</a>. If you are unsure what these terms mean you should probably contact your hosting provider.</p>';
+  $output = '<p>Use this utility to update your database whenever a new release of Drupal or a module is installed.</p><p>For more detailed information, see the <a href="http://drupal.org/upgrade">upgrading handbook</a>. If you are unsure what these terms mean you should probably contact your hosting provider.</p>';
   $output .= "<ol>\n";
   $output .= "<li><strong>Back up your database</strong>. This process will change your database values and in case of emergency you may need to revert to a backup.</li>\n";
   $output .= "<li><strong>Back up your code</strong>. Hint: when backing up module code, do not leave that backup in the 'modules' or 'sites/*/modules' directories as this may confuse Drupal's auto-discovery mechanism.</li>\n";
@@ -653,13 +655,13 @@
   $op = isset($_REQUEST['op']) ? $_REQUEST['op'] : '';
   switch ($op) {
     case 'selection':
-      if (isset($_GET['token']) && $_GET['token'] == drupal_get_token('update')) {
+      if (isset($_GET['token']) && drupal_valid_token($_GET['token'], 'update')) {
         $output = update_selection_page();
         break;
       }
 
     case 'Update':
-      if (isset($_GET['token']) && $_GET['token'] == drupal_get_token('update')) {
+      if (isset($_GET['token']) && drupal_valid_token($_GET['token'], 'update')) {
         update_batch();
         break;
       }
diff -Naur drupal-6.21/xmlrpc.php drupal-6.37/xmlrpc.php
--- drupal-6.21/xmlrpc.php	2011-05-25 22:02:48.000000000 +0200
+++ drupal-6.37/xmlrpc.php	2015-08-19 23:15:49.000000000 +0200
@@ -1,5 +1,4 @@
 <?php
-// $Id$
 
 /**
  * @file
